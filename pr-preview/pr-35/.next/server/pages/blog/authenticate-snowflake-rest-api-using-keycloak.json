{"pageProps":{"post":{"content":"\n\n# Authenticate Snowflake rest api via Keycloak\n\nHere in Vandebron  we use Keycloak as our identity and access management (IAM) solution and Snowflake as our data warehousing platform. \nKeycloak is a powerful and extensible solution for managing user identities and access control, making it a popular choice for organizations seeking a comprehensive and open-source IAM platform.\nSnowflake is designed to handle and analyze large volumes of data with speed and efficiency. It is known for its scalability, flexibility, and ease of use in managing and analyzing diverse and massive datasets.\n\n## Accessing Snowflake data via Rest API\n\nThere are several ways to access data in Snowflake one of these are the Snowflake rest api, they are a comprehensive set of REST APIs for managing and interacting with various aspects of the Snowflake Data Cloud, including account management, data loading, querying, and more.\nThese REST APIs allow developers to programmatically perform tasks such as executing SQL queries, managing virtual warehouses, and administering user roles. They are designed to enable automation and integration with other applications and services.\n\n## Why Via Rest Api?\n\nThe Snowflake SQL API is a REST API that you can use to access and update data in a Snowflake database. You can use this API to develop custom applications and integrations that can perform most of the queries you need. More info here: https://docs.snowflake.com/en/developer-guide/sql-api/index\n\nWe decided to connect our microservices to snowflake via rest api mainly because we consider this mechanism the best way to decouple database processing with backend processing in fact the queries issued via the endpoint are processed inside Snowflake ecosystem asynchronously.\n\nThe service can poll snowflake to monitor the request until it is completed. See https://docs.snowflake.com/en/developer-guide/sql-api/handling-responses .\n\nUsing api communication has other very good benefits:\n\n\n\n- No additional library dependency\n\n- No Additional spark connectors\n\n- Since there is no way to run snowflake on a local machine unit test a snowflake connection would have been very hard ( impossible ). With Rest api communication we can unit test snowflake api client using contract test. ( one way contract test is better than nothing )\n\n\n\n## Snowflake Authentication\n\nSnowflake provides a convenient way to authenticate to it using “any” OAuth authentication server. Our authentication server is Keycloak so in the following sections you will learn how to integrate Keycloak with Snowflake.\n\nResources to this topic can be found here https://docs.snowflake.com/en/user-guide/oauth-ext-overview  and here: https://docs.snowflake.com/en/user-guide/oauth-ext-custom\n\n\n\n## Keycloak side\n\nYou need to configure your client to return in the JWT access token the following claims:\n\n\n```\n{\n\"aud\": \"<audience_url>\",\n\"iat\": 1576705500,\n\"exp\": 1576709100,\n\"iss\": \"<issuer_url>\",\n\"scope\": [\n\"session:role-any\"\n]\n}\n```\n\nmost of them are returned by default. Aud claims is the only one you should add\n\nTo add `aud` claim you can add a new mapper to your client with type Audience see image:\n\n![Keycloak aud](/images/keycloak_aud.png \"Keycloak aud mapper\")\n\n**Note**: You need to add a custom audience with the value **equal** to the login_name attribute value in snowflake. The audience value will be used to look up to the right user in snowflake integration\n\nThen you need to add the snowflake scope to your scope list: session:role-any\n\nFinally you can check that your token is correct:\n\n```\n{\n.....\n\"iss\": \"https://test.vdbinfra.nl/auth/realms/vandebron\",\n\"scope\": \"session:role-any\",\n\"aud\": \"energy-trading-test\",\n....\n}\n```\n\n\nThe `aud` must contain only the snowflake login_name. For instance, a token such as the following will not work (multiple audiences):\"aud\": [     \"batterypack-services-test\",     \"account\"   ],\n\n\n## Snowflake side\n\nHow to find keycloak public key: https://stackoverflow.com/a/57457227\n\nRequired: `ACCOUNTADMIN` rights in Snowflake.\n\nExample integration command:\n\n```\ncreate or replace security integration external_oauth_keycloak_test\ntype = external_oauth\nenabled = true\nexternal_oauth_type = custom\nexternal_oauth_issuer = 'https://test.vdbinfra.nl/auth/realms/vandebron'\nexternal_oauth_rsa_public_key = '<public_key>'\nexternal_oauth_audience_list = ('energy-trading-test')\nexternal_oauth_scope_mapping_attribute = 'scope'\nexternal_oauth_token_user_mapping_claim = 'aud'\nexternal_oauth_any_role_mode = 'ENABLE'\nexternal_oauth_scope_delimiter = ' '\nexternal_oauth_snowflake_user_mapping_attribute = 'login_name';\n```\n\nNote: the external_oauth_scope_delimiter setting must be enabled separately by Snowflake support.\nNext, you need to set the login name for the user you want associate with the integration:\n\n![Snowflake auth configuration](/images/keycloak_aud.png \"Snowflake auth configuration\")\n\n### Example\n\nLet’s authenticate with keycloak as we do normally:\n\n```\ncurl --location --request POST 'https://keycloak.test-backend.vdbinfra.nl/auth/realms/vandebron/protocol/openid-connect/token/' \\\n--header 'Content-Type: application/x-www-form-urlencoded' \\\n--data-urlencode 'grant_type=client_credentials' \\\n--data-urlencode 'client_id=energy-trading' \\\n--data-urlencode 'client_secret=<secret>'\n```\n\n\nNow you should get the token. Optional: van verify the token directly in snowflake with SQL:\n\n```\nSELECT SYSTEM$VERIFY_EXTERNAL_OAUTH_TOKEN( '<token>' )\n```\n\nUse it in the snowflake statement endpoint. For example:\n\n```\ncurl --location --request POST 'https://lm84095.eu-central-1.snowflakecomputing.com/api/v2/statements?async=true' \\\n--header 'Authorization: Bearer <yourtoken> \\\n--header 'Content-Type: application/json' \\\n--data-raw '{\n\"statement\": \"select \\\"data\\\" as prediction, to_number(\\\"lats\\\", 10, 4) as lats, to_number(\\\"lons\\\", 10, 4) as lons, \\\"scaledValueOfFirstFixedSurface\\\" as scaled_value_of_first_fixed_surface, to_timestamp_tz( concat(\\\"dataDate\\\", lpad(\\\"dataTime\\\", 4, 0)) || '\\''+0'\\'', '\\''yyyymmddhh24mi+tzh'\\'') as model_datetime, to_timestamp_tz( concat(\\\"validityDate\\\", lpad(\\\"validityTime\\\", 4, 0)) || '\\''+0'\\'', '\\''yyyymmddhh24mi+tzh'\\'') as predicted_datetime, insert_date_snowflake, current_timestamp()::timestamp_tz(9) as insert_date_staging from raw.icon_eu.alhfl_s;\"\n}'\n```\n\nNB: It is important to use the proper snowflake base url. In my case I am using https://lm84095.eu-central-1.snowflakecomputing.com/ where lm84095 is my account identifier which was authorised during configuration phase the snowflake user the token is referring to in the clientId claim.\n\nYou should get a response such as:\n\n```\n{\n\"code\": \"333334\",\n\"message\": \"Asynchronous execution in progress. Use provided query id to perform query monitoring and management.\",\n\"statementHandle\": \"01aafc80-3201-abed-0001-4a0e00e52816\",\n\"statementStatusUrl\": \"/api/v2/statements/01aafc80-3201-abed-0001-4a0e00e52816\"\n}\n```\n\nNow you can follow the async operation to the following get endpoint:\n\n```\nhttps://lm84095.eu-central-1.snowflakecomputing.com/api/v2/statements/01aafc80-3201-abed-0001-4a0e00e52816\n```\n\nIt will return 202 if the processing is still ongoing. It will return 200 and the actual result when processing ends.\n\nHappy coding!","meta":{"title":"Authenticate Snowflake rest api via Keycloak","description":"How to use Keycloak to authenticate against Snowflake rest api","createdAt":"Tue Dec 19 2023 00:00:00 GMT+0000 (Coordinated Universal Time)","coverImage":"images/monolith.webp","tags":"keycloak, snowflake, rest, oauth, bearer token, authentication, security","author":"Rosario Renga","slug":"blog/authenticate-snowflake-rest-api-using-keycloak","formattedDate":"19 december 2023","date":"Tue Dec 19 2023 00:00:00 GMT+0000 (Coordinated Universal Time)"}}},"__N_SSG":true}