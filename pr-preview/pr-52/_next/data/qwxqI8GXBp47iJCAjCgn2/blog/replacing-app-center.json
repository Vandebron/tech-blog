{"pageProps":{"post":{"content":"\n## Why?\nTest. This seems like a lot of work... Why not go with an off-the-shelf solution from something like \n\n## Some notes before we get started\n- We actually use this workflow to build two apps, one of which can be white-labeled, so we have an additional `app` input which makes things a bit trickier. This is why we have the `env-variable-prep-android.sh` which normalizes the variable names used for secrets so those secrets and build file names, etc. can be easily used. If you just have a single app you probably don't need this script.\n- The code below is only for the build process. Though the ADR considered how this would affect future decisions about artifact upload automation and rolling out releases for internal testing, nothing about that is automated here.\n\n## Implementation\n1. Add the files below. Nothing in this setup should effect App Center but it is good to check in your changes to a branch and test those against the regular App Center build flow. File contents can be found in the [Appendix](#appendix)\n\n    | Android | iOS |\n    |------|-------------|\n    | `.github/workflows/mobile-apps-build-android.yaml` | `.github/workflows/mobile-apps-build-ios.yaml` |\n    | `env-variable-prep-android.sh` | `env-variable-prep-ios.sh` |\n    | `env-file-prep.sh` | `env-file-prep.sh` |\n    | `fastlane/Fastfile` | `fastlane/Fastfile` |\n    | N/A for Android | `fastlane/Gymfile` |\n\n2. Set up act to test your workflow locally. WARNING: GitHub Actions doesn't let you run a `workflow_dispatch` action until it has been merged into the main branch so you'll want to get the basic setup above in place before you start tinkering with application logic or things that could effect App Center. Also note that while `act` is helpful for getting the basics in place, it's unlikely you'll be able to test the complete process locally because, at least for us a) Android pipeline crashes halfway through the `Build App` step with an error of `Gradle build daemon disappeared unexpectedly (it may have been killed or may have crashed)`, and b) iOS tries to install a fresh copy of Xcode\n\n    1. Follow installation instructions on [their User Guide](https://nektosact.com/installation/index.html)\n    2. Create a `~/.actrc` file that looks like this\n\n        <pre style=\"font-size: 0.8rem; display: flex;\">\n          <code class=\"language-bash\">\n          --container-architecture linux/amd64\n          --secret GITHUB_TOKEN=$GITHUB_TOKEN\n          </code>\n        </pre>\n        \n    3. Get your `$GITHUB_TOKEN` env variable in place\n\n        1. Install [gh, the GitHub cli](https://cli.github.com/)\n        2. Modify shells (zsh shown below)\n\n            <pre style=\"font-size: 0.8rem; display: flex;\">\n              <code class=\"language-bash\">\n              export GITHUB_TOKEN=\"$(gh auth token)\"\n              </code>\n            </pre>\n\n        3. Close and re-open your terminal. Test to make sure you can see your `GITHUB_TOKEN` envrionment variable\n\n    4. Set up a temporary local file for secrets and GHA trigger inputs. WARNING: Once you’re done, remember to delete that .secret file so it’s not hanging around on your file system!! (or just don’t create it in the first place unless you really need it)\n\n        <table className=\"wide-table\">\n          <thead>\n            <tr>\n              <th>my-app-input.json</th>\n              <th>.secrets</th>\n            </tr>\n          </thead>\n          <tbody>\n            <tr>\n              <td>\n                <pre style=\"font-size: 0.8rem; display: flex;\">\n                  <code class=\"language-json\">\n        {\n          \"action\": \"workflow_dispatch\",\n          \"inputs\": {\n            \"app\": \"ev\",\n            \"environment\": \"test\",\n            \"essent-release\": false\n          }\n        }\n                  </code>\n                </pre>\n              </td>\n              <td>\n                <pre style=\"font-size: 0.8rem; display: flex;\">\n                  <code class=\"language-bash\">\n        ANDROID_STORE_PASSWORD=\"someSecr3ts\"\n        ANDROID_KEY_PASSWORD=\"YouWantQuotesBecause*s_etc.WillScrewYouUp\"\n        MAPBOX_READ_TOKEN=shhhhh.Its.asecret\n                  </code>\n                </pre>\n              </td>\n            </tr>\n          </tbody>\n        </table>\n\n    5. Run your workflow like this. As far as I know, you can only run the iOS workflow locally if you're on a mac. To do that you'll need to provide an additional parameter: `-P macos-latest=-self-hosted`\n      \n        <pre style=\"font-size: 0.8rem; display: flex;\">\n          <code class=\"language-bash\">\n          act \\\n          --workflows .github/workflows/mobile-apps-build-android.yaml \\\n          --eventpath=\"${HOME}/Documents/IT/GitHub Actions/Mobile Apps/my-app-input.json\" \\\n          --secret-file=\"${HOME}/Documents/IT/GitHub Actions/Mobile Apps/.secrets\"\n          </code>\n        </pre>\n\n3. Once you're happy with your changes locally, send a PR & merge them in!\n4. Go to the \"Actions\" tab at the top of your GitHub repo. You should now see your actions for building iOS and Android on the left. Since it's a `workflow_dispatch` action you'll trigger the actions manually.\n\n    <div style=\"display: flex; justify-content: center\">\n      <img src=\"../images/replacing-app-center-run-workflow.png\" alt=\"run-workflow\" style=\"width: 500px;\"/>\n    </div>\n\n5. More than likely these won't work the first time. Time to go back and adjust. Note that since the workflow is now in the main branch you can test your workflow changes on a feature branch. Just select your feature branch in the \"Branch\" dropdown shown above.\n\n## Other Things to Note\n\n<ul>\n  <li>App Center gives you the ability to write `appcenter-pre-build.sh` and `appcenter-post-build.sh` scripts. The `env-file-prep.sh` is basically that same thing, just without the context of appcenter.</li>\n  <li>One of our apps is using MapBox which needs a `.netrc` in the root directory. If you need something similar, you can add a step to your action by adding the code shown in the the \"optional mapbox\" part + the `./my-app/prep-mapbox.sh` in the [Appendix](#appendix).</li>\n</ul>\n\n## Benefits\n- It regularly took over 50 minutes for our mobile app to build in App Center. Part of that could have very likely be improved by adjusting App Center configurations & how we store and bundle app assets but after migrating our builds to GitHub Actions our app build times are now down to 22 minutes - More than twice as fast!\n- All the rest of the software at Vandebron (backend services in Scala and Python and frontend applications in Typescript + React) is built using GitHub Actions. This move brings mobile apps in line with all other software. This move to GHA for mobile builds has forced several of our mobile devs to get our hands dirty in GHA which is great because we can now play a role in the larger CICD discussions.\n- We have full control over our CICD pipeline for mobile builds. In the future we can integrate more Fastlane commands to further automate the release process.\n- Though it's not the point of this blog, we did a full ADR (shown below) which initiated the work here.\n  ![replace-app-center-adr](../images/replacing-app-center-adr.png)\n\n\n## Appendix\n<pre style=\"font-size: 0.8rem; display: flex;\">\n  <code class=\"language-yaml\" className=\"small-code\">\n  # file: .github/workflows/mobile-apps-build-android.yaml\n  ---\n  name: Mobile App Build for Android\n  run-name: \"Build: Android ${{ inputs.environment }}\"\n  on:\n    workflow_dispatch:\n      inputs:\n        environment:\n          description: 'Environment'\n          required: true\n          type: choice\n          options:\n            - test\n            - acceptance\n            - production\n  jobs:\n    build:\n      name: Build app for android\n      runs-on: ubuntu-latest\n      environment: ${{ inputs.environment }}\n      steps:\n\n        - name: Checkout ${{ github.repository }}\n          uses: actions/checkout@v4.2.2\n\n        - name: Prep Env Variables\n          id: prep-env-variables\n          working-directory: mobile\n          env:\n            ENVIRONMENT: ${{ inputs.environment }}  # production | test | acceptance\n            ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}\n            ANDROID_STORE_PASSWORD: ${{ secrets.ANDROID_STORE_PASSWORD }}\n          run: bash ./env-variable-prep-android.sh\n\n        - name: Create .env file\n          working-directory: mobile\n          env:\n            ENVIRONMENT: ${{inputs.environment}}\n          run: bash ./env-file-prep.sh\n\n        - name: Enable Corepack\n          run: corepack enable\n\n        - name: Setup NodeJS\n          id: setup-node\n          uses: actions/setup-node@v4.1.0\n          with:\n            node-version: 18.x\n            registry-url: https://registry.npmjs.org\n            cache: 'yarn'\n            cache-dependency-path: mobile/my-app/yarn.lock\n\n        - name: Setup Java\n          uses: actions/setup-java@v4.6.0\n          with:\n            distribution: 'temurin'\n            java-version: '20'\n            cache: 'gradle'\n        - name: Setup Android SDK  # sadly no caching capabilities here\n          uses: android-actions/setup-android@v3.2.2\n          with:\n            log-accepted-android-sdk-licenses: false\n            packages: 'tools'   # Default is 'tools platform-tools but we don't need platform-tools for packaging'\n\n        - name: Set up ruby env # Fastlane is a \"Ruby gem\"\n          uses: ruby/setup-ruby@v1\n          with:\n            ruby-version: '3.3.0'\n            bundler-cache: true\n\n        - name: Install Gem Bundler\n          working-directory: mobile/my-app\n          run: |\n            gem install bundler\n            bundle install --quiet\n\n        # Install Dependencies\n        - name: Yarn Install\n          working-directory: mobile/my-app\n          run: yarn install --immutable\n\n        # Build\n        - name: Build App\n          run: bundle exec fastlane android build --env \"$FASTLANE_ENV_INFERRED_BRAND.$ENVIRONMENT\"\n          working-directory: mobile/my-app\n          env:\n            ENVIRONMENT: ${{ inputs.environment }}\n            ANDROID_KEYSTORE_FILE: ${{ steps.prep-env-variables.outputs.android-keystore-file }}\n            ANDROID_KEY_ALIAS: ${{ steps.prep-env-variables.outputs.android-key-alias }}\n            ANDROID_STORE_PASSWORD: ${{ steps.prep-env-variables.outputs.android-store-pass }}\n            ANDROID_KEY_PASSWORD: ${{ steps.prep-env-variables.outputs.android-keystore-pass }}\n            FASTLANE_ANDROID_FLAVOR: ${{ steps.prep-env-variables.outputs.fastlane-android-flavor }}\n\n        # Upload\n        - name: Upload application\n          uses: actions/upload-artifact@v4\n          with:\n            name: ${{steps.prep-env-variables.outputs.artifact-name}}\n            path: \"mobile/my-app/android/app/build/outputs/bundle/${{ steps.prep-env-variables.outputs.fastlane-android-flavor }}Release/app-${{ steps.prep-env-variables.outputs.fastlane-android-flavor }}-release.aab\"\n            retention-days: 30\n  </code>\n</pre>\n\n<pre style=\"font-size: 0.8rem; display: flex;\">\n  <code class=\"language-yaml\">\n  # file: .github/workflows/mobile-apps-build-ios.yaml\n  ---\n  name: Mobile App Build for iOS\n  run-name: \"Build: iOS, ${{ inputs.environment }}\"\n\n  on:\n    workflow_dispatch:\n      inputs:\n        environment:\n          description: 'Environment'\n          required: true\n          type: choice\n          options:\n            - test\n            - acceptance\n            - production\n\n  jobs:\n    build:\n      name: Build app for iOS\n      runs-on: macos-latest\n      environment: ${{ inputs.environment }}\n      steps:\n\n        - name: Checkout ${{ github.repository }}\n          uses: actions/checkout@v4.2.2\n\n        - name: Prep Env Variables\n          id: prep-env-variables\n          working-directory: mobile\n          env:\n            ENVIRONMENT: ${{ inputs.environment }}  # production | test | acceptance\n            IOS_MOBILE_PROVISIONING_PROFILE: ${{ secrets.THUIS_IOS_MOBILE_PROVISIONING_PROFILE }}\n          run: bash ./env-variable-prep-ios.sh\n\n        - name: Create .env file\n          working-directory: mobile\n          env:\n            ENVIRONMENT: ${{inputs.environment}}\n          run: bash ./env-file-prep.sh\n\n        - name: Import Build Certificate from Secrets\n          uses: apple-actions/import-codesign-certs@v3\n          with:\n            p12-file-base64: ${{ secrets.IOS_BUILD_CERTIFICATE_P12 }}\n            p12-password: ${{ secrets.IOS_BUILD_CERTIFICATE_P12_PASSWORD }}\n\n        - name: Import Mobile Provisioning Profile\n          uses: nickwph/apple-provisioning-profile-action@v1.0.0\n          with:\n            profile-base64: ${{ steps.prep-env-variables.outputs.ios-mobile-provisioning-profile }}\n\n        - name: Setup NodeJS\n          id: setup-node\n          uses: actions/setup-node@v4.2.0\n          with:\n            node-version: 20.x\n\n        - name: Install XCode\n          uses: maxim-lobanov/setup-xcode@v1\n          with:\n            xcode-version: 16.1\n\n        - name: Install Ruby\n          uses: ruby/setup-ruby@v1\n          with:\n            ruby-version: 3.3.0\n\n        - name: Install Bundler\n          run: gem install bundler\n\n        # TODO: Cache node_modules similarly to how Pods are cached (compare hash of yarn.lock)\n        - name: Yarn Install\n          working-directory: mobile/${{ inputs.app }}\n          run: yarn install --immutable\n\n        # TODO: Cache Gems similarly to how Pods are cached (compare hash of Gemfile.lock)\n        - name: Install Gems\n          run: bundle install\n          working-directory: mobile/${{ inputs.app }}\n\n        - name: Cache CocoaPods dependencies\n          uses: actions/cache@v4\n          env:\n            FILES_GLOB: mobile/${{ inputs.app }}/ios/Podfile.lock\n          with:\n            path: |\n              mobile/${{ inputs.app }}/ios/Pods\n            key: ${{ runner.os }}-pods-${{ hashFiles(env.FILES_GLOB) }}\n            restore-keys: |\n              ${{ runner.os }}-pods-\n\n        - name: Install Pods\n          working-directory: mobile/${{ inputs.app }}/ios\n          run: bundle exec pod install\n\n        - name: Build iOS App\n          env:\n            SCHEME: ${{ steps.prep-env-variables.outputs.ios-scheme }}\n          run: bundle exec fastlane gym\n          working-directory: mobile/${{ inputs.app }}\n\n        # Upload\n        - name: Upload application\n          uses: actions/upload-artifact@v4\n          with:\n            name: ${{steps.prep-env-variables.outputs.ios-scheme}}\n            path: \"mobile/${{ inputs.app }}/ios/build/${{ steps.prep-env-variables.outputs.ios-scheme }}.ipa\"\n            retention-days: 30\n            overwrite: true\n            if-no-files-found: error\n  </code>\n</pre>\n\n<pre style=\"font-size: 0.8rem; display: flex;\">\n  <code class=\"language-bash\">\n  # file: env-variable-prep-android.sh\n  #!/bin/bash\n\n  ARTIFACT_NAME=\"mobile-my-app-${ENVIRONMENT}-release\"\n  FASTLANE_ANDROID_FLAVOR=\"${ENVIRONMENT}\"\n  {\n    echo \"artifact-name=${ARTIFACT_NAME}\"\n    echo \"fastlane-android-flavor=${FASTLANE_ANDROID_FLAVOR}\"\n  } | tee -a \"$GITHUB_OUTPUT\"\n\n  # Secrets should not get sent out over tee command (which also prints it to console)\n  {\n    echo \"android-key-alias=my-app\"\n    echo \"android-keystore-file=../keystores/my-app.jks\"\n    echo \"android-keystore-pass=${ANDROID_KEY_PASSWORD}\"\n    echo \"android-store-pass=${ANDROID_STORE_PASSWORD}\"\n  } >> \"$GITHUB_OUTPUT\"\n  </code>\n</pre>\n\n\n<pre style=\"font-size: 0.8rem; display: flex;\">\n  <code class=\"language-bash\">\n  # file: env-variable-prep-ios.sh\n  #!/bin/bash\n\n  # Secrets should not get sent out over tee command (which also prints it to console)\n  {\n    echo \"ios-mobile-provisioning-profile=${IOS_MOBILE_PROVISIONING_PROFILE}\"\n  } >> \"$GITHUB_OUTPUT\"\n  </code>\n</pre>\n\n\n<pre style=\"font-size: 0.8rem; display: flex;\">\n  <code class=\"language-bash\">\n  # file: env-file-prep.sh\n  #!/usr/bin/env bash\n\n  #####################################################\n  # Creates an .env file for use in react-native-config\n  # This script should be run from the /mobile folder\n  #####################################################\n\n  if [ \"${ENVIRONMENT}\" != \"test\" ] && [ \"${ENVIRONMENT}\" != \"acceptance\" ] && [ \"${ENVIRONMENT}\" != \"production\" ]; then\n      echo \"ENVIRONMENT is not set, using 'production' as default.\"\n      ENVIRONMENT=production\n  fi\n\n  echo \"Copying 'my-app/.env.${ENVIRONMENT}' to 'my-app/.env'...\"\n  cp \"my-app/.env.${ENVIRONMENT}\" \"my-app/.env\"\n\n  echo \"Success!\"\n  </code>\n</pre>\n\n\n<pre style=\"font-size: 0.8rem; display: flex;\">\n  <code class=\"language-bash\">\n  # file: ./fastlane/Fastfile\n  opt_out_usage\n\n  platform :android do\n    desc 'Build app for Android'\n      lane :build do\n        build_android_app(\n          task: 'bundle',\n          flavor: ENV['FASTLANE_ANDROID_FLAVOR'],\n          build_type: 'Release',\n          project_dir: 'android/',\n          print_command: true,\n          print_command_output: true,\n        )\n      end\n  end\n  </code>\n</pre>\n\n\n<pre style=\"font-size: 0.8rem; display: flex;\">\n  <code class=\"language-bash\">\n  # file: ./fastlane/Gymfile\n  scheme(ENV['SCHEME'])\n  workspace(\"ios/my-app.xcworkspace\")\n  export_options(\"ios/exportOptions.plist\")\n  output_directory(\"ios/build\")\n  output_name(ENV['SCHEME'])\n  </code>\n</pre>\n\n\n<pre style=\"font-size: 0.8rem; display: flex;\">\n  <code class=\"language-yaml\">\n  # file: .github/workflows/mobile-apps-build-android.yaml and .github/workflows/mobile-apps-build-ios.yaml (optional mapbox)\n  - name: Create Mapbox .netrc file (EV only)\n    if: ${{ inputs.app == 'my-app' }}\n    working-directory: mobile\n    env:\n      MAPBOX_READ_TOKEN: ${{ secrets.MAPBOX_READ_TOKEN }}\n    run: bash ./my-app/prep-mapbox.sh\n  </code>\n</pre>\n\n\n<pre style=\"font-size: 0.8rem; display: flex;\">\n  <code class=\"language-bash\">\n  # file: ./my-app/prep-mapbox.sh\n  #!/usr/bin/env bash\n  \n  # WARN: DO NOT use tee here (it prints to console)\n  {\n    echo \"machine api.mapbox.com\"\n    echo \"login mapbox\"\n    echo \"password ${MAPBOX_READ_TOKEN}\"\n  } >> ~/.netrc\n  chmod 0600 ~/.netrc\n  </code>\n</pre>\n\n## Test\n\n<table>\n  <thead>\n    <tr>\n      <th>Header 1</th>\n      <th>Header 2</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <td style=\"max-width: 40vw;\">\n      <pre style=\"font-size: 0.8rem; display: flex;\">\n        <code class=\"language-yaml\">\n        # file: .github/workflows/mobile-apps-build-android.yaml and .github/workflows/mobile-apps-build-ios.yaml (optional mapbox)\n        - name: Create Mapbox .netrc file (EV only)\n          if: ${{ inputs.app == 'my-app' }}\n          working-directory: mobile\n          env:\n            MAPBOX_READ_TOKEN: ${{ secrets.MAPBOX_READ_TOKEN }}\n          run: bash ./my-app/prep-mapbox.sh\n        </code>\n      </pre>\n      </td>\n      <td style=\"max-width: 40vw;\">\n        <pre style=\"font-size: 0.8rem; display: flex;\">\n          <code class=\"language-bash\">\n          # file: ./my-app/prep-mapbox.sh\n          #!/usr/bin/env bash\n          # WARN: DO NOT use tee here (it prints to console)\n          {\n            echo \"machine api.mapbox.com\"\n            echo \"login mapbox\"\n            echo \"password ${MAPBOX_READ_TOKEN}\"\n          } >> ~/.netrc\n          chmod 0600 ~/.netrc\n          </code>\n        </pre>\n      </td>\n    </tr>\n  </tbody>\n</table>\n\n\n\n\n","meta":{"title":"Finding a Replacement for App Center","description":"App Center is closing up shop on March 31st, 2025 so what's the plan for building mobile apps at Vandebron?","createdAt":"Sat Jan 25 2025 00:00:00 GMT+0000 (Coordinated Universal Time)","coverImage":"images/replacing-app-center-building-a-phone.jpg","tags":["reactnative","App Aenter","GHA"],"author":"John Fisher & Arnav Mundkur","slug":"blog/replacing-app-center","formattedDate":"25 januari 2025","date":"Sat Jan 25 2025 00:00:00 GMT+0000 (Coordinated Universal Time)"}}},"__N_SSG":true}