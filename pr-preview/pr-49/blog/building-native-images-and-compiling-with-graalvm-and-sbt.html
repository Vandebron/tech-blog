<!DOCTYPE html><html lang="en"><head><script async="" src="https://www.google-analytics.com/analytics.js"></script><link rel="stylesheet" href="https://d381m57et8llfk.cloudfront.net/20210128-6054/static/css/dc7f55cf12b36887a247.fonts.css"/><script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
                ga('create', 'UA-49472651-19', { 'storage': 'none' });
                ga('send', 'pageview');</script><script src="https://unpkg.com/react-bootstrap@next/dist/react-bootstrap.min.js" crossorigin="anonymous"></script><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>Building native images and compiling with GraalVM and sbt</title><meta name="Description" content="At Vandebron we organized a two-day long Hackathon, a colleague and I took the chance to dig into the wonderful world of GraalVM."/><meta property="og:title" content="Building native images and compiling with GraalVM and sbt"/><meta property="og:description" content="At Vandebron we organized a two-day long Hackathon, a colleague and I took the chance to dig into the wonderful world of GraalVM."/><meta property="og:image" content="https://www.vandebron.tech/images/building-native-images-and-compiling-with-graalvm-and-sbt.jpg"/><meta name="next-head-count" content="7"/><link rel="preload" href="/pr-preview/pr-49/_next/static/css/15f65137df845345c0ce.css" as="style"/><link rel="stylesheet" href="/pr-preview/pr-49/_next/static/css/15f65137df845345c0ce.css" data-n-g=""/><link rel="preload" href="/pr-preview/pr-49/_next/static/css/3aca0a87025bd2bb0b43.css" as="style"/><link rel="stylesheet" href="/pr-preview/pr-49/_next/static/css/3aca0a87025bd2bb0b43.css" data-n-g=""/><noscript data-n-css=""></noscript><link rel="preload" href="/pr-preview/pr-49/_next/static/chunks/webpack-0b9cc56c94819e8023ea.js" as="script"/><link rel="preload" href="/pr-preview/pr-49/_next/static/chunks/framework.87b9127d6cd191ae1c9a.js" as="script"/><link rel="preload" href="/pr-preview/pr-49/_next/static/chunks/3ef630e34cd10ba68f9d468ac363ff81c534e1e9.1bafdc53d1881d09197f.js" as="script"/><link rel="preload" href="/pr-preview/pr-49/_next/static/chunks/main-419ac17f185f95278b96.js" as="script"/><link rel="preload" href="/pr-preview/pr-49/_next/static/chunks/7b9503d2.4af90216c47085b5c8e9.js" as="script"/><link rel="preload" href="/pr-preview/pr-49/_next/static/chunks/0f4fa802.a83a6a4548b93404854d.js" as="script"/><link rel="preload" href="/pr-preview/pr-49/_next/static/chunks/226daff62b2d4bc1e9a7210a7f6000a544319a74.fbdd4d016a5c47ddc9db.js" as="script"/><link rel="preload" href="/pr-preview/pr-49/_next/static/chunks/pages/_app-39339a87bd082502c1e2.js" as="script"/><link rel="preload" href="/pr-preview/pr-49/_next/static/chunks/1c49f5f00355f650bee3d37484f094be037a30fa.0c099ecf2acefc71ba39.js" as="script"/><link rel="preload" href="/pr-preview/pr-49/_next/static/chunks/pages/blog/%5Bslug%5D-ff8f9ea31e126f437ccb.js" as="script"/></head><body><div id="__next"><div class="Container-module__container" as="header" style="padding-top:30px;padding-bottom:30px;margin-bottom:30px"><div class="Row-module__row Row-module__align-items-center Row-module__justify-content-between"><div class="Col-module__col-box-sizing Col-module__col Col-module__col-12 Col-module__col-md-auto Col-module__col-lg-auto Col-module__col-sm-12"><div><div style="cursor:pointer;user-select:none;display:flex;align-items:baseline"><svg width="140" viewBox="0 0 140 22" xmlns="http://www.w3.org/2000/svg"><path d="M9.569 21.109h-4.25L0 6.274h4.597l2.86 9.249 2.86-9.249h4.598L9.57 21.11m13.234-4.258a3.159 3.159 0 0 1 0-6.316 3.156 3.156 0 0 1 3.144 2.884v.543a3.157 3.157 0 0 1-3.144 2.889m3.2-9.81a7.38 7.38 0 1 0 0 13.3c.136.425.537.73 1.003.73h3.174V6.313h-3.174c-.466 0-.867.304-1.003.728m64.522 3.567a3.155 3.155 0 0 0-3.141 2.888v.542a3.155 3.155 0 0 0 3.14 2.885 3.16 3.16 0 0 0 3.165-3.157 3.163 3.163 0 0 0-3.164-3.158m0 10.536a7.337 7.337 0 0 1-3.195-.727 1.056 1.056 0 0 1-1.006.727h-3.171V0h4.23v7.09a7.377 7.377 0 0 1 10.522 6.676c.001 4.074-3.298 7.378-7.38 7.378m26.406-4.22a3.155 3.155 0 0 1-3.141-2.886v-.542a3.155 3.155 0 0 1 3.141-2.888 3.163 3.163 0 0 1 3.164 3.159 3.161 3.161 0 0 1-3.164 3.156m.012-10.511c-5.054 0-7.481 3.978-7.481 7.356v.025c0 3.402 2.427 7.38 7.48 7.38 5.054 0 7.48-3.978 7.48-7.38 0-3.403-2.426-7.381-7.48-7.381m-60.448 4.196a3.155 3.155 0 0 1 3.141 2.888v.542a3.156 3.156 0 0 1-3.141 2.885 3.16 3.16 0 0 1-3.165-3.157 3.163 3.163 0 0 1 3.165-3.158m0 10.536a7.377 7.377 0 0 1-7.381-7.378A7.377 7.377 0 0 1 59.635 7.09V0h4.23v21.144h-3.17c-.473 0-.866-.303-1.006-.727a7.342 7.342 0 0 1-3.195.727zm51.349-14.856v4.222a3.074 3.074 0 0 0-.244-.013c-1.64 0-3.138 1.057-3.138 2.585v8.025h-4.234V6.276h3.17c.473 0 .867.303 1.006.727a7.353 7.353 0 0 1 3.196-.727c.082 0 .162.01.244.012zm25.525 4.21c-1.467 0-2.348.886-2.348 2.584v8.09h-4.285V6.277h3.172c.472 0 .865.304 1.005.727a7.347 7.347 0 0 1 3.195-.727s1.239-.059 2.514.343c3.027.904 3.379 3.962 3.379 5.599v8.955h-4.284v-8.091c0-.883-.205-2.585-2.348-2.585zm-93.333 0c-1.467 0-2.348.886-2.348 2.584v8.09h-4.284V6.277h3.17c.474 0 .866.304 1.006.727a7.354 7.354 0 0 1 3.196-.727s1.239-.059 2.514.343c3.028.904 3.378 3.962 3.378 5.599v8.955h-4.284v-8.091c0-.883-.204-2.585-2.348-2.585zm36.24 1.755h-5.453c-.116-.003-.55-.055-.325-.637a3.336 3.336 0 0 1 6.134.093c.147.495-.246.541-.356.544m2.55-3.796c-1.308-1.384-3.145-2.214-5.284-2.214-4.254 0-7.324 3.598-7.324 7.5 0 4.15 3.398 7.398 7.399 7.398a6.789 6.789 0 0 0 3.976-1.258c1.183-.806 2.165-2.013 2.844-3.574h-4.278c-.503.73-1.208 1.31-2.542 1.31-1.635 0-3.045-.983-3.22-2.468h10.393c.327-2.566-.202-4.806-1.964-6.694" fill="#333D47" fill-rule="evenodd"></path></svg>Â <span class="Text-module__text-default Text-module__u-font-h3 Text-module__u-font-color-green" style="font-size:28px;margin:0;line-height:auto">.tech</span></div></div></div><div class="Col-module__col-box-sizing Col-module__col Col-module__col-12 Col-module__col-md-auto Col-module__col-lg-auto Col-module__col-sm-12"><div class="Flex-module__d-flex Flex-module__flex-row Flex-module__align-items-stretch Flex-module__justify-content-start Flex-module__justify-content-sm-between"><ul class="Navigation-module__navigation-wrapper" id="styled-navigation" style="margin-right:25px"><li class="Navigation-module__navigation-link-wrapper"><a class="Pressable-module__button Pressable-module__text Navigation-module__navigation-link Navigation-module__navigation-link-active" name="Home" url="/"><span>Home</span></a></li><li class="Navigation-module__navigation-link-wrapper"><a class="Pressable-module__button Pressable-module__text Navigation-module__navigation-link" name="About" url="/about"><span>About</span></a></li><li class="Navigation-module__navigation-link-wrapper"><a class="Pressable-module__button Pressable-module__text Navigation-module__navigation-link" name="vandebron.nl" url="https://vandebron.nl"><span>vandebron.nl</span></a></li><div class="Navigation-module__navigation-magic-line" style="transition:none;left:0;width:0"></div></ul><div><a class="Pressable-module__button Pressable-module__text" href="https://github.com/vandebron/" target="_blank" rel="noreferrer" style="margin-right:10px"><svg role="img" viewBox="0 0 24 24" width="1em" height="1em" class="Icon-module__icon Icon-module__u-font-color-charcoal-gray" style="font-size:150%"><title>GitHub icon</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path></svg><span class="visually-hidden">Vandebron on Github</span></a><a class="Pressable-module__button Pressable-module__text" href="https://dev.to/vandebron/" target="_blank" rel="noreferrer" style="margin-right:10px"><svg viewBox="0 0 448 512" width="1em" height="1em" class="Icon-module__icon Icon-module__u-font-color-charcoal-gray" style="font-size:150%"><path fill="currentColor" d="M120.12 208.29c-3.88-2.9-7.77-4.35-11.65-4.35H91.03v104.47h17.45c3.88 0 7.77-1.45 11.65-4.35 3.88-2.9 5.82-7.25 5.82-13.06v-69.65c-.01-5.8-1.96-10.16-5.83-13.06zM404.1 32H43.9C19.7 32 .06 51.59 0 75.8v360.4C.06 460.41 19.7 480 43.9 480h360.2c24.21 0 43.84-19.59 43.9-43.8V75.8c-.06-24.21-19.7-43.8-43.9-43.8zM154.2 291.19c0 18.81-11.61 47.31-48.36 47.25h-46.4V172.98h47.38c35.44 0 47.36 28.46 47.37 47.28l.01 70.93zm100.68-88.66H201.6v38.42h32.57v29.57H201.6v38.41h53.29v29.57h-62.18c-11.16.29-20.44-8.53-20.72-19.69V193.7c-.27-11.15 8.56-20.41 19.71-20.69h63.19l-.01 29.52zm103.64 115.29c-13.2 30.75-36.85 24.63-47.44 0l-38.53-144.8h32.57l29.71 113.72 29.57-113.72h32.58l-38.46 144.8z"></path></svg><span class="visually-hidden">Vandebron on Dev.to</span></a><a class="Pressable-module__button Pressable-module__text" href="https://medium.com/vandebron/" target="_blank" rel="noreferrer"><svg viewBox="0 0 448 512" width="1em" height="1em" class="Icon-module__icon Icon-module__u-font-color-charcoal-gray" style="font-size:150%"><path fill="currentColor" d="M0 32v448h448V32H0zm372.2 106.1l-24 23c-2.1 1.6-3.1 4.2-2.7 6.7v169.3c-.4 2.6.6 5.2 2.7 6.7l23.5 23v5.1h-118V367l24.3-23.6c2.4-2.4 2.4-3.1 2.4-6.7V199.8l-67.6 171.6h-9.1L125 199.8v115c-.7 4.8 1 9.7 4.4 13.2l31.6 38.3v5.1H71.2v-5.1l31.6-38.3c3.4-3.5 4.9-8.4 4.1-13.2v-133c.4-3.7-1-7.3-3.8-9.8L75 138.1V133h87.3l67.4 148L289 133.1h83.2v5z"></path></svg><span class="visually-hidden">Vandebron on Medium</span></a></div></div></div></div></div><div class="Container-module__container"><div class="Row-module__row"><div class="Col-module__col-box-sizing Col-module__col Col-module__col-12"><h2 class="Text-module__text-default Text-module__u-font-h2">Building native images and compiling with GraalVM and sbt</h2></div><div class="Col-module__col-box-sizing Col-module__col Col-module__col-12"><p class="Text-module__text-default Text-module__u-font-body"><span class="Text-module__text-default">By Katrin Grunert on 6 oktober 2020</span></p></div></div><div class="Row-module__row"><div class="Col-module__col-box-sizing Col-module__col Col-module__col-12"><p class="Text-module__text-default Text-module__u-font-body"><div class="Image-module__image-container" style="padding-bottom:50%"><div style="height:200px" class="lazyload-placeholder"></div></div><a class="Pressable-module__button Pressable-module__text" href="https://pixabay.com/users/lumix2004-3890388/">Image source</a></p></div></div><div class="Row-module__row" style="margin-bottom:60px"><div class="Col-module__col-box-sizing Col-module__col Col-module__col-12"><p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">At Vandebron we organize a two-day long Hackathon every quarter, and a colleague and I took this chance to dig into the wonderful world of GraalVM.</p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">I&#x27;ve first heard of GraalVM around two years ago when Oleg Å elajev toured through Java User Groups in Germany and held talks about GraalVM. <a href="https://www.youtube.com/watch?v=GinNxS3OSi0" node="[object Object]" style="color:inherit" target="_blank">Here</a> is one from 2019 (not Germany, but Spain this time).</p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">GraalVM promises a significant speedup in compile times and as I am working with Scala, which is notoriously known for its long compile times, this seems interesting. Furthermore, GraalVM provides functionality to build native executables. Meaning, an application can be run without a Java Virtual Machine (JVM).</p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">Thanks to the Hackathon I finally took the time to get to know GraalVM a bit better. With this blog post, I want to share our findings, experiences, and results, as they might be helpful for you too!</p>
<h2 class="Text-module__text-default Text-module__u-font-h2">What is GraalVM?</h2>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">GraalVM is a high-performance JVM that supports efficient ahead-of-time (AOT) and just-in-time (JIT) compilation, but also allows non-JVM languages (e.g. Ruby, Python, C++) to run on the JVM. The ahead-of-time compilation feature is the base for creating native executable programs, meaning an application can be run independently from the JVM. Seeing the versatile features of GraalVM, it is worth looking a bit under its hood.</p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">Actually, GraalVM is defined by three main technologies:</p>
<ol style="margin-block-start:0;margin-block-end:30px">
<li class="Text-module__text-default Text-module__u-font-body" style="margin-bottom:0"><a href="https://www.graalvm.org/reference-manual/jvm/" node="[object Object]" style="color:inherit" target="_blank">Graal compiler</a>, a high-performance JIT-compiler that can make JVM applications run faster from within the JVM</li>
<li class="Text-module__text-default Text-module__u-font-body" style="margin-bottom:0"><a href="https://www.graalvm.org/reference-manual/native-image/SubstrateVM/" node="[object Object]" style="color:inherit" target="_blank">SubstrateVM</a>, includes the necessary components to run a JVM-app as a native executable ( Garbage Collector, Thread Scheduler, etc.)</li>
<li class="Text-module__text-default Text-module__u-font-body" style="margin-bottom:0"><a href="https://www.graalvm.org/graalvm-as-a-platform/language-implementation-framework/" node="[object Object]" style="color:inherit" target="_blank">Truffle Language Implementation Framework</a>, the basis for the polyglot support from GraalVM</li>
</ol>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">Our motivation for trying out GraalVM was tackling the pain points of Scala, Java projects, and microservices. Shipping microservices written in Scala as Docker containers to your production system comes with the cost that startup can be a bit slow, having JVM and Docker overhead, and that those containers can be fairly large, as the application can only be run with a JVM. See <a href="#building-docker-images" node="[object Object]" style="color:inherit">Building Docker images</a> for more information.</p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">During the hackathon, we were most interested in building native images for Scala applications. Hoping to reduce the size of our docker containers and reducing up the startup time.</p>
<h2 class="Text-module__text-default Text-module__u-font-h2">Project setup</h2>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">The project we worked on during the Hackathon is an API that should be used for applicants to submit their applications at Vandebron in the future. By exposing one endpoint through which a resume and contact information can be submitted.</p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">It is also a good project to test out GraalVM, nothing too complex but also not as simple as &quot;Hello World&quot;.</p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">The full setup can be found <a href="https://github.com/kgrunert/apply-at-vdb" node="[object Object]" style="color:inherit" target="_blank">on Github</a>. But I&#x27;ll summarise the used stack below. The project is built around the following libraries, no particular reason, simply because I like them.</p>
<ol style="margin-block-start:0;margin-block-end:30px">
<li class="Text-module__text-default Text-module__u-font-body" style="margin-bottom:0"><em>cats</em> for working with effects, such as IO</li>
<li class="Text-module__text-default Text-module__u-font-body" style="margin-bottom:0"><em>http4s</em> for running the server</li>
<li class="Text-module__text-default Text-module__u-font-body" style="margin-bottom:0"><em>tapir</em> for defining the endpoints</li>
<li class="Text-module__text-default Text-module__u-font-body" style="margin-bottom:0"><em>circe</em> for JSON de/serialisation</li>
<li class="Text-module__text-default Text-module__u-font-body" style="margin-bottom:0"><em>pureconfig</em> for reading config-files</li>
<li class="Text-module__text-default Text-module__u-font-body" style="margin-bottom:0"><em>logback</em> for logging</li>
</ol>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">The project can be run via <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">sbt run</code> and with Postman or similar a POST-request can be sent like so:</p>
<pre><div style="color:#f8f8f2;background:#272822;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-json" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">POST localhost:8080/api/v1/apply

{
	&quot;email&quot;: &quot;my@email.de&quot;,
	&quot;name&quot;: &quot;My Name&quot;,
	&quot;phoneNumber&quot;: &quot;+310123456789&quot;,
	&quot;applicationBase64&quot;: &quot;VGhpcyBjb3VsZCBiZSB5b3VyIGFwcGxpY2F0aW9uIQ==&quot;
}

Response:
&quot;*confetti* Thanks for handing in your application, we will get back to you within the next days! *confetti*&quot;</code></div></pre>
<h2 class="Text-module__text-default Text-module__u-font-h2">Setup GraalVM with sbt</h2>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">With this initial project setup in mind, GraalVM needs to be installed locally.</p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">For the installation of GraalVM the <a href="https://www.graalvm.org/docs/getting-started-with-graalvm/#install-graalvm" node="[object Object]" style="color:inherit">setup guide</a> can be followed.</p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">After the installation sbt needs to know that not the regular JDK/JVM is used. This can be done with the <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">java-home</code> option on sbt bootup.
To make the path to GraalVM a bit more accessible and easy to use it can be exported as an environment variable.</p>
<pre><div style="color:#f8f8f2;background:#272822;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-bash" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">export GRAAL_HOME=/Library/Java/JavaVirtualMachines/graalvm-ce-java8-20.1.0/Contents/Home
sbt -java-home $GRAALHOME</code></div></pre>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">The path to GraalVM can vary depending on OS and installation. We followed the basic installation for macOS.</p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">Now sbt using GraalVM can be verified with:</p>
<pre><div style="color:#f8f8f2;background:#272822;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-bash" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">sbt -java-home $GRAALHOME
scala&gt; eval System.getProperty(&quot;java.home&quot;)
[info] ans: String = /Library/Java/JavaVirtualMachines/graalvm-ce-java8-20.1.0/Contents/Home/jre</code></div></pre>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">That means everything running in this sbt instance is getting compiled by GraalVM. Awesome!</p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">The next step is to become strong and independent and learn how to run without an underlying JVM with the help of building native images.</p>
<h2 class="Text-module__text-default Text-module__u-font-h2">Building native images</h2>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">GraalVM ships with the <a href="https://www.graalvm.org/reference-manual/graalvm-updater/" node="[object Object]" style="color:inherit" target="_blank">GraalVM Updater</a> (<code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">gu</code>) to install the <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">native-image</code> on your machine.</p>
<pre><div style="color:#f8f8f2;background:#272822;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-bash" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">$GRAALHOME/bin/gu install native-image</code></div></pre>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]"><a href="https://sbt-native-packager.readthedocs.io/en/latest/" node="[object Object]" style="color:inherit" target="_blank">sbt-native-packager</a> provides functionality to build packages efficiently (e.g. building Docker images) and added to that, it also provides support for building native images.
In order to build native images with sbt commands this plugin has to be added to the project:</p>
<pre><div style="color:#f8f8f2;background:#272822;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-java" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">// inside project/plugins.sbt
addSbtPlugin(&quot;com.typesafe.sbt&quot; % &quot;sbt-native-packager&quot; % &quot;1.7.3&quot;)</code></div></pre>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">And the <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">GraalVMNativeImagePlugin</code> needs to be enabled:</p>
<pre><div style="color:#f8f8f2;background:#272822;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-java" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">// inside build.sbt
enablePlugins(GraalVMNativeImagePlugin)</code></div></pre>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">From within sbt it should be able to autocomplete and suggest graal-commands, e.g.:</p>
<pre><div style="color:#f8f8f2;background:#272822;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-java" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">sbt:apply-at-vdb&gt; graalvm
graalvm-native-image:       graalvmNativeImageOptions</code></div></pre>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">With that setup, native images are just a stone&#x27;s throw away!</p>
<!-- -->
<h3 class="Text-module__text-default Text-module__u-font-h3">Disclaimer</h3>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">The next three sections are not a write-up but rather the main steps we had to take to make the project work. This includes failing images and troubleshooting.
I want to keep this in because it might be interesting for others when they have to troubleshoot.
For the summary and happy path, you can jump directly to <a href="#roundup" node="[object Object]" style="color:inherit">Roundup</a>.</p>
<!-- -->
<h3 class="Text-module__text-default Text-module__u-font-h3">First try building a native image</h3>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">Next up <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">graalvm-native-image:packageBin</code> can be run from within sbt. This might take a while (on our systems it took about a minute)</p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">Some warnings start to pop up:</p>
<pre><code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">[error] warning: unknown locality of class Lnl/vandebron/applyatvdb/Main$anon$exportedReader$macro$24$1;, assuming class is not local. To remove the warning report an issue to the library or language author. The issue is caused by Lnl/vandebron/applyatvdb/Main$anon$exportedReader$macro$24$1; which is not following the naming convention.

[error] warning: unknown locality of class Lfs2/internal/Algebra$Done$2$;, assuming class is not local. To remove the warning report an issue to the library or language author. The issue is caused by Lfs2/internal/Algebra$Done$2$; which is not following the naming convention.
</code></pre>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">The library-specific warnings can be ignored for now. Ultimately it fails with:</p>
<pre><code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">Error: com.oracle.graal.pointsto.constraints.UnresolvedElementException:
Discovered unresolved type during parsing: org.slf4j.impl.StaticLoggerBinder.
To diagnose the issue you can use the --allow-incomplete-classpath option.
The missing type is then reported at run time when it is accessed the first time.
</code></pre>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">Actually a good hint on where to start fine-tuning the GraalVM config:</p>
<pre><div style="color:#f8f8f2;background:#272822;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-java" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">// inside build.sbt
graalVMNativeImageOptions ++= Seq(
	&quot;--allow-incomplete-classpath&quot;,
)</code></div></pre>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">Some things like a <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">StaticLoggerBinder</code> only get resolved at runtime, meaning at build time the classpath needs to be allowed to be incomplete. This option allows resolution errors to be ignored at build time and only pop up during runtime.</p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">During the build of a native image, GraalVM tries to resolve those runtime dependencies already at compile-time, as it is part of the Ahead-Of-Time-compilation process. With this flag, GraalVM knows &quot;hey, don&#x27;t worry about it now, we cross the bridge when we get there&quot; (or something like that).</p>
<h3 class="Text-module__text-default Text-module__u-font-h3">Adding resource files</h3>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">A <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">reload</code> (or restart) of sbt is needed to activate these new options. And we can try to build the native image up new.
This time the build finished successfully and the executable file <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">target/graalvm-native-image/apply-at-vdb</code> has been created!
This is an executable that can be run without a JVM:</p>
<pre><div style="color:#f8f8f2;background:#272822;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-bash" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">target/graalvm-native-image/apply-at-vdb</code></div></pre>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">But what&#x27;s that? It actually cannot be started...</p>
<pre><div style="color:#f8f8f2;background:#272822;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-bash" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">target/graalvm-native-image/apply-at-vdb

SLF4J: Failed to load class &quot;org.slf4j.impl.StaticLoggerBinder&quot;.
SLF4J: Defaulting to no-operation (NOP) logger implementation
SLF4J: See http://www.slf4j.org/codes.html#StaticLoggerBinder for further details.
*** An error occured! ***
Cannot convert configuration to a de.erewl.pricetracker.server.Config. Failures are:
at the root:
- Key not found: &#x27;host&#x27;.
- Key not found: &#x27;port&#x27;.</code></div></pre>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">The first three lines relate to the error that occurred during the first build. It simply says that logging hasn&#x27;t been set up correctly (maybe due to the absence of a <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">src/main/resources/logback.xml</code> or some other misconfiguration), triggering the default setting of not logging anything at all.
The second error states that a configuration file does not have the right keys or cannot be found at all.
Looking into <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">src/main/resources</code>:</p>
<pre><div style="color:#f8f8f2;background:#272822;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-bash" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">ls src/main/resources/
application.conf logback.xml</code></div></pre>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">and peeking into <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">application.conf</code>:</p>
<pre><div style="color:#f8f8f2;background:#272822;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-bash" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">cat src/main/resources/application.conf
	host = &quot;localhost&quot;
	port = 8080</code></div></pre>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">Hm, so everything is actually in place. But somehow GraalVM can&#x27;t find those files.
It still requires some more GraalVM fine-tuning here.</p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">By default, GraalVM doesn&#x27;t include any resource or configuration-files.
The option <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">-H:ResourceConfigurationFiles=path/to/resource-config.json</code> defines a path to a JSON configuration file. So inside the <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">resource-config.json</code> we can include our <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">application.conf</code> and our <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">logback.xml</code>.</p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">But writing those config files can be tedious and it is difficult in larger projects to find all necessary classes that need to be included. GraalVM provides some support with writing those files and actually does all the work. In the project&#x27;s root directory a configs-folder can be created which will contain all necessary config-files.</p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">For writing the configuration files we will build a normal JAR-file with the help of the <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">sbt-assembly</code> plugin. Adding it to the project like so:</p>
<pre><div style="color:#f8f8f2;background:#272822;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-java" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">  // inside project/plugins.sbt
  addSbtPlugin(&quot;com.eed3si9n&quot; % &quot;sbt-assembly&quot; % &quot;0.14.6&quot;)</code></div></pre>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">The JAR-file will be built with <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">sbt assembly</code>.</p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">With that we can now start the application, providing the path to the JAR-file that just has been created:</p>
<pre><div style="color:#f8f8f2;background:#272822;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-bash" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">mkdir configs
$GRAALHOME/bin/java -agentlib:native-image-agent=config-output-dir=./configs -jar target/scala-2.12/apply-at-vdb-assembly-0.1.0-SNAPSHOT.jar</code></div></pre>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">With the command above the JAR gets to run with GraalVM but adds <a href="https://www.graalvm.org/reference-manual/native-image/Configuration/#assisted-configuration-of-native-image-builds" node="[object Object]" style="color:inherit">dynamic lookups</a> that are being intercepted during runtime and written to the files: <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">jni-config.json</code>, <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">proxy-config.json</code>, <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">reflect-config.json</code> and <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">resource-config.json</code>.</p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">Those generated files can be included in the GraalVMNativeImageOptions:</p>
<pre><div style="color:#f8f8f2;background:#272822;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-java" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">// build.sbt
graalVMNativeImageOptions ++= Seq(
	&quot;--allow-incomplete-classpath&quot;,
	&quot;-H:ResourceConfigurationFiles=../../configs/resource-config.json&quot;,
	&quot;-H:ReflectionConfigurationFiles=../../configs/reflect-config.json&quot;,
	&quot;-H:JNIConfigurationFiles=../../configs/jni-config.json&quot;,
	&quot;-H:DynamicProxyConfigurationFiles=../../configs/proxy-config.json&quot;
)</code></div></pre>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">The build with those updated options should succeed and the app can be run once again:</p>
<pre><div style="color:#f8f8f2;background:#272822;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-bash" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">target/graalvm-native-image/apply-at-vdb

SLF4J: Failed to load class &quot;org.slf4j.impl.StaticLoggerBinder&quot;.
SLF4J: Defaulting to no-operation (NOP) logger implementation
SLF4J: See http://www.slf4j.org/codes.html#StaticLoggerBinder for further details.</code></div></pre>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">Still no logging, sadly. But the server is actually running and responds to POST requests via its exposed endpoint:</p>
<pre><div style="color:#f8f8f2;background:#272822;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-json" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">POST localhost:8080/api/v1/apply

{
	&quot;email&quot;: &quot;my@email.de&quot;,
	&quot;name&quot;: &quot;My Name&quot;,
	&quot;phoneNumber&quot;: &quot;+310123456789&quot;,
	&quot;applicationBase64&quot;: &quot;VGhpcyBjb3VsZCBiZSB5b3VyIGFwcGxpY2F0aW9uIQ==&quot;
}

Response:
&quot;*confetti* Thanks for handing in your application, we will get back to you within the next days! *confetti*&quot;</code></div></pre>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">The next and last step will investigate why logging is not picked up by GraalVM.</p>
<h3 class="Text-module__text-default Text-module__u-font-h3">Investigating the missing logging</h3>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">So first I wanted to have a look if it was an overall issue with logging. I stepped back from using logging-framework and tried the most basic logging with the java-integrated <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">java.util.Logging</code>. GraalVM&#x27;s <a href="https://www.graalvm.org/docs/Native-Image/user/LOGGING" node="[object Object]" style="color:inherit" target="_blank">docs</a> stated that GraalVM supports any logging that depends on that.</p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">Building and running the native-image with <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">java.util.Logging</code> instead of <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">logback</code> succeeded and everything is logged properly.</p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">So it must be something with the dependencies?</p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">For further investigation, I added the <a href="https://github.com/jrudolph/sbt-dependency-graph" node="[object Object]" style="color:inherit" target="_blank">sbt-dependency-graph</a> plugin and checked out the dependency-tree with <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">sbt dependencyBrowserTree</code>. The library <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">logback</code> wasn&#x27;t included in the dependency tree.
Which is odd, since <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">logback</code> is clearly present in the project&#x27;s library-dependencies.</p>
<pre><div style="color:#f8f8f2;background:#272822;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-java" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">// inside build.sbt
libraryDependencies ++= Seq(
	...
	&quot;ch.qos.logback&quot; % &quot;logback-classic&quot; % &quot;1.2.3&quot; % Runtime,
	&quot;ch.qos.logback&quot; % &quot;logback-core&quot; % &quot;1.2.3&quot; % Runtime,
	...
)</code></div></pre>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">Having a closer look, the appendix <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">% Runtime</code> on logback&#x27;s dependency is present.</p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">Not sure where this was coming from but it is most probably blindly copy-pasted from somewhere when gathering the dependencies for this project.</p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]"><a href="https://www.scala-sbt.org/1.x/docs/Scopes.html#Scoping+by+the+configuration+axis" node="[object Object]" style="color:inherit">sbt reference manual</a> states that the appendix <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">Runtime</code> defines that this dependency will be only included in the runtime classpath.</p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">So this explains probably why logging was only working when the server was run from inside sbt.</p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">With removing this and building the native-image, <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">logback</code> appears in the dependency-tree, and logging works when the native image is executed!</p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">This &quot;bug&quot; was interesting as it emphasized what GraalVM can NOT do for you. Dynamic class loading/linking can not be supported by GraalVM as classes and dependencies have to be present during compile time to make a fully functional application.</p>
<h3 class="Text-module__text-default Text-module__u-font-h3">Roundup</h3>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">A successful setup of sbt and GraalVM to build native-images requires to:</p>
<ol style="margin-block-start:0;margin-block-end:30px">
<li class="Text-module__text-default Text-module__u-font-body" style="margin-bottom:0">install GraalVM&#x27;s native-image functionality via it&#x27;s graal-updater:
<pre><div style="color:#f8f8f2;background:#272822;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-bash" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">gu install native-image</code></div></pre>
</li>
<li class="Text-module__text-default Text-module__u-font-body" style="margin-bottom:0">add sbt-native-packager and sbt-assembly to sbt:
<pre><div style="color:#f8f8f2;background:#272822;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-java" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">// inside project/plugins.sbt
addSbtPlugin(&quot;com.typesafe.sbt&quot; % &quot;sbt-native-packager&quot; % &quot;1.7.3&quot;)
addSbtPlugin(&quot;com.eed3si9n&quot; % &quot;sbt-assembly&quot; % &quot;0.14.6&quot;)</code></div></pre>
</li>
<li class="Text-module__text-default Text-module__u-font-body" style="margin-bottom:0">enable the GraalVM-Plugin:
<pre><div style="color:#f8f8f2;background:#272822;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-java" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">// inside build.sbt
enablePlugins(GraalVMNativeImagePlugin)</code></div></pre>
</li>
<li class="Text-module__text-default Text-module__u-font-body" style="margin-bottom:0">create a fat JAR and define which resource and configuration files should be intergated by intercepting look up calls during its execution:
<pre><div style="color:#f8f8f2;background:#272822;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-bash" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">sbt assembly
mkdir configs
$GRAALHOME/bin/java -agentlib:native-image-agent=config-output-dir=./configs -jar target/scala-2.12/apply-at-vdb-assembly-0.1.0-SNAPSHOT.jar</code></div></pre>
</li>
<li class="Text-module__text-default Text-module__u-font-body" style="margin-bottom:0">fine-tune GraalVM with the following options and include the files that have been created in the previous step:
<pre><div style="color:#f8f8f2;background:#272822;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-java" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">// build.sbt
graalVMNativeImageOptions ++= Seq(
  &quot;--allow-incomplete-classpath&quot;,
  &quot;-H:ResourceConfigurationFiles=../../configs/resource-config.json&quot;,
  &quot;-H:ReflectionConfigurationFiles=../../configs/reflect-config.json&quot;,
  &quot;-H:JNIConfigurationFiles=../../configs/jni-config.json&quot;,
  &quot;-H:DynamicProxyConfigurationFiles=../../configs/proxy-config.json&quot;
)</code></div></pre>
</li>
<li class="Text-module__text-default Text-module__u-font-body" style="margin-bottom:0">build the native image with:
<pre><div style="color:#f8f8f2;background:#272822;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-bash" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">sbt graalvm-native-image:packageBin</code></div></pre>
</li>
<li class="Text-module__text-default Text-module__u-font-body" style="margin-bottom:0">run the executable file without the need of java
<pre><code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">./target/graalvm-native-image/apply-at-vdb
</code></pre>
</li>
</ol>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">Even without benchmarking, you notice that the startup time is way faster than with a traditional JAR-file and the application is up and running almost instantly.</p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">It is worth noting that the creation of a native image is a quite time-consuming process. For this project, it took between 1 and 2 minutes. This is, of course, something a CI/CD-Server like Jenkins would take care of but it has to be kept in mind.</p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">With a working native-image, it is time to dockerize.</p>
<h2 class="Text-module__text-default Text-module__u-font-h2">Building Docker images</h2>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">In this section two Docker containers will be built. One, following the &quot;normal&quot;-java way and the other will be using the native-image to build a Docker-container without Java.</p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">Before getting started with native images, a regular JAR-file and Docker image for comparison can be built.</p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">With the <a href="https://github.com/sbt/sbt-assembly" node="[object Object]" style="color:inherit" target="_blank">sbt-assembly</a> plugin you can create JAR-files with all of its dependencies (fat JARs).
<code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">sbt assembly</code> creates this <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">target/scala-2.12/apply-at-vdb-assembly-0.1.0-SNAPSHOT.jar</code> which has a size of around 42MB:</p>
<pre><div style="color:#f8f8f2;background:#272822;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-shell" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"> sbt assembly 
 ls -lh target/scala-2.12/apply-at-vdb-assembly-0.1.0-SNAPSHOT.jar

  ...  ...   42M   target/scala-2.12/apply-at-vdb-assembly-0.1.0-SNAPSHOT.jar</code></div></pre>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">This application can be run locally via <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">java -jar target/scala-2.12/apply-at-vdb-assembly-0.1.0-SNAPSHOT.jar</code> with the prerequisite that Java is installed on that machine.</p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">Creating the Docker image for this JAR-file can be done manually, but luckily <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">sbt-native-package</code> supports building regular Docker images out of the box, only the <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">DockerPlugin</code> needs to be enabled:</p>
<pre><div style="color:#f8f8f2;background:#272822;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-java" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">// build.sbt
enablePlugins(DockerPlugin)</code></div></pre>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]"><code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">sbt docker:publishLocal</code> creates the Docker image <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">apply-at-vdb</code>.</p>
<pre><div style="color:#f8f8f2;background:#272822;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-shell" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">docker images | grep apply-at-vdb
  apply-at-vdb 	0.1.0-SNAPSHOT 		f488d4c06f28 	555MB</code></div></pre>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">A whopping 555MB for a tiny app exposing one endpoint which JAR-file was only 42MB. But to run this JAR-file in a container, this container needs to ship with a JVM, and that&#x27;s where the overhead lies.</p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">With that Docker image and JAR-file as a reference, we can now look into how the native-image operates together with Docker.</p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">GraalVM does not support cross-building, meaning an application cannot be expected to be built in a MacOS environment and run in a Linux environment. It has to be built and run on the same platform. With the help of Docker, the desired built environment can be provided.
The <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">Dockerfile</code> looks as follows:</p>
<pre><div style="color:#f8f8f2;background:#272822;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-docker" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">FROM oracle/graalvm-ce AS builder
WORKDIR /app/vdb
RUN gu install native-image
RUN curl https://bintray.com/sbt/rpm/rpm &gt; bintray-sbt-rpm.repo \
	&amp;&amp; mv bintray-sbt-rpm.repo /etc/yum.repos.d/ \
	&amp;&amp; yum install -y sbt
COPY . /app/vdb
WORKDIR /app/vdb
RUN sbt &quot;graalvm-native-image:packageBin&quot;

FROM oraclelinux:7-slim
COPY --from=builder /app/vdb/target/graalvm-native-image/apply-at-vdb ./app/
CMD ./app/apply-at-vdb
</code></div></pre>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">And can be run with:</p>
<pre><div style="color:#f8f8f2;background:#272822;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-bash" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">docker build -t native-apply-at-vdb .</code></div></pre>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">The Dockerfile describes to do the following:
The first docker container, as the name implies, is the builder. As a base image the official <a href="https://hub.docker.com/r/oracle/graalvm-ce" node="[object Object]" style="color:inherit" target="_blank">GraalVM image</a> is used.</p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">This image needs two more things, GraalVM&#x27;s native-image command, and sbt, and this is what the two follow-up rows are providing. Once that&#x27;s done, the project is copied into this container and the native image is built from within sbt.</p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">The next steps bring the native executable into its own docker container.
As a base image, we use an Oracle Linux image and from our builder-container, we copy the native executable to this new container. The last step is that the app gets run on container startup.</p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]"><code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">docker run -p 8080:8080 -it native-apply-at-vdb</code> starts the container and shows that everything is working just as before.</p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">But what about the image size? Let&#x27;s have a look.</p>
<pre><code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">docker images | grep apply-at-vdb
  native-apply-at-vdb		latest              17b559e78645		199MB
  apply-at-vdb			0.1.0-SNAPSHOT      f488d4c06f28		555MB
</code></pre>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">That is impressive! We created an app that is approx. 2.8 times smaller than our original app.</p>
<h2 class="Text-module__text-default Text-module__u-font-h2">Summary</h2>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">We learned how to set up a Scala project with GraalVM, what steps have to be taken to build a native image with GraalVM, and let it run inside a Docker container. We also received a good overview of what&#x27;s possible with GraalVM and what&#x27;s not.</p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">The initial start and setup of GraalVM with sbt is pretty easy and straightforward. Getting GraalVM to compile an sbt project is nice and simple.</p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">This Hackathon showed us that it is difficult and requires a lot of fine-tuning to integrate GraalVM into an existing project or product. At Vandebron we work with a complex stack of technologies including Spark, Kafka, and Akka which made it difficult to port the findings from this small toy service to one of our existing microservices. This made extensive troubleshooting in the Hackathon not possible.</p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">All in all, GraalVM allows you to give up some Java overhead and create significant smaller Docker images. Sadly, this comes at the cost of giving up dynamic linking and class loading.
A silver lining is, that inside Scala&#x27;s ecosystem this rarely a problem. Scala relies heavily on compile-time mechanisms for detecting bugs early and creating type-safe applications (read <a href="https://blog.softwaremill.com/small-fast-docker-images-using-graalvms-native-image-99c0bc92e70b" node="[object Object]" style="color:inherit" target="_blank">here</a> but also see e.g. <a href="https://typelevel.org/scala/docs/phases.html" node="[object Object]" style="color:inherit" target="_blank">Scala&#x27;s compiler phases</a>).</p>
<!-- -->
<h2 class="Text-module__text-default Text-module__u-font-h2">Sources and Reading</h2>
<ol style="margin-block-start:0;margin-block-end:30px">
<li class="Text-module__text-default Text-module__u-font-body" style="margin-bottom:0"><a href="https://www.inner-product.com/posts/serverless-scala-services-with-graalvm/" node="[object Object]" style="color:inherit" target="_blank">Building Serverless Scala Services with GraalVM</a> by Noel Welsh</li>
<li class="Text-module__text-default Text-module__u-font-body" style="margin-bottom:0"><a href="https://blog.softwaremill.com/small-fast-docker-images-using-graalvms-native-image-99c0bc92e70b" node="[object Object]" style="color:inherit" target="_blank">Small &amp; fast Docker images using GraalVMâs native-image</a> by Adam Warski</li>
<li class="Text-module__text-default Text-module__u-font-body" style="margin-bottom:0"><a href="https://medium.com/rahasak/run-scala-applications-with-graalvm-and-docker-a1e67701e935" node="[object Object]" style="color:inherit" target="_blank">Run Scala applications with GraalVM and Docker</a> by @itseranga</li>
<li class="Text-module__text-default Text-module__u-font-body" style="margin-bottom:0"><a href="https://medium.com/graalvm/getting-started-with-graalvm-for-scala-d0a006dec1d1" node="[object Object]" style="color:inherit" target="_blank">Getting Started with GraalVM and Scala</a> by Oleg Å elajev</li>
<li class="Text-module__text-default Text-module__u-font-body" style="margin-bottom:0"><a href="https://medium.com/graalvm/updates-on-class-initialization-in-graalvm-native-image-generation-c61faca461f7" node="[object Object]" style="color:inherit" target="_blank">Updates on Class Initialization in GraalVM Native Image Generation</a> by</li>
</ol>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">Christian Wimmer</p>
<ol style="margin-block-start:0;margin-block-end:30px">
<li class="Text-module__text-default Text-module__u-font-body" style="margin-bottom:0"><a href="https://www.graalvm.org/reference-manual/" node="[object Object]" style="color:inherit" target="_blank">GraalVM&#x27;s Reference Manuals</a></li>
</ol></div></div></div><footer style="padding-top:30px;padding-bottom:30px;background-color:#363639"><div class="Container-module__container"><div class="Row-module__row Row-module__align-items-center" style="margin-bottom:15px"><div class="Col-module__col-box-sizing Col-module__col"><div><div style="cursor:pointer;user-select:none;display:flex;align-items:baseline"><svg width="140" viewBox="0 0 140 22" xmlns="http://www.w3.org/2000/svg"><path d="M9.569 21.109h-4.25L0 6.274h4.597l2.86 9.249 2.86-9.249h4.598L9.57 21.11m13.234-4.258a3.159 3.159 0 0 1 0-6.316 3.156 3.156 0 0 1 3.144 2.884v.543a3.157 3.157 0 0 1-3.144 2.889m3.2-9.81a7.38 7.38 0 1 0 0 13.3c.136.425.537.73 1.003.73h3.174V6.313h-3.174c-.466 0-.867.304-1.003.728m64.522 3.567a3.155 3.155 0 0 0-3.141 2.888v.542a3.155 3.155 0 0 0 3.14 2.885 3.16 3.16 0 0 0 3.165-3.157 3.163 3.163 0 0 0-3.164-3.158m0 10.536a7.337 7.337 0 0 1-3.195-.727 1.056 1.056 0 0 1-1.006.727h-3.171V0h4.23v7.09a7.377 7.377 0 0 1 10.522 6.676c.001 4.074-3.298 7.378-7.38 7.378m26.406-4.22a3.155 3.155 0 0 1-3.141-2.886v-.542a3.155 3.155 0 0 1 3.141-2.888 3.163 3.163 0 0 1 3.164 3.159 3.161 3.161 0 0 1-3.164 3.156m.012-10.511c-5.054 0-7.481 3.978-7.481 7.356v.025c0 3.402 2.427 7.38 7.48 7.38 5.054 0 7.48-3.978 7.48-7.38 0-3.403-2.426-7.381-7.48-7.381m-60.448 4.196a3.155 3.155 0 0 1 3.141 2.888v.542a3.156 3.156 0 0 1-3.141 2.885 3.16 3.16 0 0 1-3.165-3.157 3.163 3.163 0 0 1 3.165-3.158m0 10.536a7.377 7.377 0 0 1-7.381-7.378A7.377 7.377 0 0 1 59.635 7.09V0h4.23v21.144h-3.17c-.473 0-.866-.303-1.006-.727a7.342 7.342 0 0 1-3.195.727zm51.349-14.856v4.222a3.074 3.074 0 0 0-.244-.013c-1.64 0-3.138 1.057-3.138 2.585v8.025h-4.234V6.276h3.17c.473 0 .867.303 1.006.727a7.353 7.353 0 0 1 3.196-.727c.082 0 .162.01.244.012zm25.525 4.21c-1.467 0-2.348.886-2.348 2.584v8.09h-4.285V6.277h3.172c.472 0 .865.304 1.005.727a7.347 7.347 0 0 1 3.195-.727s1.239-.059 2.514.343c3.027.904 3.379 3.962 3.379 5.599v8.955h-4.284v-8.091c0-.883-.205-2.585-2.348-2.585zm-93.333 0c-1.467 0-2.348.886-2.348 2.584v8.09h-4.284V6.277h3.17c.474 0 .866.304 1.006.727a7.354 7.354 0 0 1 3.196-.727s1.239-.059 2.514.343c3.028.904 3.378 3.962 3.378 5.599v8.955h-4.284v-8.091c0-.883-.204-2.585-2.348-2.585zm36.24 1.755h-5.453c-.116-.003-.55-.055-.325-.637a3.336 3.336 0 0 1 6.134.093c.147.495-.246.541-.356.544m2.55-3.796c-1.308-1.384-3.145-2.214-5.284-2.214-4.254 0-7.324 3.598-7.324 7.5 0 4.15 3.398 7.398 7.399 7.398a6.789 6.789 0 0 0 3.976-1.258c1.183-.806 2.165-2.013 2.844-3.574h-4.278c-.503.73-1.208 1.31-2.542 1.31-1.635 0-3.045-.983-3.22-2.468h10.393c.327-2.566-.202-4.806-1.964-6.694" fill="#ffffff" fill-rule="evenodd"></path></svg>Â <span class="Text-module__text-default Text-module__u-font-h3 Text-module__u-font-color-green" style="font-size:28px;margin:0;line-height:auto">.tech</span></div></div></div></div><div class="Row-module__row Row-module__align-items-center"><div class="Col-module__col-box-sizing Col-module__col"><span class="Text-module__text-default" style="color:white">Â© Vandebron</span></div></div></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"content":"\nAt Vandebron we organize a two-day long Hackathon every quarter, and a colleague and I took this chance to dig into the wonderful world of GraalVM.\n\nI've first heard of GraalVM around two years ago when Oleg Å elajev toured through Java User Groups in Germany and held talks about GraalVM. [Here](https://www.youtube.com/watch?v=GinNxS3OSi0) is one from 2019 (not Germany, but Spain this time).\n\nGraalVM promises a significant speedup in compile times and as I am working with Scala, which is notoriously known for its long compile times, this seems interesting. Furthermore, GraalVM provides functionality to build native executables. Meaning, an application can be run without a Java Virtual Machine (JVM).\n  \nThanks to the Hackathon I finally took the time to get to know GraalVM a bit better. With this blog post, I want to share our findings, experiences, and results, as they might be helpful for you too!\n\n## What is GraalVM?\n\nGraalVM is a high-performance JVM that supports efficient ahead-of-time (AOT) and just-in-time (JIT) compilation, but also allows non-JVM languages (e.g. Ruby, Python, C++) to run on the JVM. The ahead-of-time compilation feature is the base for creating native executable programs, meaning an application can be run independently from the JVM. Seeing the versatile features of GraalVM, it is worth looking a bit under its hood.\n\nActually, GraalVM is defined by three main technologies:\n\n- [Graal compiler](https://www.graalvm.org/reference-manual/jvm/), a high-performance JIT-compiler that can make JVM applications run faster from within the JVM\n- [SubstrateVM](https://www.graalvm.org/reference-manual/native-image/SubstrateVM/), includes the necessary components to run a JVM-app as a native executable ( Garbage Collector, Thread Scheduler, etc.)\n- [Truffle Language Implementation Framework](https://www.graalvm.org/graalvm-as-a-platform/language-implementation-framework/), the basis for the polyglot support from GraalVM\n\nOur motivation for trying out GraalVM was tackling the pain points of Scala, Java projects, and microservices. Shipping microservices written in Scala as Docker containers to your production system comes with the cost that startup can be a bit slow, having JVM and Docker overhead, and that those containers can be fairly large, as the application can only be run with a JVM. See [Building Docker images](#building-docker-images) for more information.\n\nDuring the hackathon, we were most interested in building native images for Scala applications. Hoping to reduce the size of our docker containers and reducing up the startup time.\n\n## Project setup\n\nThe project we worked on during the Hackathon is an API that should be used for applicants to submit their applications at Vandebron in the future. By exposing one endpoint through which a resume and contact information can be submitted.\n\nIt is also a good project to test out GraalVM, nothing too complex but also not as simple as \"Hello World\".\n\nThe full setup can be found [on Github](https://github.com/kgrunert/apply-at-vdb). But I'll summarise the used stack below. The project is built around the following libraries, no particular reason, simply because I like them.\n\n- _cats_ for working with effects, such as IO\n- _http4s_ for running the server\n- _tapir_ for defining the endpoints\n- _circe_ for JSON de/serialisation\n- _pureconfig_ for reading config-files\n- _logback_ for logging\n\nThe project can be run via `sbt run` and with Postman or similar a POST-request can be sent like so:\n\n```json\nPOST localhost:8080/api/v1/apply\n\n{\n\t\"email\": \"my@email.de\",\n\t\"name\": \"My Name\",\n\t\"phoneNumber\": \"+310123456789\",\n\t\"applicationBase64\": \"VGhpcyBjb3VsZCBiZSB5b3VyIGFwcGxpY2F0aW9uIQ==\"\n}\n\nResponse:\n\"*confetti* Thanks for handing in your application, we will get back to you within the next days! *confetti*\"\n```\n\n## Setup GraalVM with sbt\n\nWith this initial project setup in mind, GraalVM needs to be installed locally.\n\nFor the installation of GraalVM the [setup guide](https://www.graalvm.org/docs/getting-started-with-graalvm/#install-graalvm) can be followed.\n\nAfter the installation sbt needs to know that not the regular JDK/JVM is used. This can be done with the `java-home` option on sbt bootup.\nTo make the path to GraalVM a bit more accessible and easy to use it can be exported as an environment variable.\n\n```bash\nexport GRAAL_HOME=/Library/Java/JavaVirtualMachines/graalvm-ce-java8-20.1.0/Contents/Home\nsbt -java-home $GRAALHOME\n```\n\nThe path to GraalVM can vary depending on OS and installation. We followed the basic installation for macOS.\n\nNow sbt using GraalVM can be verified with:\n\n```bash\nsbt -java-home $GRAALHOME\nscala\u003e eval System.getProperty(\"java.home\")\n[info] ans: String = /Library/Java/JavaVirtualMachines/graalvm-ce-java8-20.1.0/Contents/Home/jre\n```\n\nThat means everything running in this sbt instance is getting compiled by GraalVM. Awesome!\n\nThe next step is to become strong and independent and learn how to run without an underlying JVM with the help of building native images.\n\n## Building native images\n\nGraalVM ships with the [GraalVM Updater](https://www.graalvm.org/reference-manual/graalvm-updater/) (`gu`) to install the `native-image` on your machine.\n\n```bash\n$GRAALHOME/bin/gu install native-image\n```\n\n[sbt-native-packager](https://sbt-native-packager.readthedocs.io/en/latest/) provides functionality to build packages efficiently (e.g. building Docker images) and added to that, it also provides support for building native images.\nIn order to build native images with sbt commands this plugin has to be added to the project:\n\n```java scala\n// inside project/plugins.sbt\naddSbtPlugin(\"com.typesafe.sbt\" % \"sbt-native-packager\" % \"1.7.3\")\n```\n\nAnd the `GraalVMNativeImagePlugin` needs to be enabled:\n\n```java scala\n// inside build.sbt\nenablePlugins(GraalVMNativeImagePlugin)\n```\n\nFrom within sbt it should be able to autocomplete and suggest graal-commands, e.g.:\n\n```java scala\nsbt:apply-at-vdb\u003e graalvm\ngraalvm-native-image:       graalvmNativeImageOptions\n```\n\nWith that setup, native images are just a stone's throw away!\n\n---\n\n### Disclaimer\n\nThe next three sections are not a write-up but rather the main steps we had to take to make the project work. This includes failing images and troubleshooting.\nI want to keep this in because it might be interesting for others when they have to troubleshoot.\nFor the summary and happy path, you can jump directly to [Roundup](#roundup).\n\n---\n\n### First try building a native image\n\nNext up `graalvm-native-image:packageBin` can be run from within sbt. This might take a while (on our systems it took about a minute)\n\nSome warnings start to pop up:\n\n```\n[error] warning: unknown locality of class Lnl/vandebron/applyatvdb/Main$anon$exportedReader$macro$24$1;, assuming class is not local. To remove the warning report an issue to the library or language author. The issue is caused by Lnl/vandebron/applyatvdb/Main$anon$exportedReader$macro$24$1; which is not following the naming convention.\n\n[error] warning: unknown locality of class Lfs2/internal/Algebra$Done$2$;, assuming class is not local. To remove the warning report an issue to the library or language author. The issue is caused by Lfs2/internal/Algebra$Done$2$; which is not following the naming convention.\n```\n\nThe library-specific warnings can be ignored for now. Ultimately it fails with:\n\n```\nError: com.oracle.graal.pointsto.constraints.UnresolvedElementException:\nDiscovered unresolved type during parsing: org.slf4j.impl.StaticLoggerBinder.\nTo diagnose the issue you can use the --allow-incomplete-classpath option.\nThe missing type is then reported at run time when it is accessed the first time.\n```\nActually a good hint on where to start fine-tuning the GraalVM config:\n\n```java scala\n// inside build.sbt\ngraalVMNativeImageOptions ++= Seq(\n\t\"--allow-incomplete-classpath\",\n)\n```\n\nSome things like a `StaticLoggerBinder` only get resolved at runtime, meaning at build time the classpath needs to be allowed to be incomplete. This option allows resolution errors to be ignored at build time and only pop up during runtime.\n\nDuring the build of a native image, GraalVM tries to resolve those runtime dependencies already at compile-time, as it is part of the Ahead-Of-Time-compilation process. With this flag, GraalVM knows \"hey, don't worry about it now, we cross the bridge when we get there\" (or something like that).\n\n### Adding resource files\n\nA `reload` (or restart) of sbt is needed to activate these new options. And we can try to build the native image up new.\nThis time the build finished successfully and the executable file `target/graalvm-native-image/apply-at-vdb` has been created!\nThis is an executable that can be run without a JVM:\n\n```bash\ntarget/graalvm-native-image/apply-at-vdb\n```\n\nBut what's that? It actually cannot be started...\n\n```bash\ntarget/graalvm-native-image/apply-at-vdb\n\nSLF4J: Failed to load class \"org.slf4j.impl.StaticLoggerBinder\".\nSLF4J: Defaulting to no-operation (NOP) logger implementation\nSLF4J: See http://www.slf4j.org/codes.html#StaticLoggerBinder for further details.\n*** An error occured! ***\nCannot convert configuration to a de.erewl.pricetracker.server.Config. Failures are:\nat the root:\n- Key not found: 'host'.\n- Key not found: 'port'.\n```\n\nThe first three lines relate to the error that occurred during the first build. It simply says that logging hasn't been set up correctly (maybe due to the absence of a `src/main/resources/logback.xml` or some other misconfiguration), triggering the default setting of not logging anything at all.\nThe second error states that a configuration file does not have the right keys or cannot be found at all.\nLooking into `src/main/resources`:\n\n```bash\nls src/main/resources/\napplication.conf logback.xml\n```\n\nand peeking into `application.conf`:\n\n```bash\ncat src/main/resources/application.conf\n\thost = \"localhost\"\n\tport = 8080\n```\n\nHm, so everything is actually in place. But somehow GraalVM can't find those files.\nIt still requires some more GraalVM fine-tuning here.\n\nBy default, GraalVM doesn't include any resource or configuration-files.\nThe option `-H:ResourceConfigurationFiles=path/to/resource-config.json` defines a path to a JSON configuration file. So inside the `resource-config.json` we can include our `application.conf` and our `logback.xml`.\n\nBut writing those config files can be tedious and it is difficult in larger projects to find all necessary classes that need to be included. GraalVM provides some support with writing those files and actually does all the work. In the project's root directory a configs-folder can be created which will contain all necessary config-files.\n\nFor writing the configuration files we will build a normal JAR-file with the help of the `sbt-assembly` plugin. Adding it to the project like so:\n\n```java scala sbt\n  // inside project/plugins.sbt\n  addSbtPlugin(\"com.eed3si9n\" % \"sbt-assembly\" % \"0.14.6\")\n```\n\nThe JAR-file will be built with `sbt assembly`.\n\nWith that we can now start the application, providing the path to the JAR-file that just has been created:\n\n```bash\nmkdir configs\n$GRAALHOME/bin/java -agentlib:native-image-agent=config-output-dir=./configs -jar target/scala-2.12/apply-at-vdb-assembly-0.1.0-SNAPSHOT.jar\n```\n\nWith the command above the JAR gets to run with GraalVM but adds [dynamic lookups](https://www.graalvm.org/reference-manual/native-image/Configuration/#assisted-configuration-of-native-image-builds) that are being intercepted during runtime and written to the files: `jni-config.json`, `proxy-config.json`, `reflect-config.json` and `resource-config.json`.\n\nThose generated files can be included in the GraalVMNativeImageOptions:\n\n```java scala\n// build.sbt\ngraalVMNativeImageOptions ++= Seq(\n\t\"--allow-incomplete-classpath\",\n\t\"-H:ResourceConfigurationFiles=../../configs/resource-config.json\",\n\t\"-H:ReflectionConfigurationFiles=../../configs/reflect-config.json\",\n\t\"-H:JNIConfigurationFiles=../../configs/jni-config.json\",\n\t\"-H:DynamicProxyConfigurationFiles=../../configs/proxy-config.json\"\n)\n```\n\nThe build with those updated options should succeed and the app can be run once again: \n\n```bash\ntarget/graalvm-native-image/apply-at-vdb\n\nSLF4J: Failed to load class \"org.slf4j.impl.StaticLoggerBinder\".\nSLF4J: Defaulting to no-operation (NOP) logger implementation\nSLF4J: See http://www.slf4j.org/codes.html#StaticLoggerBinder for further details.\n```\n\nStill no logging, sadly. But the server is actually running and responds to POST requests via its exposed endpoint:\n\n```json\nPOST localhost:8080/api/v1/apply\n\n{\n\t\"email\": \"my@email.de\",\n\t\"name\": \"My Name\",\n\t\"phoneNumber\": \"+310123456789\",\n\t\"applicationBase64\": \"VGhpcyBjb3VsZCBiZSB5b3VyIGFwcGxpY2F0aW9uIQ==\"\n}\n\nResponse:\n\"*confetti* Thanks for handing in your application, we will get back to you within the next days! *confetti*\"\n```\n\nThe next and last step will investigate why logging is not picked up by GraalVM.\n\n### Investigating the missing logging\n\nSo first I wanted to have a look if it was an overall issue with logging. I stepped back from using logging-framework and tried the most basic logging with the java-integrated `java.util.Logging`. GraalVM's [docs](https://www.graalvm.org/docs/Native-Image/user/LOGGING) stated that GraalVM supports any logging that depends on that.\n\nBuilding and running the native-image with `java.util.Logging` instead of `logback` succeeded and everything is logged properly.\n\nSo it must be something with the dependencies?\n\nFor further investigation, I added the [sbt-dependency-graph](https://github.com/jrudolph/sbt-dependency-graph) plugin and checked out the dependency-tree with `sbt dependencyBrowserTree`. The library `logback` wasn't included in the dependency tree.\nWhich is odd, since `logback` is clearly present in the project's library-dependencies.\n\n```java scala\n// inside build.sbt\nlibraryDependencies ++= Seq(\n\t...\n\t\"ch.qos.logback\" % \"logback-classic\" % \"1.2.3\" % Runtime,\n\t\"ch.qos.logback\" % \"logback-core\" % \"1.2.3\" % Runtime,\n\t...\n)\n```\n\nHaving a closer look, the appendix `% Runtime` on logback's dependency is present.\n\nNot sure where this was coming from but it is most probably blindly copy-pasted from somewhere when gathering the dependencies for this project.\n\n[sbt reference manual](https://www.scala-sbt.org/1.x/docs/Scopes.html#Scoping+by+the+configuration+axis) states that the appendix `Runtime` defines that this dependency will be only included in the runtime classpath.\n\nSo this explains probably why logging was only working when the server was run from inside sbt.\n\nWith removing this and building the native-image, `logback` appears in the dependency-tree, and logging works when the native image is executed!\n\nThis \"bug\" was interesting as it emphasized what GraalVM can NOT do for you. Dynamic class loading/linking can not be supported by GraalVM as classes and dependencies have to be present during compile time to make a fully functional application. \n\n### Roundup\n\nA successful setup of sbt and GraalVM to build native-images requires to:\n\n- install GraalVM's native-image functionality via it's graal-updater: \n  ```bash\n  gu install native-image\n  ```\n- add sbt-native-packager and sbt-assembly to sbt:\n  ```java scala sbt\n  // inside project/plugins.sbt\n  addSbtPlugin(\"com.typesafe.sbt\" % \"sbt-native-packager\" % \"1.7.3\")\n  addSbtPlugin(\"com.eed3si9n\" % \"sbt-assembly\" % \"0.14.6\")\n  ```\n- enable the GraalVM-Plugin:\n  ```java scala sbt\n  // inside build.sbt\n  enablePlugins(GraalVMNativeImagePlugin)\n  ```\n- create a fat JAR and define which resource and configuration files should be intergated by intercepting look up calls during its execution:\n  ```bash\n  sbt assembly\n  mkdir configs\n  $GRAALHOME/bin/java -agentlib:native-image-agent=config-output-dir=./configs -jar target/scala-2.12/apply-at-vdb-assembly-0.1.0-SNAPSHOT.jar\n  ```\n- fine-tune GraalVM with the following options and include the files that have been created in the previous step:\n  ```java scala\n  // build.sbt\n  graalVMNativeImageOptions ++= Seq(\n    \"--allow-incomplete-classpath\",\n    \"-H:ResourceConfigurationFiles=../../configs/resource-config.json\",\n    \"-H:ReflectionConfigurationFiles=../../configs/reflect-config.json\",\n    \"-H:JNIConfigurationFiles=../../configs/jni-config.json\",\n    \"-H:DynamicProxyConfigurationFiles=../../configs/proxy-config.json\"\n  )\n  ```\n- build the native image with:\n  ```bash\n  sbt graalvm-native-image:packageBin\n  ```\n- run the executable file without the need of java\n  ```\n  ./target/graalvm-native-image/apply-at-vdb\n  ```\n\nEven without benchmarking, you notice that the startup time is way faster than with a traditional JAR-file and the application is up and running almost instantly.\n\nIt is worth noting that the creation of a native image is a quite time-consuming process. For this project, it took between 1 and 2 minutes. This is, of course, something a CI/CD-Server like Jenkins would take care of but it has to be kept in mind. \n\nWith a working native-image, it is time to dockerize.\n\n## Building Docker images\n\nIn this section two Docker containers will be built. One, following the \"normal\"-java way and the other will be using the native-image to build a Docker-container without Java.\n\nBefore getting started with native images, a regular JAR-file and Docker image for comparison can be built.\n\nWith the [sbt-assembly](https://github.com/sbt/sbt-assembly) plugin you can create JAR-files with all of its dependencies (fat JARs).\n`sbt assembly` creates this `target/scala-2.12/apply-at-vdb-assembly-0.1.0-SNAPSHOT.jar` which has a size of around 42MB:\n\n```shell\n sbt assembly \n ls -lh target/scala-2.12/apply-at-vdb-assembly-0.1.0-SNAPSHOT.jar\n\n  ...  ...   42M   target/scala-2.12/apply-at-vdb-assembly-0.1.0-SNAPSHOT.jar\n```\n\nThis application can be run locally via `java -jar target/scala-2.12/apply-at-vdb-assembly-0.1.0-SNAPSHOT.jar` with the prerequisite that Java is installed on that machine.\n\nCreating the Docker image for this JAR-file can be done manually, but luckily `sbt-native-package` supports building regular Docker images out of the box, only the `DockerPlugin` needs to be enabled:\n\n```java scala\n// build.sbt\nenablePlugins(DockerPlugin)\n```\n\n`sbt docker:publishLocal` creates the Docker image `apply-at-vdb`.\n \n```shell\ndocker images | grep apply-at-vdb\n  apply-at-vdb \t0.1.0-SNAPSHOT \t\tf488d4c06f28 \t555MB\n```\n\nA whopping 555MB for a tiny app exposing one endpoint which JAR-file was only 42MB. But to run this JAR-file in a container, this container needs to ship with a JVM, and that's where the overhead lies.\n\nWith that Docker image and JAR-file as a reference, we can now look into how the native-image operates together with Docker.\n\nGraalVM does not support cross-building, meaning an application cannot be expected to be built in a MacOS environment and run in a Linux environment. It has to be built and run on the same platform. With the help of Docker, the desired built environment can be provided.\nThe `Dockerfile` looks as follows:\n```docker\nFROM oracle/graalvm-ce AS builder\nWORKDIR /app/vdb\nRUN gu install native-image\nRUN curl https://bintray.com/sbt/rpm/rpm \u003e bintray-sbt-rpm.repo \\\n\t\u0026\u0026 mv bintray-sbt-rpm.repo /etc/yum.repos.d/ \\\n\t\u0026\u0026 yum install -y sbt\nCOPY . /app/vdb\nWORKDIR /app/vdb\nRUN sbt \"graalvm-native-image:packageBin\"\n\nFROM oraclelinux:7-slim\nCOPY --from=builder /app/vdb/target/graalvm-native-image/apply-at-vdb ./app/\nCMD ./app/apply-at-vdb\n\n```\n\nAnd can be run with:\n```bash\ndocker build -t native-apply-at-vdb .\n```\nThe Dockerfile describes to do the following:\nThe first docker container, as the name implies, is the builder. As a base image the official [GraalVM image](https://hub.docker.com/r/oracle/graalvm-ce) is used. \n\nThis image needs two more things, GraalVM's native-image command, and sbt, and this is what the two follow-up rows are providing. Once that's done, the project is copied into this container and the native image is built from within sbt.\n\nThe next steps bring the native executable into its own docker container.\nAs a base image, we use an Oracle Linux image and from our builder-container, we copy the native executable to this new container. The last step is that the app gets run on container startup.\n\n`docker run -p 8080:8080 -it native-apply-at-vdb` starts the container and shows that everything is working just as before.\n\nBut what about the image size? Let's have a look.\n```\ndocker images | grep apply-at-vdb\n  native-apply-at-vdb\t\tlatest              17b559e78645\t\t199MB\n  apply-at-vdb\t\t\t0.1.0-SNAPSHOT      f488d4c06f28\t\t555MB\n```\nThat is impressive! We created an app that is approx. 2.8 times smaller than our original app.\n\n## Summary\n\nWe learned how to set up a Scala project with GraalVM, what steps have to be taken to build a native image with GraalVM, and let it run inside a Docker container. We also received a good overview of what's possible with GraalVM and what's not.\n\nThe initial start and setup of GraalVM with sbt is pretty easy and straightforward. Getting GraalVM to compile an sbt project is nice and simple. \n\nThis Hackathon showed us that it is difficult and requires a lot of fine-tuning to integrate GraalVM into an existing project or product. At Vandebron we work with a complex stack of technologies including Spark, Kafka, and Akka which made it difficult to port the findings from this small toy service to one of our existing microservices. This made extensive troubleshooting in the Hackathon not possible.\n\nAll in all, GraalVM allows you to give up some Java overhead and create significant smaller Docker images. Sadly, this comes at the cost of giving up dynamic linking and class loading. \nA silver lining is, that inside Scala's ecosystem this rarely a problem. Scala relies heavily on compile-time mechanisms for detecting bugs early and creating type-safe applications (read [here](https://blog.softwaremill.com/small-fast-docker-images-using-graalvms-native-image-99c0bc92e70b) but also see e.g. [Scala's compiler phases](https://typelevel.org/scala/docs/phases.html)).\n\n* * *\n\n## Sources and Reading\n- [Building Serverless Scala Services with GraalVM](https://www.inner-product.com/posts/serverless-scala-services-with-graalvm/) by Noel Welsh\n- [Small \u0026 fast Docker images using GraalVMâs native-image](https://blog.softwaremill.com/small-fast-docker-images-using-graalvms-native-image-99c0bc92e70b) by Adam Warski\n- [Run Scala applications with GraalVM and Docker](https://medium.com/rahasak/run-scala-applications-with-graalvm-and-docker-a1e67701e935) by @itseranga\n- [Getting Started with GraalVM and Scala](https://medium.com/graalvm/getting-started-with-graalvm-for-scala-d0a006dec1d1) by Oleg Å elajev\n- [Updates on Class Initialization in GraalVM Native Image Generation](https://medium.com/graalvm/updates-on-class-initialization-in-graalvm-native-image-generation-c61faca461f7) by \nChristian Wimmer\n- [GraalVM's Reference Manuals](https://www.graalvm.org/reference-manual/)\n","meta":{"title":"Building native images and compiling with GraalVM and sbt","description":"At Vandebron we organized a two-day long Hackathon, a colleague and I took the chance to dig into the wonderful world of GraalVM.","createdAt":"Tue Oct 06 2020 00:00:00 GMT+0000 (Coordinated Universal Time)","coverImage":"images/building-native-images-and-compiling-with-graalvm-and-sbt.jpg","imageSource":"https://pixabay.com/users/lumix2004-3890388/","tags":"graalvm, scala","author":"Katrin Grunert","slug":"blog/building-native-images-and-compiling-with-graalvm-and-sbt","formattedDate":"6 oktober 2020","date":"Tue Oct 06 2020 00:00:00 GMT+0000 (Coordinated Universal Time)"}}},"__N_SSG":true},"page":"/blog/[slug]","query":{"slug":"building-native-images-and-compiling-with-graalvm-and-sbt"},"buildId":"6cUQ4BkK5pTrUDSj0Cav3","assetPrefix":"/pr-preview/pr-49","isFallback":false,"gsp":true}</script><script nomodule="" src="/pr-preview/pr-49/_next/static/chunks/polyfills-28654a8145d7603786fc.js"></script><script src="/pr-preview/pr-49/_next/static/chunks/webpack-0b9cc56c94819e8023ea.js" async=""></script><script src="/pr-preview/pr-49/_next/static/chunks/framework.87b9127d6cd191ae1c9a.js" async=""></script><script src="/pr-preview/pr-49/_next/static/chunks/3ef630e34cd10ba68f9d468ac363ff81c534e1e9.1bafdc53d1881d09197f.js" async=""></script><script src="/pr-preview/pr-49/_next/static/chunks/main-419ac17f185f95278b96.js" async=""></script><script src="/pr-preview/pr-49/_next/static/chunks/7b9503d2.4af90216c47085b5c8e9.js" async=""></script><script src="/pr-preview/pr-49/_next/static/chunks/0f4fa802.a83a6a4548b93404854d.js" async=""></script><script src="/pr-preview/pr-49/_next/static/chunks/226daff62b2d4bc1e9a7210a7f6000a544319a74.fbdd4d016a5c47ddc9db.js" async=""></script><script src="/pr-preview/pr-49/_next/static/chunks/pages/_app-39339a87bd082502c1e2.js" async=""></script><script src="/pr-preview/pr-49/_next/static/chunks/1c49f5f00355f650bee3d37484f094be037a30fa.0c099ecf2acefc71ba39.js" async=""></script><script src="/pr-preview/pr-49/_next/static/chunks/pages/blog/%5Bslug%5D-ff8f9ea31e126f437ccb.js" async=""></script><script src="/pr-preview/pr-49/_next/static/6cUQ4BkK5pTrUDSj0Cav3/_buildManifest.js" async=""></script><script src="/pr-preview/pr-49/_next/static/6cUQ4BkK5pTrUDSj0Cav3/_ssgManifest.js" async=""></script></body></html>