<!DOCTYPE html><html lang="en"><head><script async="" src="https://www.google-analytics.com/analytics.js"></script><link rel="stylesheet" href="https://d381m57et8llfk.cloudfront.net/20210128-6054/static/css/dc7f55cf12b36887a247.fonts.css"/><script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
                ga('create', 'UA-49472651-19', { 'storage': 'none' });
                ga('send', 'pageview');</script><script src="https://unpkg.com/react-bootstrap@next/dist/react-bootstrap.min.js"></script><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>The Why and How of Dagster User Code Deployment Automation</title><meta name="Description" content="If you frequently deploy new user code repositories in Dagster, you want to automate this process. However, this is not so straightforward as it may seem at first. This post explains what we did at Vandebron."/><meta property="og:title" content="The Why and How of Dagster User Code Deployment Automation"/><meta property="og:description" content="If you frequently deploy new user code repositories in Dagster, you want to automate this process. However, this is not so straightforward as it may seem at first. This post explains what we did at Vandebron."/><meta property="og:image" content="https://www.vandebron.tech/images/dagster-cicd.png"/><meta name="next-head-count" content="7"/><link rel="preload" href="/pr-preview/pr-32/_next/static/css/4a1dced57a4830ecbfc4.css" as="style"/><link rel="stylesheet" href="/pr-preview/pr-32/_next/static/css/4a1dced57a4830ecbfc4.css" data-n-g=""/><link rel="preload" href="/pr-preview/pr-32/_next/static/css/f6fb2f3746aefe1fbc80.css" as="style"/><link rel="stylesheet" href="/pr-preview/pr-32/_next/static/css/f6fb2f3746aefe1fbc80.css" data-n-g=""/><noscript data-n-css=""></noscript><link rel="preload" href="/pr-preview/pr-32/_next/static/chunks/webpack-0b9cc56c94819e8023ea.js" as="script"/><link rel="preload" href="/pr-preview/pr-32/_next/static/chunks/framework.87b9127d6cd191ae1c9a.js" as="script"/><link rel="preload" href="/pr-preview/pr-32/_next/static/chunks/3ef630e34cd10ba68f9d468ac363ff81c534e1e9.e40f9d29fe57d3935de1.js" as="script"/><link rel="preload" href="/pr-preview/pr-32/_next/static/chunks/main-419ac17f185f95278b96.js" as="script"/><link rel="preload" href="/pr-preview/pr-32/_next/static/chunks/7b9503d2.4af90216c47085b5c8e9.js" as="script"/><link rel="preload" href="/pr-preview/pr-32/_next/static/chunks/51307659.a83a6a4548b93404854d.js" as="script"/><link rel="preload" href="/pr-preview/pr-32/_next/static/chunks/226daff62b2d4bc1e9a7210a7f6000a544319a74.fbdd4d016a5c47ddc9db.js" as="script"/><link rel="preload" href="/pr-preview/pr-32/_next/static/chunks/pages/_app-1d36213f3e6ce80d1278.js" as="script"/><link rel="preload" href="/pr-preview/pr-32/_next/static/chunks/1c49f5f00355f650bee3d37484f094be037a30fa.0c099ecf2acefc71ba39.js" as="script"/><link rel="preload" href="/pr-preview/pr-32/_next/static/chunks/pages/blog/%5Bslug%5D-b9610da0b3e709e6b9cf.js" as="script"/></head><body><div id="__next"><div class="Container-module__container" as="header" style="padding-top:30px;padding-bottom:30px;margin-bottom:30px"><div class="Row-module__row Row-module__align-items-center Row-module__justify-content-between"><div class="Col-module__col-box-sizing Col-module__col Col-module__col-12 Col-module__col-md-auto Col-module__col-lg-auto Col-module__col-sm-12"><div><div style="cursor:pointer;user-select:none;display:flex;align-items:baseline"><svg width="140" viewBox="0 0 140 22" xmlns="http://www.w3.org/2000/svg"><path d="M9.569 21.109h-4.25L0 6.274h4.597l2.86 9.249 2.86-9.249h4.598L9.57 21.11m13.234-4.258a3.159 3.159 0 0 1 0-6.316 3.156 3.156 0 0 1 3.144 2.884v.543a3.157 3.157 0 0 1-3.144 2.889m3.2-9.81a7.38 7.38 0 1 0 0 13.3c.136.425.537.73 1.003.73h3.174V6.313h-3.174c-.466 0-.867.304-1.003.728m64.522 3.567a3.155 3.155 0 0 0-3.141 2.888v.542a3.155 3.155 0 0 0 3.14 2.885 3.16 3.16 0 0 0 3.165-3.157 3.163 3.163 0 0 0-3.164-3.158m0 10.536a7.337 7.337 0 0 1-3.195-.727 1.056 1.056 0 0 1-1.006.727h-3.171V0h4.23v7.09a7.377 7.377 0 0 1 10.522 6.676c.001 4.074-3.298 7.378-7.38 7.378m26.406-4.22a3.155 3.155 0 0 1-3.141-2.886v-.542a3.155 3.155 0 0 1 3.141-2.888 3.163 3.163 0 0 1 3.164 3.159 3.161 3.161 0 0 1-3.164 3.156m.012-10.511c-5.054 0-7.481 3.978-7.481 7.356v.025c0 3.402 2.427 7.38 7.48 7.38 5.054 0 7.48-3.978 7.48-7.38 0-3.403-2.426-7.381-7.48-7.381m-60.448 4.196a3.155 3.155 0 0 1 3.141 2.888v.542a3.156 3.156 0 0 1-3.141 2.885 3.16 3.16 0 0 1-3.165-3.157 3.163 3.163 0 0 1 3.165-3.158m0 10.536a7.377 7.377 0 0 1-7.381-7.378A7.377 7.377 0 0 1 59.635 7.09V0h4.23v21.144h-3.17c-.473 0-.866-.303-1.006-.727a7.342 7.342 0 0 1-3.195.727zm51.349-14.856v4.222a3.074 3.074 0 0 0-.244-.013c-1.64 0-3.138 1.057-3.138 2.585v8.025h-4.234V6.276h3.17c.473 0 .867.303 1.006.727a7.353 7.353 0 0 1 3.196-.727c.082 0 .162.01.244.012zm25.525 4.21c-1.467 0-2.348.886-2.348 2.584v8.09h-4.285V6.277h3.172c.472 0 .865.304 1.005.727a7.347 7.347 0 0 1 3.195-.727s1.239-.059 2.514.343c3.027.904 3.379 3.962 3.379 5.599v8.955h-4.284v-8.091c0-.883-.205-2.585-2.348-2.585zm-93.333 0c-1.467 0-2.348.886-2.348 2.584v8.09h-4.284V6.277h3.17c.474 0 .866.304 1.006.727a7.354 7.354 0 0 1 3.196-.727s1.239-.059 2.514.343c3.028.904 3.378 3.962 3.378 5.599v8.955h-4.284v-8.091c0-.883-.204-2.585-2.348-2.585zm36.24 1.755h-5.453c-.116-.003-.55-.055-.325-.637a3.336 3.336 0 0 1 6.134.093c.147.495-.246.541-.356.544m2.55-3.796c-1.308-1.384-3.145-2.214-5.284-2.214-4.254 0-7.324 3.598-7.324 7.5 0 4.15 3.398 7.398 7.399 7.398a6.789 6.789 0 0 0 3.976-1.258c1.183-.806 2.165-2.013 2.844-3.574h-4.278c-.503.73-1.208 1.31-2.542 1.31-1.635 0-3.045-.983-3.22-2.468h10.393c.327-2.566-.202-4.806-1.964-6.694" fill="#333D47" fill-rule="evenodd"></path></svg> <span class="Text-module__text-default Text-module__u-font-h3 Text-module__u-font-color-green" style="font-size:28px;margin:0;line-height:auto">.tech</span></div></div></div><div class="Col-module__col-box-sizing Col-module__col Col-module__col-12 Col-module__col-md-auto Col-module__col-lg-auto Col-module__col-sm-12"><div class="Flex-module__d-flex Flex-module__flex-row Flex-module__align-items-stretch Flex-module__justify-content-start Flex-module__justify-content-sm-between"><ul class="Navigation-module__navigation-wrapper" id="styled-navigation" style="margin-right:25px"><li class="Navigation-module__navigation-link-wrapper"><a class="Pressable-module__button Pressable-module__text Navigation-module__navigation-link Navigation-module__navigation-link-active" name="Home" url="/"><span>Home</span></a></li><li class="Navigation-module__navigation-link-wrapper"><a class="Pressable-module__button Pressable-module__text Navigation-module__navigation-link" name="About" url="/about"><span>About</span></a></li><li class="Navigation-module__navigation-link-wrapper"><a class="Pressable-module__button Pressable-module__text Navigation-module__navigation-link" name="vandebron.nl" url="https://vandebron.nl"><span>vandebron.nl</span></a></li><div class="Navigation-module__navigation-magic-line" style="transition:none;left:0;width:0"></div></ul><div><a class="Pressable-module__button Pressable-module__text" href="https://github.com/vandebron/" target="_blank" rel="noreferrer" style="margin-right:10px"><svg role="img" viewBox="0 0 24 24" width="1em" height="1em" class="Icon-module__icon Icon-module__u-font-color-charcoal-gray" style="font-size:150%"><title>GitHub icon</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path></svg><span class="visually-hidden">Vandebron on Github</span></a><a class="Pressable-module__button Pressable-module__text" href="https://dev.to/vandebron/" target="_blank" rel="noreferrer" style="margin-right:10px"><svg viewBox="0 0 448 512" width="1em" height="1em" class="Icon-module__icon Icon-module__u-font-color-charcoal-gray" style="font-size:150%"><path fill="currentColor" d="M120.12 208.29c-3.88-2.9-7.77-4.35-11.65-4.35H91.03v104.47h17.45c3.88 0 7.77-1.45 11.65-4.35 3.88-2.9 5.82-7.25 5.82-13.06v-69.65c-.01-5.8-1.96-10.16-5.83-13.06zM404.1 32H43.9C19.7 32 .06 51.59 0 75.8v360.4C.06 460.41 19.7 480 43.9 480h360.2c24.21 0 43.84-19.59 43.9-43.8V75.8c-.06-24.21-19.7-43.8-43.9-43.8zM154.2 291.19c0 18.81-11.61 47.31-48.36 47.25h-46.4V172.98h47.38c35.44 0 47.36 28.46 47.37 47.28l.01 70.93zm100.68-88.66H201.6v38.42h32.57v29.57H201.6v38.41h53.29v29.57h-62.18c-11.16.29-20.44-8.53-20.72-19.69V193.7c-.27-11.15 8.56-20.41 19.71-20.69h63.19l-.01 29.52zm103.64 115.29c-13.2 30.75-36.85 24.63-47.44 0l-38.53-144.8h32.57l29.71 113.72 29.57-113.72h32.58l-38.46 144.8z"></path></svg><span class="visually-hidden">Vandebron on Dev.to</span></a><a class="Pressable-module__button Pressable-module__text" href="https://medium.com/vandebron/" target="_blank" rel="noreferrer"><svg viewBox="0 0 448 512" width="1em" height="1em" class="Icon-module__icon Icon-module__u-font-color-charcoal-gray" style="font-size:150%"><path fill="currentColor" d="M0 32v448h448V32H0zm372.2 106.1l-24 23c-2.1 1.6-3.1 4.2-2.7 6.7v169.3c-.4 2.6.6 5.2 2.7 6.7l23.5 23v5.1h-118V367l24.3-23.6c2.4-2.4 2.4-3.1 2.4-6.7V199.8l-67.6 171.6h-9.1L125 199.8v115c-.7 4.8 1 9.7 4.4 13.2l31.6 38.3v5.1H71.2v-5.1l31.6-38.3c3.4-3.5 4.9-8.4 4.1-13.2v-133c.4-3.7-1-7.3-3.8-9.8L75 138.1V133h87.3l67.4 148L289 133.1h83.2v5z"></path></svg><span class="visually-hidden">Vandebron on Medium</span></a></div></div></div></div></div><div class="Container-module__container"><div class="Row-module__row"><div class="Col-module__col-box-sizing Col-module__col Col-module__col-12"><h2 class="Text-module__text-default Text-module__u-font-h2">The Why and How of Dagster User Code Deployment Automation</h2></div><div class="Col-module__col-box-sizing Col-module__col Col-module__col-12"><p class="Text-module__text-default Text-module__u-font-body"><span class="Text-module__text-default">By Pieter Custers on 8 juli 2022</span></p></div></div><div class="Row-module__row"><div class="Col-module__col-box-sizing Col-module__col Col-module__col-12"><p class="Text-module__text-default Text-module__u-font-body"><div class="Image-module__image-container" style="padding-bottom:50%"><div style="height:200px" class="lazyload-placeholder"></div></div></p></div></div><div class="Row-module__row" style="margin-bottom:60px"><div class="Col-module__col-box-sizing Col-module__col Col-module__col-12"><h3 class="Text-module__text-default Text-module__u-font-h3">TL;DR</h3>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">If you want to deploy new Dagster user code respositories, you need to modify and redeploy the whole Dagster system (while they are <a href="https://docs.dagster.io/deployment/guides/kubernetes/customizing-your-deployment#separately-deploying-dagster-infrastructure-and-user-code" node="[object Object]" style="color:inherit">presented as separate</a> in the docs). This is undesirable for many reasons, most notably because it slows down a migration or the regular development process. This post presents a way to avoid this and build a fully automated CI/CD-pipeline for (new) user code.</p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">This article assumes that:</p>
<ol style="margin-block-start:0;margin-block-end:30px">
<li class="Text-module__text-default Text-module__u-font-body" style="margin-bottom:0">you (plan to) host Dagster on Kubernetes and manage its deployment with Helm and Ansible;</li>
<li class="Text-module__text-default Text-module__u-font-body" style="margin-bottom:0">you want to automate the deployment of new Dagster user code repositories with a CI/CD pipeline automation tool of choice;</li>
<li class="Text-module__text-default Text-module__u-font-body" style="margin-bottom:0">and you want to be able to (re)deploy the whole Dagster system and user code from scratch.</li>
</ol>
<h3 class="Text-module__text-default Text-module__u-font-h3">Why Dagster?</h3>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">In short Dagster is a tool to build and orchestrate complex data applications in Python. For us, in the end, Dagster improved the development cycle for things like simple cron jobs as well as for complex ML pipelines. Testing the flows locally was never so easy, for instance. And with features like <a href="https://docs.dagster.io/concepts/assets/asset-materializations" node="[object Object]" style="color:inherit" target="_blank">asset materialization</a> and <a href="https://docs.dagster.io/concepts/partitions-schedules-sensors/sensors" node="[object Object]" style="color:inherit" target="_blank">sensors</a>, we can trigger downstream jobs based on the change of an external state that an upstream job caused, without these jobs having to know of each other&#x27;s existence.</p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">However, deployment of new <a href="https://docs.dagster.io/concepts/repositories-workspaces/repositories" node="[object Object]" style="color:inherit" target="_blank">user code respositories</a> caused us some CI/CD related headaches...</p>
<h3 class="Text-module__text-default Text-module__u-font-h3">System and user code are separated</h3>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">Dagster separates the system deployment - the Dagit (UI) web server and the daemons that coordinate the runs - from the user code deployment - the actual data pipeline. In other words: the user code servers run in complete isolation from the system and each other.</p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">This is a great feature of which the advantages are obvious: user code repositories have their own Python environment, teams can manage these separately, and if a user code server breaks down the system is not impacted. In fact, it even doesn&#x27;t require a restart when user code is updated!</p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]"><img src="/images/dagster-architecture.png" alt="Schematic of the Dagster architecture. The user code repositories (green) are separate from the rest of the system (yellow and blue). The right side — irrelevant for now — shows the job runs. Source: https://docs.dagster.io/deployment/overview." style="width:100%" node="[object Object]"/></p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">In Helm terms: there are 2 charts, namely the <em>system</em>: <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">dagster/dagster</code> (<a href="https://github.com/dagster-io/dagster/blob/master/helm/dagster/values.yaml" node="[object Object]" style="color:inherit" target="_blank">values.yaml</a>), and the <em>user code</em>: <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">dagster/dagster-user-deployments</code> (<a href="https://github.com/dagster-io/dagster/blob/master/helm/dagster/charts/dagster-user-deployments/values.yaml" node="[object Object]" style="color:inherit" target="_blank">values.yaml</a>). Note that you have to set <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">dagster-user-deployments.enabled: true</code> in the <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">dagster/dagster</code> values-yaml to enable this.</p>
<h4 class="Text-module__text-default Text-module__u-font-h4">Or are they?</h4>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">That having said, you might find it peculiar that in the values-yaml of the system deployment, <em>you need to specify the user code servers</em>. That looks like this:</p>
<pre><div style="color:#f8f8f2;background:#272822;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-yaml" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">workspace:
    enabled: true
    servers:
      - host: &quot;k8s-example-user-code-1&quot;
        port: 3030
        name: &quot;user-code-example&quot;</code></div></pre>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]"><strong>This means system and user deployments are not actually completely separated!</strong></p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">This implies that, if you want to add a <em>new</em> user code repository, not only do you need to:</p>
<ol style="margin-block-start:0;margin-block-end:30px">
<li class="Text-module__text-default Text-module__u-font-body" style="margin-bottom:0">add the repo to the user code&#x27;s <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">values.yaml</code> (via a PR in the Git repo of your company&#x27;s platform team, probably);</li>
<li class="Text-module__text-default Text-module__u-font-body" style="margin-bottom:0">do a helm-upgrade of the corresponding <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">dagster/dagster-user-deployments</code> chart;</li>
</ol>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">but because of the not-so-separation, you still need to:</p>
<ol style="margin-block-start:0;margin-block-end:30px">
<li class="Text-module__text-default Text-module__u-font-body" style="margin-bottom:0">add the user code server to the system&#x27;s <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">values.yaml</code> (via that same PR);</li>
<li class="Text-module__text-default Text-module__u-font-body" style="margin-bottom:0">and do a helm-upgrade of the corresponding <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">dagster/dagster</code> chart.</li>
</ol>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">Formally this is the process to go through. If you are fine with this, stop reading here. It&#x27;s the cleanest solution anyway. But it is quite cumbersome, so...</p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">If you are in a situation in which new repositories can get added multiple times a day - for instance because you are in the middle of a migration to Dagster, or you want a staging environment for every single PR - then read on.</p>
<h4 class="Text-module__text-default Text-module__u-font-h4">Give me more details</h4>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">How it works is that <a href="https://docs.dagster.io/deployment/guides/kubernetes/deploying-with-helm#user-code-deployment" node="[object Object]" style="color:inherit">for every new repo Dagster spins up a (gRPC) server to host the user code</a>. The separation is clear here. But the Dagster <em>system</em> also needs to know about these user code servers, and it does so through a workspace-yaml file. If you run Dagit locally it relies on a <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">workspace.yaml</code> file; on Kubernetes it relies on a <a href="https://kubernetes.io/docs/concepts/configuration/configmap/" node="[object Object]" style="color:inherit" target="_blank">ConfigMap</a> - a Kubernetes object used to store non-confidential data in key-value pairs, e.g. the content of a file - which they named <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">dagster-workspace-yaml</code>.</p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">This workspace-yaml is the connection between the system and the user code. The fact that the charts are designed as such that this workspace-yaml is created and modified through the system deployment rather than the user code deployment is the reason we need to redeploy the system.</p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]"><strong>But what if we could modify this workspace-yaml file ourselves? Can we make the system redeployment obsolete? Short answer: we can.</strong></p>
<h3 class="Text-module__text-default Text-module__u-font-h3">Our solution</h3>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]"><em>Disclaimer: what we present here is a workaround that we&#x27;ll keep in place until the moment Dagster releases a version in which the Dagster user code deployment is <strong>actually completely separated</strong> from the system deployment. And it works like a charm.</em></p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]"><strong>Remember: the desired situation is that we do not have to edit the values-yaml files (through a PR) and redeploy all of Dagster for every new repo.</strong></p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">First of all, we added an extra ConfigMap in Kubernetes that contains the <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">values.yaml</code> for the <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">dagster/dagster-user-deployments</code> chart. We named it <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">dagster-user-deployments-values-yaml</code>. The fact that this is a ConfigMap is crucial to prevent conflicts (see next section).</p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">With the extra ConfigMap in place, these are the steps when a repo gets added:</p>
<ol style="margin-block-start:0;margin-block-end:30px">
<li class="Text-module__text-default Text-module__u-font-body" style="margin-bottom:0">Add the new repo to the <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">dagster-user-deployments-values-yaml</code> Configmap.</li>
<li class="Text-module__text-default Text-module__u-font-body" style="margin-bottom:0">Helm-upgrade the <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">dagster/dagster-user-deployments</code> chart with the content of that ConfigMap.</li>
<li class="Text-module__text-default Text-module__u-font-body" style="margin-bottom:0">Add the server to the <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">dagster-workspace-yaml</code> ConfigMap.</li>
<li class="Text-module__text-default Text-module__u-font-body" style="margin-bottom:0">Do a rolling restart of the <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">dagster-dagit</code> and <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">dagster-daemon</code> deployment to pull the latest workspace to these services.</li>
</ol>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]"><strong>Refresh the workspace in the UI and there it is, your new repo!</strong></p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">Notes:</p>
<ol style="margin-block-start:0;margin-block-end:30px">
<li class="Text-module__text-default Text-module__u-font-body" style="margin-bottom:0">The steps above are completely automatable through your favorite CI/CD pipeline automation tool.</li>
<li class="Text-module__text-default Text-module__u-font-body" style="margin-bottom:0">There is no interaction with a (platform team) Git repo.</li>
<li class="Text-module__text-default Text-module__u-font-body" style="margin-bottom:0">The process, unfortunately, still requires a restart of the system in order to pull the latest workspace-yaml to the system services. The daemon terminates, then restarts, and it might cause a short interruption. Note that this is unavoidable if you add a new repo, no matter how you add it. This could be avoided if a reload of the ConfigMap would be triggered upon a change, <a href="https://kubernetes.io/docs/concepts/configuration/configmap/#mounted-configmaps-are-updated-automatically" node="[object Object]" style="color:inherit">which is possible</a> but not enabled.</li>
<li class="Text-module__text-default Text-module__u-font-body" style="margin-bottom:0">If you want to make changes to an existing repo (not code changes but server setting changes), you only have to do the first step (and <em>modify</em> instead of <em>add</em>).</li>
</ol>
<h4 class="Text-module__text-default Text-module__u-font-h4">How to prevent conflicts</h4>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">With many of your team members adding new Dagster repositories through an automated CI/CD pipeline, you might face the situation that 2 people are adding a new repo at around the same time.</p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">When this happens, the <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">dagster-user-deployments-values-yaml</code> ConfigMap cannot be uploaded in the first step because Kubernetes demands that you provide the <em>last-applied-configuration</em> when doing an update. If it doesn&#x27;t match, the upload fails.</p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">This is perfect as we do not want to overwrite the changes of the conflicting flow. You can optionally build in a retry-mechanism that starts over with pulling the ConfigMap again.</p>
<h4 class="Text-module__text-default Text-module__u-font-h4">How to deploy from scratch</h4>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">The above does not yet cover how we are able to deploy the Dagster system <em>and user code</em> completely from scratch. Why do we want this? Well, for instance when somebody accidently deletes the <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">dagster</code> namespace for instance. Or hell breaks loose in any other physical or non-physical form. Or when we simply want to bump the Dagster version, actually.</p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">The key to this is that we version both the <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">dagster-user-deployments-values-yaml</code> and <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">dagster-workspace-yaml</code> as a final step to the flow described above (we do it on S3, in a versioned bucket). Whenever we redeploy Dagster (with Ansible) we pull the latest versions and use them to compile both the values-yaml files from it.</p>
<h4 class="Text-module__text-default Text-module__u-font-h4">How to clean up old repositories</h4>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">The above described automation <em>adds</em> new repos but doesn&#x27;t take care of old obsolete repos. The steps for removing a repo are the same for adding one. The exact implementation depends on your situation. You might want to automatically remove PR staging environments after closing a PR, for instance.</p>
<h3 class="Text-module__text-default Text-module__u-font-h3">Conclusion</h3>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">Dagster is an incredibly powerful tool that enabled us to build complex data pipelines with ease. This posts explains how we <strong>streamlined the CI/CD pipeline for user code respositories</strong>, which enabled us to migrate to Dagster very quickly and saves us lots of time on a daily basis.</p></div></div></div><footer style="padding-top:30px;padding-bottom:30px;background-color:#363639"><div class="Container-module__container"><div class="Row-module__row Row-module__align-items-center" style="margin-bottom:15px"><div class="Col-module__col-box-sizing Col-module__col"><div><div style="cursor:pointer;user-select:none;display:flex;align-items:baseline"><svg width="140" viewBox="0 0 140 22" xmlns="http://www.w3.org/2000/svg"><path d="M9.569 21.109h-4.25L0 6.274h4.597l2.86 9.249 2.86-9.249h4.598L9.57 21.11m13.234-4.258a3.159 3.159 0 0 1 0-6.316 3.156 3.156 0 0 1 3.144 2.884v.543a3.157 3.157 0 0 1-3.144 2.889m3.2-9.81a7.38 7.38 0 1 0 0 13.3c.136.425.537.73 1.003.73h3.174V6.313h-3.174c-.466 0-.867.304-1.003.728m64.522 3.567a3.155 3.155 0 0 0-3.141 2.888v.542a3.155 3.155 0 0 0 3.14 2.885 3.16 3.16 0 0 0 3.165-3.157 3.163 3.163 0 0 0-3.164-3.158m0 10.536a7.337 7.337 0 0 1-3.195-.727 1.056 1.056 0 0 1-1.006.727h-3.171V0h4.23v7.09a7.377 7.377 0 0 1 10.522 6.676c.001 4.074-3.298 7.378-7.38 7.378m26.406-4.22a3.155 3.155 0 0 1-3.141-2.886v-.542a3.155 3.155 0 0 1 3.141-2.888 3.163 3.163 0 0 1 3.164 3.159 3.161 3.161 0 0 1-3.164 3.156m.012-10.511c-5.054 0-7.481 3.978-7.481 7.356v.025c0 3.402 2.427 7.38 7.48 7.38 5.054 0 7.48-3.978 7.48-7.38 0-3.403-2.426-7.381-7.48-7.381m-60.448 4.196a3.155 3.155 0 0 1 3.141 2.888v.542a3.156 3.156 0 0 1-3.141 2.885 3.16 3.16 0 0 1-3.165-3.157 3.163 3.163 0 0 1 3.165-3.158m0 10.536a7.377 7.377 0 0 1-7.381-7.378A7.377 7.377 0 0 1 59.635 7.09V0h4.23v21.144h-3.17c-.473 0-.866-.303-1.006-.727a7.342 7.342 0 0 1-3.195.727zm51.349-14.856v4.222a3.074 3.074 0 0 0-.244-.013c-1.64 0-3.138 1.057-3.138 2.585v8.025h-4.234V6.276h3.17c.473 0 .867.303 1.006.727a7.353 7.353 0 0 1 3.196-.727c.082 0 .162.01.244.012zm25.525 4.21c-1.467 0-2.348.886-2.348 2.584v8.09h-4.285V6.277h3.172c.472 0 .865.304 1.005.727a7.347 7.347 0 0 1 3.195-.727s1.239-.059 2.514.343c3.027.904 3.379 3.962 3.379 5.599v8.955h-4.284v-8.091c0-.883-.205-2.585-2.348-2.585zm-93.333 0c-1.467 0-2.348.886-2.348 2.584v8.09h-4.284V6.277h3.17c.474 0 .866.304 1.006.727a7.354 7.354 0 0 1 3.196-.727s1.239-.059 2.514.343c3.028.904 3.378 3.962 3.378 5.599v8.955h-4.284v-8.091c0-.883-.204-2.585-2.348-2.585zm36.24 1.755h-5.453c-.116-.003-.55-.055-.325-.637a3.336 3.336 0 0 1 6.134.093c.147.495-.246.541-.356.544m2.55-3.796c-1.308-1.384-3.145-2.214-5.284-2.214-4.254 0-7.324 3.598-7.324 7.5 0 4.15 3.398 7.398 7.399 7.398a6.789 6.789 0 0 0 3.976-1.258c1.183-.806 2.165-2.013 2.844-3.574h-4.278c-.503.73-1.208 1.31-2.542 1.31-1.635 0-3.045-.983-3.22-2.468h10.393c.327-2.566-.202-4.806-1.964-6.694" fill="#ffffff" fill-rule="evenodd"></path></svg> <span class="Text-module__text-default Text-module__u-font-h3 Text-module__u-font-color-green" style="font-size:28px;margin:0;line-height:auto">.tech</span></div></div></div></div><div class="Row-module__row Row-module__align-items-center"><div class="Col-module__col-box-sizing Col-module__col"><span class="Text-module__text-default" style="color:white">© Vandebron</span></div></div></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"content":"\n### TL;DR\nIf you want to deploy new Dagster user code respositories, you need to modify and redeploy the whole Dagster system (while they are [presented as separate](https://docs.dagster.io/deployment/guides/kubernetes/customizing-your-deployment#separately-deploying-dagster-infrastructure-and-user-code) in the docs). This is undesirable for many reasons, most notably because it slows down a migration or the regular development process. This post presents a way to avoid this and build a fully automated CI/CD-pipeline for (new) user code.\n\nThis article assumes that:\n* you (plan to) host Dagster on Kubernetes and manage its deployment with Helm and Ansible;\n* you want to automate the deployment of new Dagster user code repositories with a CI/CD pipeline automation tool of choice;\n* and you want to be able to (re)deploy the whole Dagster system and user code from scratch.\n\n### Why Dagster?\n\nIn short Dagster is a tool to build and orchestrate complex data applications in Python. For us, in the end, Dagster improved the development cycle for things like simple cron jobs as well as for complex ML pipelines. Testing the flows locally was never so easy, for instance. And with features like [asset materialization](https://docs.dagster.io/concepts/assets/asset-materializations) and [sensors](https://docs.dagster.io/concepts/partitions-schedules-sensors/sensors), we can trigger downstream jobs based on the change of an external state that an upstream job caused, without these jobs having to know of each other's existence.\n\nHowever, deployment of new [user code respositories](https://docs.dagster.io/concepts/repositories-workspaces/repositories) caused us some CI/CD related headaches...\n\n### System and user code are separated\n\nDagster separates the system deployment - the Dagit (UI) web server and the daemons that coordinate the runs - from the user code deployment - the actual data pipeline. In other words: the user code servers run in complete isolation from the system and each other. \n\nThis is a great feature of which the advantages are obvious: user code repositories have their own Python environment, teams can manage these separately, and if a user code server breaks down the system is not impacted. In fact, it even doesn't require a restart when user code is updated!\n\n![Schematic of the Dagster architecture. The user code repositories (green) are separate from the rest of the system (yellow and blue). The right side — irrelevant for now — shows the job runs. Source: https://docs.dagster.io/deployment/overview.](/images/dagster-architecture.png)\n\nIn Helm terms: there are 2 charts, namely the _system_: `dagster/dagster` ([values.yaml](https://github.com/dagster-io/dagster/blob/master/helm/dagster/values.yaml)), and the _user code_: `dagster/dagster-user-deployments` ([values.yaml](https://github.com/dagster-io/dagster/blob/master/helm/dagster/charts/dagster-user-deployments/values.yaml)). Note that you have to set `dagster-user-deployments.enabled: true` in the `dagster/dagster` values-yaml to enable this.\n\n#### Or are they?\n\nThat having said, you might find it peculiar that in the values-yaml of the system deployment, _you need to specify the user code servers_. That looks like this:\n\n```yaml\nworkspace:\n    enabled: true\n    servers:\n      - host: \"k8s-example-user-code-1\"\n        port: 3030\n        name: \"user-code-example\"\n```\n\n**This means system and user deployments are not actually completely separated!**\n\nThis implies that, if you want to add a _new_ user code repository, not only do you need to:\n\n1. add the repo to the user code's `values.yaml` (via a PR in the Git repo of your company's platform team, probably);\n2. do a helm-upgrade of the corresponding `dagster/dagster-user-deployments` chart;\n\nbut because of the not-so-separation, you still need to:\n\n3. add the user code server to the system's `values.yaml` (via that same PR);\n4. and do a helm-upgrade of the corresponding `dagster/dagster` chart.\n\nFormally this is the process to go through. If you are fine with this, stop reading here. It's the cleanest solution anyway. But it is quite cumbersome, so...\n\nIf you are in a situation in which new repositories can get added multiple times a day - for instance because you are in the middle of a migration to Dagster, or you want a staging environment for every single PR - then read on.\n\n#### Give me more details\n\nHow it works is that [for every new repo Dagster spins up a (gRPC) server to host the user code](https://docs.dagster.io/deployment/guides/kubernetes/deploying-with-helm#user-code-deployment). The separation is clear here. But the Dagster _system_ also needs to know about these user code servers, and it does so through a workspace-yaml file. If you run Dagit locally it relies on a `workspace.yaml` file; on Kubernetes it relies on a [ConfigMap](https://kubernetes.io/docs/concepts/configuration/configmap/) - a Kubernetes object used to store non-confidential data in key-value pairs, e.g. the content of a file - which they named `dagster-workspace-yaml`.\n\nThis workspace-yaml is the connection between the system and the user code. The fact that the charts are designed as such that this workspace-yaml is created and modified through the system deployment rather than the user code deployment is the reason we need to redeploy the system. \n\n**But what if we could modify this workspace-yaml file ourselves? Can we make the system redeployment obsolete? Short answer: we can.**\n\n### Our solution\n\n_Disclaimer: what we present here is a workaround that we'll keep in place until the moment Dagster releases a version in which the Dagster user code deployment is **actually completely separated** from the system deployment. And it works like a charm._\n\n**Remember: the desired situation is that we do not have to edit the values-yaml files (through a PR) and redeploy all of Dagster for every new repo.**\n\nFirst of all, we added an extra ConfigMap in Kubernetes that contains the `values.yaml` for the `dagster/dagster-user-deployments` chart. We named it `dagster-user-deployments-values-yaml`. The fact that this is a ConfigMap is crucial to prevent conflicts (see next section).\n\nWith the extra ConfigMap in place, these are the steps when a repo gets added:\n1. Add the new repo to the `dagster-user-deployments-values-yaml` Configmap.\n2. Helm-upgrade the `dagster/dagster-user-deployments` chart with the content of that ConfigMap.\n3. Add the server to the `dagster-workspace-yaml` ConfigMap.\n4. Do a rolling restart of the `dagster-dagit` and `dagster-daemon` deployment to pull the latest workspace to these services.\n\n**Refresh the workspace in the UI and there it is, your new repo!**\n\nNotes:\n* The steps above are completely automatable through your favorite CI/CD pipeline automation tool.\n* There is no interaction with a (platform team) Git repo.\n* The process, unfortunately, still requires a restart of the system in order to pull the latest workspace-yaml to the system services. The daemon terminates, then restarts, and it might cause a short interruption. Note that this is unavoidable if you add a new repo, no matter how you add it. This could be avoided if a reload of the ConfigMap would be triggered upon a change, [which is possible](https://kubernetes.io/docs/concepts/configuration/configmap/#mounted-configmaps-are-updated-automatically) but not enabled.\n* If you want to make changes to an existing repo (not code changes but server setting changes), you only have to do the first step (and _modify_ instead of _add_).\n\n#### How to prevent conflicts\n\nWith many of your team members adding new Dagster repositories through an automated CI/CD pipeline, you might face the situation that 2 people are adding a new repo at around the same time. \n\nWhen this happens, the `dagster-user-deployments-values-yaml` ConfigMap cannot be uploaded in the first step because Kubernetes demands that you provide the _last-applied-configuration_ when doing an update. If it doesn't match, the upload fails. \n\nThis is perfect as we do not want to overwrite the changes of the conflicting flow. You can optionally build in a retry-mechanism that starts over with pulling the ConfigMap again.\n\n#### How to deploy from scratch\n\nThe above does not yet cover how we are able to deploy the Dagster system _and user code_ completely from scratch. Why do we want this? Well, for instance when somebody accidently deletes the `dagster` namespace for instance. Or hell breaks loose in any other physical or non-physical form. Or when we simply want to bump the Dagster version, actually.\n\nThe key to this is that we version both the `dagster-user-deployments-values-yaml` and `dagster-workspace-yaml` as a final step to the flow described above (we do it on S3, in a versioned bucket). Whenever we redeploy Dagster (with Ansible) we pull the latest versions and use them to compile both the values-yaml files from it. \n\n#### How to clean up old repositories\n\nThe above described automation _adds_ new repos but doesn't take care of old obsolete repos. The steps for removing a repo are the same for adding one. The exact implementation depends on your situation. You might want to automatically remove PR staging environments after closing a PR, for instance.\n\n### Conclusion\n\nDagster is an incredibly powerful tool that enabled us to build complex data pipelines with ease. This posts explains how we **streamlined the CI/CD pipeline for user code respositories**, which enabled us to migrate to Dagster very quickly and saves us lots of time on a daily basis.\n","meta":{"title":"The Why and How of Dagster User Code Deployment Automation","description":"If you frequently deploy new user code repositories in Dagster, you want to automate this process. However, this is not so straightforward as it may seem at first. This post explains what we did at Vandebron.","createdAt":"Fri Jul 08 2022 00:00:00 GMT+0000 (Coordinated Universal Time)","coverImage":"images/dagster-cicd.png","tags":"dagster, cicd, ci-cd, orchestration, data pipeline, kubernetes, migration, helm, ansible","author":"Pieter Custers","slug":"blog/cicd-dagster-user-code","formattedDate":"8 juli 2022","date":"Fri Jul 08 2022 00:00:00 GMT+0000 (Coordinated Universal Time)"}}},"__N_SSG":true},"page":"/blog/[slug]","query":{"slug":"cicd-dagster-user-code"},"buildId":"qmC5ebCx5xyYeoni_PC53","assetPrefix":"/pr-preview/pr-32","isFallback":false,"gsp":true}</script><script nomodule="" src="/pr-preview/pr-32/_next/static/chunks/polyfills-28654a8145d7603786fc.js"></script><script src="/pr-preview/pr-32/_next/static/chunks/webpack-0b9cc56c94819e8023ea.js" async=""></script><script src="/pr-preview/pr-32/_next/static/chunks/framework.87b9127d6cd191ae1c9a.js" async=""></script><script src="/pr-preview/pr-32/_next/static/chunks/3ef630e34cd10ba68f9d468ac363ff81c534e1e9.e40f9d29fe57d3935de1.js" async=""></script><script src="/pr-preview/pr-32/_next/static/chunks/main-419ac17f185f95278b96.js" async=""></script><script src="/pr-preview/pr-32/_next/static/chunks/7b9503d2.4af90216c47085b5c8e9.js" async=""></script><script src="/pr-preview/pr-32/_next/static/chunks/51307659.a83a6a4548b93404854d.js" async=""></script><script src="/pr-preview/pr-32/_next/static/chunks/226daff62b2d4bc1e9a7210a7f6000a544319a74.fbdd4d016a5c47ddc9db.js" async=""></script><script src="/pr-preview/pr-32/_next/static/chunks/pages/_app-1d36213f3e6ce80d1278.js" async=""></script><script src="/pr-preview/pr-32/_next/static/chunks/1c49f5f00355f650bee3d37484f094be037a30fa.0c099ecf2acefc71ba39.js" async=""></script><script src="/pr-preview/pr-32/_next/static/chunks/pages/blog/%5Bslug%5D-b9610da0b3e709e6b9cf.js" async=""></script><script src="/pr-preview/pr-32/_next/static/qmC5ebCx5xyYeoni_PC53/_buildManifest.js" async=""></script><script src="/pr-preview/pr-32/_next/static/qmC5ebCx5xyYeoni_PC53/_ssgManifest.js" async=""></script></body></html>