<!DOCTYPE html><html lang="en"><head><script async="" src="https://www.google-analytics.com/analytics.js"></script><link rel="stylesheet" href="https://d381m57et8llfk.cloudfront.net/20210128-6054/static/css/dc7f55cf12b36887a247.fonts.css"/><script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
                ga('create', 'UA-49472651-19', { 'storage': 'none' });
                ga('send', 'pageview');</script><script src="https://unpkg.com/react-bootstrap@next/dist/react-bootstrap.min.js"></script><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>Authenticate Snowflake via Keycloak</title><meta name="Description" content="How to use Keycloak to authenticate against Snowflake rest api"/><meta property="og:title" content="Authenticate Snowflake via Keycloak"/><meta property="og:description" content="How to use Keycloak to authenticate against Snowflake rest api"/><meta property="og:image" content="https://www.vandebron.tech/images/snowflake_keycloak.jpg"/><meta name="next-head-count" content="7"/><link rel="preload" href="/_next/static/css/8a43f0f1bd66c56acc87.css" as="style"/><link rel="stylesheet" href="/_next/static/css/8a43f0f1bd66c56acc87.css" data-n-g=""/><link rel="preload" href="/_next/static/css/03a7115a0cc178f3b917.css" as="style"/><link rel="stylesheet" href="/_next/static/css/03a7115a0cc178f3b917.css" data-n-g=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/webpack-0b9cc56c94819e8023ea.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.87b9127d6cd191ae1c9a.js" as="script"/><link rel="preload" href="/_next/static/chunks/3ef630e34cd10ba68f9d468ac363ff81c534e1e9.6d16e0db9483f9bff562.js" as="script"/><link rel="preload" href="/_next/static/chunks/main-76955d219c997b2beb08.js" as="script"/><link rel="preload" href="/_next/static/chunks/7b9503d2.4af90216c47085b5c8e9.js" as="script"/><link rel="preload" href="/_next/static/chunks/669c44de.a83a6a4548b93404854d.js" as="script"/><link rel="preload" href="/_next/static/chunks/226daff62b2d4bc1e9a7210a7f6000a544319a74.fbdd4d016a5c47ddc9db.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-90b350ab15842b1bf632.js" as="script"/><link rel="preload" href="/_next/static/chunks/1c49f5f00355f650bee3d37484f094be037a30fa.39b000c5c46310942e23.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/blog/%5Bslug%5D-f65ce8ed228a0482e88b.js" as="script"/></head><body><div id="__next"><div class="Container-module__container" as="header" style="padding-top:30px;padding-bottom:30px;margin-bottom:30px"><div class="Row-module__row Row-module__align-items-center Row-module__justify-content-between"><div class="Col-module__col-box-sizing Col-module__col Col-module__col-12 Col-module__col-md-auto Col-module__col-lg-auto Col-module__col-sm-12"><div><div style="cursor:pointer;user-select:none;display:flex;align-items:baseline"><svg width="140" viewBox="0 0 140 22" xmlns="http://www.w3.org/2000/svg"><path d="M9.569 21.109h-4.25L0 6.274h4.597l2.86 9.249 2.86-9.249h4.598L9.57 21.11m13.234-4.258a3.159 3.159 0 0 1 0-6.316 3.156 3.156 0 0 1 3.144 2.884v.543a3.157 3.157 0 0 1-3.144 2.889m3.2-9.81a7.38 7.38 0 1 0 0 13.3c.136.425.537.73 1.003.73h3.174V6.313h-3.174c-.466 0-.867.304-1.003.728m64.522 3.567a3.155 3.155 0 0 0-3.141 2.888v.542a3.155 3.155 0 0 0 3.14 2.885 3.16 3.16 0 0 0 3.165-3.157 3.163 3.163 0 0 0-3.164-3.158m0 10.536a7.337 7.337 0 0 1-3.195-.727 1.056 1.056 0 0 1-1.006.727h-3.171V0h4.23v7.09a7.377 7.377 0 0 1 10.522 6.676c.001 4.074-3.298 7.378-7.38 7.378m26.406-4.22a3.155 3.155 0 0 1-3.141-2.886v-.542a3.155 3.155 0 0 1 3.141-2.888 3.163 3.163 0 0 1 3.164 3.159 3.161 3.161 0 0 1-3.164 3.156m.012-10.511c-5.054 0-7.481 3.978-7.481 7.356v.025c0 3.402 2.427 7.38 7.48 7.38 5.054 0 7.48-3.978 7.48-7.38 0-3.403-2.426-7.381-7.48-7.381m-60.448 4.196a3.155 3.155 0 0 1 3.141 2.888v.542a3.156 3.156 0 0 1-3.141 2.885 3.16 3.16 0 0 1-3.165-3.157 3.163 3.163 0 0 1 3.165-3.158m0 10.536a7.377 7.377 0 0 1-7.381-7.378A7.377 7.377 0 0 1 59.635 7.09V0h4.23v21.144h-3.17c-.473 0-.866-.303-1.006-.727a7.342 7.342 0 0 1-3.195.727zm51.349-14.856v4.222a3.074 3.074 0 0 0-.244-.013c-1.64 0-3.138 1.057-3.138 2.585v8.025h-4.234V6.276h3.17c.473 0 .867.303 1.006.727a7.353 7.353 0 0 1 3.196-.727c.082 0 .162.01.244.012zm25.525 4.21c-1.467 0-2.348.886-2.348 2.584v8.09h-4.285V6.277h3.172c.472 0 .865.304 1.005.727a7.347 7.347 0 0 1 3.195-.727s1.239-.059 2.514.343c3.027.904 3.379 3.962 3.379 5.599v8.955h-4.284v-8.091c0-.883-.205-2.585-2.348-2.585zm-93.333 0c-1.467 0-2.348.886-2.348 2.584v8.09h-4.284V6.277h3.17c.474 0 .866.304 1.006.727a7.354 7.354 0 0 1 3.196-.727s1.239-.059 2.514.343c3.028.904 3.378 3.962 3.378 5.599v8.955h-4.284v-8.091c0-.883-.204-2.585-2.348-2.585zm36.24 1.755h-5.453c-.116-.003-.55-.055-.325-.637a3.336 3.336 0 0 1 6.134.093c.147.495-.246.541-.356.544m2.55-3.796c-1.308-1.384-3.145-2.214-5.284-2.214-4.254 0-7.324 3.598-7.324 7.5 0 4.15 3.398 7.398 7.399 7.398a6.789 6.789 0 0 0 3.976-1.258c1.183-.806 2.165-2.013 2.844-3.574h-4.278c-.503.73-1.208 1.31-2.542 1.31-1.635 0-3.045-.983-3.22-2.468h10.393c.327-2.566-.202-4.806-1.964-6.694" fill="#333D47" fill-rule="evenodd"></path></svg> <span class="Text-module__text-default Text-module__u-font-h3 Text-module__u-font-color-green" style="font-size:28px;margin:0;line-height:auto">.tech</span></div></div></div><div class="Col-module__col-box-sizing Col-module__col Col-module__col-12 Col-module__col-md-auto Col-module__col-lg-auto Col-module__col-sm-12"><div class="Flex-module__d-flex Flex-module__flex-row Flex-module__align-items-stretch Flex-module__justify-content-start Flex-module__justify-content-sm-between"><ul class="Navigation-module__navigation-wrapper" id="styled-navigation" style="margin-right:25px"><li class="Navigation-module__navigation-link-wrapper"><a class="Pressable-module__button Pressable-module__text Navigation-module__navigation-link Navigation-module__navigation-link-active" name="Home" url="/"><span>Home</span></a></li><li class="Navigation-module__navigation-link-wrapper"><a class="Pressable-module__button Pressable-module__text Navigation-module__navigation-link" name="About" url="/about"><span>About</span></a></li><li class="Navigation-module__navigation-link-wrapper"><a class="Pressable-module__button Pressable-module__text Navigation-module__navigation-link" name="vandebron.nl" url="https://vandebron.nl"><span>vandebron.nl</span></a></li><div class="Navigation-module__navigation-magic-line" style="transition:none;left:0;width:0"></div></ul><div><a class="Pressable-module__button Pressable-module__text" href="https://github.com/vandebron/" target="_blank" rel="noreferrer" style="margin-right:10px"><svg role="img" viewBox="0 0 24 24" width="1em" height="1em" class="Icon-module__icon Icon-module__u-font-color-charcoal-gray" style="font-size:150%"><title>GitHub icon</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path></svg><span class="visually-hidden">Vandebron on Github</span></a><a class="Pressable-module__button Pressable-module__text" href="https://dev.to/vandebron/" target="_blank" rel="noreferrer" style="margin-right:10px"><svg viewBox="0 0 448 512" width="1em" height="1em" class="Icon-module__icon Icon-module__u-font-color-charcoal-gray" style="font-size:150%"><path fill="currentColor" d="M120.12 208.29c-3.88-2.9-7.77-4.35-11.65-4.35H91.03v104.47h17.45c3.88 0 7.77-1.45 11.65-4.35 3.88-2.9 5.82-7.25 5.82-13.06v-69.65c-.01-5.8-1.96-10.16-5.83-13.06zM404.1 32H43.9C19.7 32 .06 51.59 0 75.8v360.4C.06 460.41 19.7 480 43.9 480h360.2c24.21 0 43.84-19.59 43.9-43.8V75.8c-.06-24.21-19.7-43.8-43.9-43.8zM154.2 291.19c0 18.81-11.61 47.31-48.36 47.25h-46.4V172.98h47.38c35.44 0 47.36 28.46 47.37 47.28l.01 70.93zm100.68-88.66H201.6v38.42h32.57v29.57H201.6v38.41h53.29v29.57h-62.18c-11.16.29-20.44-8.53-20.72-19.69V193.7c-.27-11.15 8.56-20.41 19.71-20.69h63.19l-.01 29.52zm103.64 115.29c-13.2 30.75-36.85 24.63-47.44 0l-38.53-144.8h32.57l29.71 113.72 29.57-113.72h32.58l-38.46 144.8z"></path></svg><span class="visually-hidden">Vandebron on Dev.to</span></a><a class="Pressable-module__button Pressable-module__text" href="https://medium.com/vandebron/" target="_blank" rel="noreferrer"><svg viewBox="0 0 448 512" width="1em" height="1em" class="Icon-module__icon Icon-module__u-font-color-charcoal-gray" style="font-size:150%"><path fill="currentColor" d="M0 32v448h448V32H0zm372.2 106.1l-24 23c-2.1 1.6-3.1 4.2-2.7 6.7v169.3c-.4 2.6.6 5.2 2.7 6.7l23.5 23v5.1h-118V367l24.3-23.6c2.4-2.4 2.4-3.1 2.4-6.7V199.8l-67.6 171.6h-9.1L125 199.8v115c-.7 4.8 1 9.7 4.4 13.2l31.6 38.3v5.1H71.2v-5.1l31.6-38.3c3.4-3.5 4.9-8.4 4.1-13.2v-133c.4-3.7-1-7.3-3.8-9.8L75 138.1V133h87.3l67.4 148L289 133.1h83.2v5z"></path></svg><span class="visually-hidden">Vandebron on Medium</span></a></div></div></div></div></div><div class="Container-module__container"><div class="Row-module__row"><div class="Col-module__col-box-sizing Col-module__col Col-module__col-12"><h2 class="Text-module__text-default Text-module__u-font-h2">Authenticate Snowflake via Keycloak</h2></div><div class="Col-module__col-box-sizing Col-module__col Col-module__col-12"><p class="Text-module__text-default Text-module__u-font-body"><span class="Text-module__text-default">By Rosario Renga on 19 december 2023</span></p></div></div><div class="Row-module__row"><div class="Col-module__col-box-sizing Col-module__col Col-module__col-12"><p class="Text-module__text-default Text-module__u-font-body"><div class="Image-module__image-container" style="padding-bottom:50%"><div style="height:200px" class="lazyload-placeholder"></div></div></p></div></div><div class="Row-module__row" style="margin-bottom:60px"><div class="Col-module__col-box-sizing Col-module__col Col-module__col-12"><h1 class="Text-module__text-default Text-module__u-font-h1">Authenticate Snowflake rest api via Keycloak</h1>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">Here in Vandebron  we use Keycloak as our identity and access management (IAM) solution and Snowflake as our data warehousing platform.
Keycloak is a powerful and extensible solution for managing user identities and access control, making it a popular choice for organizations seeking a comprehensive and open-source IAM platform.
Snowflake is designed to handle and analyze large volumes of data with speed and efficiency. It is known for its scalability, flexibility, and ease of use in managing and analyzing diverse and massive datasets.</p>
<h2 class="Text-module__text-default Text-module__u-font-h2">Accessing Snowflake data via Rest API</h2>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">There are several ways to access data in Snowflake one of these are the Snowflake rest api, they are a comprehensive set of REST APIs for managing and interacting with various aspects of the Snowflake Data Cloud, including account management, data loading, querying, and more.
These REST APIs allow developers to programmatically perform tasks such as executing SQL queries, managing virtual warehouses, and administering user roles. They are designed to enable automation and integration with other applications and services.</p>
<h2 class="Text-module__text-default Text-module__u-font-h2">Why via Rest Api?</h2>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">The Snowflake SQL API is a REST API that you can use to access and update data in a Snowflake database. You can use this API to develop custom applications and integrations that can perform most of the queries you need. More info here: <a href="https://docs.snowflake.com/en/developer-guide/sql-api/index" node="[object Object]" style="color:inherit" target="_blank">Snowflake rest api</a></p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">We decided to connect our microservices to snowflake via rest api mainly because we consider this mechanism the best way to decouple database processing with backend processing in fact the queries issued via the endpoint are processed inside Snowflake ecosystem asynchronously.</p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">The service can poll snowflake to monitor the request until it is completed. See <a href="https://docs.snowflake.com/en/developer-guide/sql-api/handling-responses" node="[object Object]" style="color:inherit" target="_blank">Sql api response</a> .</p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">Using api communication has other very good benefits:</p>
<ol style="margin-block-start:0;margin-block-end:30px">
<li class="Text-module__text-default Text-module__u-font-body" style="margin-bottom:0">No additional library dependency</li>
<li class="Text-module__text-default Text-module__u-font-body" style="margin-bottom:0">No Additional spark connectors</li>
<li class="Text-module__text-default Text-module__u-font-body" style="margin-bottom:0">Since there is no way to run snowflake on a local machine unit test a snowflake connection would have been very hard ( impossible ). With Rest api communication we can unit test snowflake api client using contract test. ( one way contract test is better than nothing )</li>
</ol>
<h2 class="Text-module__text-default Text-module__u-font-h2">Snowflake Authentication</h2>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">Snowflake provides a convenient way to authenticate to it using “any” OAuth authentication server. Our authentication server is Keycloak so in the following sections you will learn how to integrate Keycloak with Snowflake.
Resources to this topic can be found here <a href="https://docs.snowflake.com/en/user-guide/oauth-ext-overview" node="[object Object]" style="color:inherit" target="_blank">auth-ext-overview </a>  and here: <a href="https://docs.snowflake.com/en/user-guide/oauth-ext-custom" node="[object Object]" style="color:inherit" target="_blank">oauth-ext-custom</a></p>
<h2 class="Text-module__text-default Text-module__u-font-h2">Keycloak side</h2>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">You need to configure your client to return in the JWT access token the following claims:</p>
<pre><div style="color:#f8f8f2;background:#272822;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-json" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">{
    &quot;aud&quot;: &quot;&lt;audience_url&gt;&quot;,
    &quot;iat&quot;: 1576705500,
    &quot;exp&quot;: 1576709100,
    &quot;iss&quot;: &quot;&lt;issuer_url&gt;&quot;,
    &quot;scope&quot;: [
        &quot;session:role-any&quot;
    ]
}</code></div></pre>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">most of them are returned by default. Aud claims is the only one you should add
To add <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">aud</code> claim you can add a new mapper to your client with type Audience see image:</p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]"><img src="../images/keycloak_aud.png" alt="keycloak_aud.png" style="width:100%" title="Keycloak aud mapper" node="[object Object]"/></p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]"><strong>Note</strong>: You need to add a custom audience with the value <strong>equal</strong> to the login_name attribute value in snowflake. The audience value will be used to look up to the right user in snowflake integration</p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">Then you need to add the snowflake scope to your scope list: session:role-any
Finally you can check that your token is correct:</p>
<pre><div style="color:#f8f8f2;background:#272822;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-json" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">{
    .....
    &quot;iss&quot;: &quot;https://test.vdbinfra.nl/auth/realms/vandebron&quot;,
    &quot;scope&quot;: &quot;session:role-any&quot;,
    &quot;aud&quot;: &quot;energy-trading-test&quot;,
    ....
}</code></div></pre>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">The <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">aud</code> must contain only the snowflake login_name. For instance, a token such as the following will not work (multiple audiences):&quot;aud&quot;: [     &quot;batterypack-services-test&quot;,     &quot;account&quot;   ],</p>
<h2 class="Text-module__text-default Text-module__u-font-h2">Snowflake side</h2>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">How to find keycloak public key: <a href="https://stackoverflow.com/a/57457227" node="[object Object]" style="color:inherit" target="_blank">stackoverflow</a>
Required: <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">ACCOUNTADMIN</code> rights in Snowflake.
Example integration command:</p>
<pre><div style="color:#f8f8f2;background:#272822;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-sql" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">create or replace security integration external_oauth_keycloak_test
type = external_oauth
enabled = true
external_oauth_type = custom
external_oauth_issuer = &#x27;https://test.vdbinfra.nl/auth/realms/vandebron&#x27;
external_oauth_rsa_public_key = &#x27;&lt;public_key&gt;&#x27;
external_oauth_audience_list = (&#x27;energy-trading-test&#x27;)
external_oauth_scope_mapping_attribute = &#x27;scope&#x27;
external_oauth_token_user_mapping_claim = &#x27;aud&#x27;
external_oauth_any_role_mode = &#x27;ENABLE&#x27;
external_oauth_scope_delimiter = &#x27; &#x27;
external_oauth_snowflake_user_mapping_attribute = &#x27;login_name&#x27;;</code></div></pre>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">Note: the external_oauth_scope_delimiter setting must be enabled separately by Snowflake support.
Next, you need to set the login name for the user you want associate with the integration:</p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]"><img src="../images/snowflake_auth_conf.png" alt="snowflake_auth_conf.png" style="width:100%" title="Snowflake auth configuration" node="[object Object]"/></p>
<h3 class="Text-module__text-default Text-module__u-font-h3">Example</h3>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">Let’s authenticate with keycloak as we do normally:</p>
<pre><div style="color:#f8f8f2;background:#272822;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-curl" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">curl --location --request POST &#x27;https://keycloak.test-backend.vdbinfra.nl/auth/realms/vandebron/protocol/openid-connect/token/&#x27; \
--header &#x27;Content-Type: application/x-www-form-urlencoded&#x27; \
--data-urlencode &#x27;grant_type=client_credentials&#x27; \
--data-urlencode &#x27;client_id=energy-trading&#x27; \
--data-urlencode &#x27;client_secret=&lt;secret&gt;&#x27;</code></div></pre>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">Now you should get the token. Optional: van verify the token directly in snowflake with SQL:</p>
<pre><div style="color:#f8f8f2;background:#272822;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-sql" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">SELECT SYSTEM$VERIFY_EXTERNAL_OAUTH_TOKEN( &#x27;&lt;token&gt;&#x27; )</code></div></pre>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">Use it in the snowflake statement endpoint. For example:</p>
<pre><div style="color:#f8f8f2;background:#272822;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-curl" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">curl --location --request POST &#x27;https://&lt;my_snowflake_identifier&gt;.eu-central-1.snowflakecomputing.com/api/v2/statements?async=true&#x27; \
--header &#x27;Authorization: Bearer &lt;yourtoken&gt; \
--header &#x27;Content-Type: application/json&#x27; \
--data-raw &#x27;{
&quot;statement&quot;: &quot;select \&quot;data\&quot; as prediction, to_number(\&quot;lats\&quot;, 10, 4) as lats, to_number(\&quot;lons\&quot;, 10, 4) as lons, \&quot;scaledValueOfFirstFixedSurface\&quot; as scaled_value_of_first_fixed_surface, to_timestamp_tz( concat(\&quot;dataDate\&quot;, lpad(\&quot;dataTime\&quot;, 4, 0)) || &#x27;\&#x27;&#x27;+0&#x27;\&#x27;&#x27;, &#x27;\&#x27;&#x27;yyyymmddhh24mi+tzh&#x27;\&#x27;&#x27;) as model_datetime, to_timestamp_tz( concat(\&quot;validityDate\&quot;, lpad(\&quot;validityTime\&quot;, 4, 0)) || &#x27;\&#x27;&#x27;+0&#x27;\&#x27;&#x27;, &#x27;\&#x27;&#x27;yyyymmddhh24mi+tzh&#x27;\&#x27;&#x27;) as predicted_datetime, insert_date_snowflake, current_timestamp()::timestamp_tz(9) as insert_date_staging from raw.icon_eu.alhfl_s;&quot;
}&#x27;</code></div></pre>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">NB: It is important to use the proper snowflake base url. In my case I am using https://&lt;my_snowflake_identifier&gt;.eu-central-1.snowflakecomputing.com/ where &lt;my_snowflake_identifier&gt; is my account identifier which was authorised during configuration phase the snowflake user the token is referring to in the clientId claim.
You should get a response such as:</p>
<pre><div style="color:#f8f8f2;background:#272822;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-json" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">{
    &quot;code&quot;: &quot;333334&quot;,
    &quot;message&quot;: &quot;Asynchronous execution in progress. Use provided query id to perform query monitoring and management.&quot;,
    &quot;statementHandle&quot;: &quot;01aafc80-3201-abed-0001-4a0e00e52816&quot;,
    &quot;statementStatusUrl&quot;: &quot;/api/v2/statements/01aafc80-3201-abed-0001-4a0e00e52816&quot;
}</code></div></pre>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">Now you can follow the async operation to the following get endpoint:</p>
<pre><div style="color:#f8f8f2;background:#272822;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-http" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">https://&lt;my_snowflake_identifier&gt;.eu-central-1.snowflakecomputing.com/api/v2/statements/01aafc80-3201-abed-0001-4a0e00e52816</code></div></pre>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">It will return 202 if the processing is still ongoing. It will return 200 and the actual result when processing ends.</p>
<p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">Happy coding!</p></div></div></div><footer style="padding-top:30px;padding-bottom:30px;background-color:#363639"><div class="Container-module__container"><div class="Row-module__row Row-module__align-items-center" style="margin-bottom:15px"><div class="Col-module__col-box-sizing Col-module__col"><div><div style="cursor:pointer;user-select:none;display:flex;align-items:baseline"><svg width="140" viewBox="0 0 140 22" xmlns="http://www.w3.org/2000/svg"><path d="M9.569 21.109h-4.25L0 6.274h4.597l2.86 9.249 2.86-9.249h4.598L9.57 21.11m13.234-4.258a3.159 3.159 0 0 1 0-6.316 3.156 3.156 0 0 1 3.144 2.884v.543a3.157 3.157 0 0 1-3.144 2.889m3.2-9.81a7.38 7.38 0 1 0 0 13.3c.136.425.537.73 1.003.73h3.174V6.313h-3.174c-.466 0-.867.304-1.003.728m64.522 3.567a3.155 3.155 0 0 0-3.141 2.888v.542a3.155 3.155 0 0 0 3.14 2.885 3.16 3.16 0 0 0 3.165-3.157 3.163 3.163 0 0 0-3.164-3.158m0 10.536a7.337 7.337 0 0 1-3.195-.727 1.056 1.056 0 0 1-1.006.727h-3.171V0h4.23v7.09a7.377 7.377 0 0 1 10.522 6.676c.001 4.074-3.298 7.378-7.38 7.378m26.406-4.22a3.155 3.155 0 0 1-3.141-2.886v-.542a3.155 3.155 0 0 1 3.141-2.888 3.163 3.163 0 0 1 3.164 3.159 3.161 3.161 0 0 1-3.164 3.156m.012-10.511c-5.054 0-7.481 3.978-7.481 7.356v.025c0 3.402 2.427 7.38 7.48 7.38 5.054 0 7.48-3.978 7.48-7.38 0-3.403-2.426-7.381-7.48-7.381m-60.448 4.196a3.155 3.155 0 0 1 3.141 2.888v.542a3.156 3.156 0 0 1-3.141 2.885 3.16 3.16 0 0 1-3.165-3.157 3.163 3.163 0 0 1 3.165-3.158m0 10.536a7.377 7.377 0 0 1-7.381-7.378A7.377 7.377 0 0 1 59.635 7.09V0h4.23v21.144h-3.17c-.473 0-.866-.303-1.006-.727a7.342 7.342 0 0 1-3.195.727zm51.349-14.856v4.222a3.074 3.074 0 0 0-.244-.013c-1.64 0-3.138 1.057-3.138 2.585v8.025h-4.234V6.276h3.17c.473 0 .867.303 1.006.727a7.353 7.353 0 0 1 3.196-.727c.082 0 .162.01.244.012zm25.525 4.21c-1.467 0-2.348.886-2.348 2.584v8.09h-4.285V6.277h3.172c.472 0 .865.304 1.005.727a7.347 7.347 0 0 1 3.195-.727s1.239-.059 2.514.343c3.027.904 3.379 3.962 3.379 5.599v8.955h-4.284v-8.091c0-.883-.205-2.585-2.348-2.585zm-93.333 0c-1.467 0-2.348.886-2.348 2.584v8.09h-4.284V6.277h3.17c.474 0 .866.304 1.006.727a7.354 7.354 0 0 1 3.196-.727s1.239-.059 2.514.343c3.028.904 3.378 3.962 3.378 5.599v8.955h-4.284v-8.091c0-.883-.204-2.585-2.348-2.585zm36.24 1.755h-5.453c-.116-.003-.55-.055-.325-.637a3.336 3.336 0 0 1 6.134.093c.147.495-.246.541-.356.544m2.55-3.796c-1.308-1.384-3.145-2.214-5.284-2.214-4.254 0-7.324 3.598-7.324 7.5 0 4.15 3.398 7.398 7.399 7.398a6.789 6.789 0 0 0 3.976-1.258c1.183-.806 2.165-2.013 2.844-3.574h-4.278c-.503.73-1.208 1.31-2.542 1.31-1.635 0-3.045-.983-3.22-2.468h10.393c.327-2.566-.202-4.806-1.964-6.694" fill="#ffffff" fill-rule="evenodd"></path></svg> <span class="Text-module__text-default Text-module__u-font-h3 Text-module__u-font-color-green" style="font-size:28px;margin:0;line-height:auto">.tech</span></div></div></div></div><div class="Row-module__row Row-module__align-items-center"><div class="Col-module__col-box-sizing Col-module__col"><span class="Text-module__text-default" style="color:white">© Vandebron</span></div></div></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"content":"\n\n# Authenticate Snowflake rest api via Keycloak\n\nHere in Vandebron  we use Keycloak as our identity and access management (IAM) solution and Snowflake as our data warehousing platform. \nKeycloak is a powerful and extensible solution for managing user identities and access control, making it a popular choice for organizations seeking a comprehensive and open-source IAM platform.\nSnowflake is designed to handle and analyze large volumes of data with speed and efficiency. It is known for its scalability, flexibility, and ease of use in managing and analyzing diverse and massive datasets.\n\n## Accessing Snowflake data via Rest API\n\nThere are several ways to access data in Snowflake one of these are the Snowflake rest api, they are a comprehensive set of REST APIs for managing and interacting with various aspects of the Snowflake Data Cloud, including account management, data loading, querying, and more.\nThese REST APIs allow developers to programmatically perform tasks such as executing SQL queries, managing virtual warehouses, and administering user roles. They are designed to enable automation and integration with other applications and services.\n\n## Why via Rest Api?\n\nThe Snowflake SQL API is a REST API that you can use to access and update data in a Snowflake database. You can use this API to develop custom applications and integrations that can perform most of the queries you need. More info here: [Snowflake rest api](https://docs.snowflake.com/en/developer-guide/sql-api/index)\n\nWe decided to connect our microservices to snowflake via rest api mainly because we consider this mechanism the best way to decouple database processing with backend processing in fact the queries issued via the endpoint are processed inside Snowflake ecosystem asynchronously.\n\nThe service can poll snowflake to monitor the request until it is completed. See [Sql api response](https://docs.snowflake.com/en/developer-guide/sql-api/handling-responses) .\n\nUsing api communication has other very good benefits:\n\n- No additional library dependency\n- No Additional spark connectors\n- Since there is no way to run snowflake on a local machine unit test a snowflake connection would have been very hard ( impossible ). With Rest api communication we can unit test snowflake api client using contract test. ( one way contract test is better than nothing )\n\n## Snowflake Authentication\n\nSnowflake provides a convenient way to authenticate to it using “any” OAuth authentication server. Our authentication server is Keycloak so in the following sections you will learn how to integrate Keycloak with Snowflake.\nResources to this topic can be found here [auth-ext-overview ](https://docs.snowflake.com/en/user-guide/oauth-ext-overview)  and here: [oauth-ext-custom](https://docs.snowflake.com/en/user-guide/oauth-ext-custom)\n\n\n## Keycloak side\n\nYou need to configure your client to return in the JWT access token the following claims:\n\n```json\n{\n    \"aud\": \"\u003caudience_url\u003e\",\n    \"iat\": 1576705500,\n    \"exp\": 1576709100,\n    \"iss\": \"\u003cissuer_url\u003e\",\n    \"scope\": [\n        \"session:role-any\"\n    ]\n}\n```\n\nmost of them are returned by default. Aud claims is the only one you should add\nTo add `aud` claim you can add a new mapper to your client with type Audience see image:\n\n![keycloak_aud.png](../images/keycloak_aud.png \"Keycloak aud mapper\")\n\n**Note**: You need to add a custom audience with the value **equal** to the login_name attribute value in snowflake. The audience value will be used to look up to the right user in snowflake integration\n\nThen you need to add the snowflake scope to your scope list: session:role-any\nFinally you can check that your token is correct:\n\n```json\n{\n    .....\n    \"iss\": \"https://test.vdbinfra.nl/auth/realms/vandebron\",\n    \"scope\": \"session:role-any\",\n    \"aud\": \"energy-trading-test\",\n    ....\n}\n```\n\nThe `aud` must contain only the snowflake login_name. For instance, a token such as the following will not work (multiple audiences):\"aud\": [     \"batterypack-services-test\",     \"account\"   ],\n\n## Snowflake side\n\nHow to find keycloak public key: [stackoverflow](https://stackoverflow.com/a/57457227)\nRequired: `ACCOUNTADMIN` rights in Snowflake.\nExample integration command:\n\n```sql\ncreate or replace security integration external_oauth_keycloak_test\ntype = external_oauth\nenabled = true\nexternal_oauth_type = custom\nexternal_oauth_issuer = 'https://test.vdbinfra.nl/auth/realms/vandebron'\nexternal_oauth_rsa_public_key = '\u003cpublic_key\u003e'\nexternal_oauth_audience_list = ('energy-trading-test')\nexternal_oauth_scope_mapping_attribute = 'scope'\nexternal_oauth_token_user_mapping_claim = 'aud'\nexternal_oauth_any_role_mode = 'ENABLE'\nexternal_oauth_scope_delimiter = ' '\nexternal_oauth_snowflake_user_mapping_attribute = 'login_name';\n```\n\nNote: the external_oauth_scope_delimiter setting must be enabled separately by Snowflake support.\nNext, you need to set the login name for the user you want associate with the integration:\n\n![snowflake_auth_conf.png](../images/snowflake_auth_conf.png \"Snowflake auth configuration\")\n\n### Example\n\nLet’s authenticate with keycloak as we do normally:\n\n```curl\ncurl --location --request POST 'https://keycloak.test-backend.vdbinfra.nl/auth/realms/vandebron/protocol/openid-connect/token/' \\\n--header 'Content-Type: application/x-www-form-urlencoded' \\\n--data-urlencode 'grant_type=client_credentials' \\\n--data-urlencode 'client_id=energy-trading' \\\n--data-urlencode 'client_secret=\u003csecret\u003e'\n```\n\nNow you should get the token. Optional: van verify the token directly in snowflake with SQL:\n\n```sql\nSELECT SYSTEM$VERIFY_EXTERNAL_OAUTH_TOKEN( '\u003ctoken\u003e' )\n```\n\nUse it in the snowflake statement endpoint. For example:\n\n```curl\ncurl --location --request POST 'https://\u003cmy_snowflake_identifier\u003e.eu-central-1.snowflakecomputing.com/api/v2/statements?async=true' \\\n--header 'Authorization: Bearer \u003cyourtoken\u003e \\\n--header 'Content-Type: application/json' \\\n--data-raw '{\n\"statement\": \"select \\\"data\\\" as prediction, to_number(\\\"lats\\\", 10, 4) as lats, to_number(\\\"lons\\\", 10, 4) as lons, \\\"scaledValueOfFirstFixedSurface\\\" as scaled_value_of_first_fixed_surface, to_timestamp_tz( concat(\\\"dataDate\\\", lpad(\\\"dataTime\\\", 4, 0)) || '\\''+0'\\'', '\\''yyyymmddhh24mi+tzh'\\'') as model_datetime, to_timestamp_tz( concat(\\\"validityDate\\\", lpad(\\\"validityTime\\\", 4, 0)) || '\\''+0'\\'', '\\''yyyymmddhh24mi+tzh'\\'') as predicted_datetime, insert_date_snowflake, current_timestamp()::timestamp_tz(9) as insert_date_staging from raw.icon_eu.alhfl_s;\"\n}'\n```\n\nNB: It is important to use the proper snowflake base url. In my case I am using https://\u003cmy_snowflake_identifier\u003e.eu-central-1.snowflakecomputing.com/ where \u003cmy_snowflake_identifier\u003e is my account identifier which was authorised during configuration phase the snowflake user the token is referring to in the clientId claim.\nYou should get a response such as:\n\n```json\n{\n    \"code\": \"333334\",\n    \"message\": \"Asynchronous execution in progress. Use provided query id to perform query monitoring and management.\",\n    \"statementHandle\": \"01aafc80-3201-abed-0001-4a0e00e52816\",\n    \"statementStatusUrl\": \"/api/v2/statements/01aafc80-3201-abed-0001-4a0e00e52816\"\n}\n```\n\nNow you can follow the async operation to the following get endpoint:\n\n```http\nhttps://\u003cmy_snowflake_identifier\u003e.eu-central-1.snowflakecomputing.com/api/v2/statements/01aafc80-3201-abed-0001-4a0e00e52816\n```\n\nIt will return 202 if the processing is still ongoing. It will return 200 and the actual result when processing ends.\n\nHappy coding!","meta":{"title":"Authenticate Snowflake via Keycloak","description":"How to use Keycloak to authenticate against Snowflake rest api","createdAt":"Tue Dec 19 2023 01:00:00 GMT+0100 (Central European Standard Time)","coverImage":"images/snowflake_keycloak.jpg","tags":["keycloak","snowflake","rest","oauth","bearer token","authentication","security"],"author":"Rosario Renga","slug":"blog/authenticate-snowflake-rest-api-using-keycloak","formattedDate":"19 december 2023","date":"Tue Dec 19 2023 01:00:00 GMT+0100 (Central European Standard Time)"}}},"__N_SSG":true},"page":"/blog/[slug]","query":{"slug":"authenticate-snowflake-rest-api-using-keycloak"},"buildId":"m44tmSbxktXps8P5Gsqmz","isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-28654a8145d7603786fc.js"></script><script src="/_next/static/chunks/webpack-0b9cc56c94819e8023ea.js" async=""></script><script src="/_next/static/chunks/framework.87b9127d6cd191ae1c9a.js" async=""></script><script src="/_next/static/chunks/3ef630e34cd10ba68f9d468ac363ff81c534e1e9.6d16e0db9483f9bff562.js" async=""></script><script src="/_next/static/chunks/main-76955d219c997b2beb08.js" async=""></script><script src="/_next/static/chunks/7b9503d2.4af90216c47085b5c8e9.js" async=""></script><script src="/_next/static/chunks/669c44de.a83a6a4548b93404854d.js" async=""></script><script src="/_next/static/chunks/226daff62b2d4bc1e9a7210a7f6000a544319a74.fbdd4d016a5c47ddc9db.js" async=""></script><script src="/_next/static/chunks/pages/_app-90b350ab15842b1bf632.js" async=""></script><script src="/_next/static/chunks/1c49f5f00355f650bee3d37484f094be037a30fa.39b000c5c46310942e23.js" async=""></script><script src="/_next/static/chunks/pages/blog/%5Bslug%5D-f65ce8ed228a0482e88b.js" async=""></script><script src="/_next/static/m44tmSbxktXps8P5Gsqmz/_buildManifest.js" async=""></script><script src="/_next/static/m44tmSbxktXps8P5Gsqmz/_ssgManifest.js" async=""></script></body></html>