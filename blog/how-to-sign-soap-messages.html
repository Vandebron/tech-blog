<!DOCTYPE html><html lang="en"><head><script async="" src="https://www.google-analytics.com/analytics.js"></script><link rel="stylesheet" href="https://d381m57et8llfk.cloudfront.net/20210128-6054/static/css/dc7f55cf12b36887a247.fonts.css"/><script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
                ga('create', 'UA-49472651-19', { 'storage': 'none' });
                ga('send', 'pageview');</script><script src="https://unpkg.com/react-bootstrap@next/dist/react-bootstrap.min.js"></script><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>Signing and verifying SOAP messages with wss4j and Scala</title><meta name="Description" content="This blogpost will explain with code examples how we at Vandebron are signing and verifying SOAP messages for our latest SOAP client implementation."/><meta property="og:title" content="Signing and verifying SOAP messages with wss4j and Scala"/><meta property="og:description" content="This blogpost will explain with code examples how we at Vandebron are signing and verifying SOAP messages for our latest SOAP client implementation."/><meta property="og:image" content="https://www.vandebron.tech/images/soap.jpg"/><meta name="next-head-count" content="7"/><link rel="preload" href="/_next/static/css/a070536d6f5e4c96dd40.css" as="style"/><link rel="stylesheet" href="/_next/static/css/a070536d6f5e4c96dd40.css" data-n-g=""/><link rel="preload" href="/_next/static/css/e72318d79b9b31d4f3c8.css" as="style"/><link rel="stylesheet" href="/_next/static/css/e72318d79b9b31d4f3c8.css" data-n-g=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/webpack-6434a1d4ac4bec4a2e53.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.f924641c9c6e115c2519.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.dd82101862fb2f716b50.js" as="script"/><link rel="preload" href="/_next/static/chunks/3ef630e34cd10ba68f9d468ac363ff81c534e1e9.cd1b5d0228b256dac5ce.js" as="script"/><link rel="preload" href="/_next/static/chunks/main-e86bf2bea213786df39c.js" as="script"/><link rel="preload" href="/_next/static/chunks/7b9503d2.e0820644b08e6f6b4136.js" as="script"/><link rel="preload" href="/_next/static/chunks/38a50f2d.ddce25b62cf34b951439.js" as="script"/><link rel="preload" href="/_next/static/chunks/226daff62b2d4bc1e9a7210a7f6000a544319a74.e1e5415cfe70c17e7de3.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-ad3dcfc34f73d38371bc.js" as="script"/><link rel="preload" href="/_next/static/chunks/1c49f5f00355f650bee3d37484f094be037a30fa.ff568c3cad9cc94d4876.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/blog/%5Bslug%5D-ae31b7a8dc109a70c11f.js" as="script"/></head><body><div id="__next"><div class="Container-module__container" as="header" style="padding-top:30px;padding-bottom:30px;margin-bottom:30px"><div class="Row-module__row Row-module__align-items-center Row-module__justify-content-between"><div class="Col-module__col-box-sizing Col-module__col Col-module__col-12 Col-module__col-md-auto Col-module__col-lg-auto Col-module__col-sm-12"><div><div style="cursor:pointer;user-select:none;display:flex;align-items:baseline"><svg width="140" viewBox="0 0 140 22" xmlns="http://www.w3.org/2000/svg"><path d="M9.569 21.109h-4.25L0 6.274h4.597l2.86 9.249 2.86-9.249h4.598L9.57 21.11m13.234-4.258a3.159 3.159 0 0 1 0-6.316 3.156 3.156 0 0 1 3.144 2.884v.543a3.157 3.157 0 0 1-3.144 2.889m3.2-9.81a7.38 7.38 0 1 0 0 13.3c.136.425.537.73 1.003.73h3.174V6.313h-3.174c-.466 0-.867.304-1.003.728m64.522 3.567a3.155 3.155 0 0 0-3.141 2.888v.542a3.155 3.155 0 0 0 3.14 2.885 3.16 3.16 0 0 0 3.165-3.157 3.163 3.163 0 0 0-3.164-3.158m0 10.536a7.337 7.337 0 0 1-3.195-.727 1.056 1.056 0 0 1-1.006.727h-3.171V0h4.23v7.09a7.377 7.377 0 0 1 10.522 6.676c.001 4.074-3.298 7.378-7.38 7.378m26.406-4.22a3.155 3.155 0 0 1-3.141-2.886v-.542a3.155 3.155 0 0 1 3.141-2.888 3.163 3.163 0 0 1 3.164 3.159 3.161 3.161 0 0 1-3.164 3.156m.012-10.511c-5.054 0-7.481 3.978-7.481 7.356v.025c0 3.402 2.427 7.38 7.48 7.38 5.054 0 7.48-3.978 7.48-7.38 0-3.403-2.426-7.381-7.48-7.381m-60.448 4.196a3.155 3.155 0 0 1 3.141 2.888v.542a3.156 3.156 0 0 1-3.141 2.885 3.16 3.16 0 0 1-3.165-3.157 3.163 3.163 0 0 1 3.165-3.158m0 10.536a7.377 7.377 0 0 1-7.381-7.378A7.377 7.377 0 0 1 59.635 7.09V0h4.23v21.144h-3.17c-.473 0-.866-.303-1.006-.727a7.342 7.342 0 0 1-3.195.727zm51.349-14.856v4.222a3.074 3.074 0 0 0-.244-.013c-1.64 0-3.138 1.057-3.138 2.585v8.025h-4.234V6.276h3.17c.473 0 .867.303 1.006.727a7.353 7.353 0 0 1 3.196-.727c.082 0 .162.01.244.012zm25.525 4.21c-1.467 0-2.348.886-2.348 2.584v8.09h-4.285V6.277h3.172c.472 0 .865.304 1.005.727a7.347 7.347 0 0 1 3.195-.727s1.239-.059 2.514.343c3.027.904 3.379 3.962 3.379 5.599v8.955h-4.284v-8.091c0-.883-.205-2.585-2.348-2.585zm-93.333 0c-1.467 0-2.348.886-2.348 2.584v8.09h-4.284V6.277h3.17c.474 0 .866.304 1.006.727a7.354 7.354 0 0 1 3.196-.727s1.239-.059 2.514.343c3.028.904 3.378 3.962 3.378 5.599v8.955h-4.284v-8.091c0-.883-.204-2.585-2.348-2.585zm36.24 1.755h-5.453c-.116-.003-.55-.055-.325-.637a3.336 3.336 0 0 1 6.134.093c.147.495-.246.541-.356.544m2.55-3.796c-1.308-1.384-3.145-2.214-5.284-2.214-4.254 0-7.324 3.598-7.324 7.5 0 4.15 3.398 7.398 7.399 7.398a6.789 6.789 0 0 0 3.976-1.258c1.183-.806 2.165-2.013 2.844-3.574h-4.278c-.503.73-1.208 1.31-2.542 1.31-1.635 0-3.045-.983-3.22-2.468h10.393c.327-2.566-.202-4.806-1.964-6.694" fill="#333D47" fill-rule="evenodd"></path></svg> <span class="Text-module__text-default Text-module__u-font-h3 Text-module__u-font-color-green" style="font-size:28px;margin:0;line-height:auto">.tech</span></div></div></div><div class="Col-module__col-box-sizing Col-module__col Col-module__col-12 Col-module__col-md-auto Col-module__col-lg-auto Col-module__col-sm-12"><div class="Flex-module__d-flex Flex-module__flex-row Flex-module__align-items-stretch Flex-module__justify-content-start Flex-module__justify-content-sm-between"><ul class="Navigation-module__navigation-wrapper" id="styled-navigation" style="margin-right:25px"><li class="Navigation-module__navigation-link-wrapper"><a class="Pressable-module__button Pressable-module__text Navigation-module__navigation-link Navigation-module__navigation-link-active" name="Home" url="/"><span>Home</span></a></li><li class="Navigation-module__navigation-link-wrapper"><a class="Pressable-module__button Pressable-module__text Navigation-module__navigation-link" name="About" url="/about"><span>About</span></a></li><li class="Navigation-module__navigation-link-wrapper"><a class="Pressable-module__button Pressable-module__text Navigation-module__navigation-link" name="Main website" url="https://vandebron.nl"><span>Main<span> </span></span><span>website</span></a></li><div class="Navigation-module__navigation-magic-line" style="transition:none;left:0;width:0"></div></ul><div><a class="Pressable-module__button Pressable-module__text" href="https://github.com/vandebron/" target="_blank" rel="noreferrer" style="margin-right:10px"><svg role="img" viewBox="0 0 24 24" width="1em" height="1em" class="Icon-module__icon Icon-module__u-font-color-charcoal-gray" style="font-size:150%"><title>GitHub icon</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path></svg><span class="visually-hidden">Vandebron on Github</span></a><a class="Pressable-module__button Pressable-module__text" href="https://dev.to/vandebron/" target="_blank" rel="noreferrer" style="margin-right:10px"><svg viewBox="0 0 448 512" width="1em" height="1em" class="Icon-module__icon Icon-module__u-font-color-charcoal-gray" style="font-size:150%"><path fill="currentColor" d="M120.12 208.29c-3.88-2.9-7.77-4.35-11.65-4.35H91.03v104.47h17.45c3.88 0 7.77-1.45 11.65-4.35 3.88-2.9 5.82-7.25 5.82-13.06v-69.65c-.01-5.8-1.96-10.16-5.83-13.06zM404.1 32H43.9C19.7 32 .06 51.59 0 75.8v360.4C.06 460.41 19.7 480 43.9 480h360.2c24.21 0 43.84-19.59 43.9-43.8V75.8c-.06-24.21-19.7-43.8-43.9-43.8zM154.2 291.19c0 18.81-11.61 47.31-48.36 47.25h-46.4V172.98h47.38c35.44 0 47.36 28.46 47.37 47.28l.01 70.93zm100.68-88.66H201.6v38.42h32.57v29.57H201.6v38.41h53.29v29.57h-62.18c-11.16.29-20.44-8.53-20.72-19.69V193.7c-.27-11.15 8.56-20.41 19.71-20.69h63.19l-.01 29.52zm103.64 115.29c-13.2 30.75-36.85 24.63-47.44 0l-38.53-144.8h32.57l29.71 113.72 29.57-113.72h32.58l-38.46 144.8z"></path></svg><span class="visually-hidden">Vandebron on Dev.to</span></a><a class="Pressable-module__button Pressable-module__text" href="https://medium.com/vandebron/" target="_blank" rel="noreferrer"><svg viewBox="0 0 448 512" width="1em" height="1em" class="Icon-module__icon Icon-module__u-font-color-charcoal-gray" style="font-size:150%"><path fill="currentColor" d="M0 32v448h448V32H0zm372.2 106.1l-24 23c-2.1 1.6-3.1 4.2-2.7 6.7v169.3c-.4 2.6.6 5.2 2.7 6.7l23.5 23v5.1h-118V367l24.3-23.6c2.4-2.4 2.4-3.1 2.4-6.7V199.8l-67.6 171.6h-9.1L125 199.8v115c-.7 4.8 1 9.7 4.4 13.2l31.6 38.3v5.1H71.2v-5.1l31.6-38.3c3.4-3.5 4.9-8.4 4.1-13.2v-133c.4-3.7-1-7.3-3.8-9.8L75 138.1V133h87.3l67.4 148L289 133.1h83.2v5z"></path></svg><span class="visually-hidden">Vandebron on Medium</span></a></div></div></div></div></div><div class="Container-module__container"><div class="Row-module__row"><div class="Col-module__col-box-sizing Col-module__col Col-module__col-12"><h2 class="Text-module__text-default Text-module__u-font-h2">Signing and verifying SOAP messages with wss4j and Scala</h2></div><div class="Col-module__col-box-sizing Col-module__col Col-module__col-12"><p class="Text-module__text-default Text-module__u-font-body"><span class="Text-module__text-default">By Katrin Grunert on 28 juni 2021</span></p></div></div><div class="Row-module__row"><div class="Col-module__col-box-sizing Col-module__col Col-module__col-12"><p class="Text-module__text-default Text-module__u-font-body"><div class="Image-module__image-container" style="padding-bottom:50%"><div style="height:200px" class="lazyload-placeholder"></div></div><a class="Pressable-module__button Pressable-module__text" href="https://cdn.pixabay.com/photo/2020/03/15/18/36/wash-4934590_960_720.jpg">Image source</a></p></div></div><div class="Row-module__row" style="margin-bottom:60px"><div class="Col-module__col-box-sizing Col-module__col Col-module__col-12"><h1 class="Text-module__text-default Text-module__u-font-h1">Signing and verfiying SOAP messages with wss4j and Scala</h1><p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">SOAP is not dead. It is an established, XML-based and mature messaging protocol that comes with built-in security mechanisms, integrity checks, content validation and much more. A lot of enterprises and corporations are using it (sadly) still.
Just recently, Vandebron had to implement a SOAP client to communicate with an external party.
This blog post will explain with code examples how we at Vandebron are signing and verifying SOAP messages for our latest SOAP client implementation.</p><p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">For this process, we are using Apache&#x27;s Web Service Security Library <a href="https://ws.apache.org/wss4j/" node="[object Object]" style="color:inherit">wss4j</a> as it is a proven tool in the WSS context and provides, as a Java library, great interoperability with the programming language Scala.</p><h2 class="Text-module__text-default Text-module__u-font-h2">Signing SOAP messages</h2><p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">Here we will take a look at the necessary steps to sign a SOAP message like this one:</p><pre style="color:#f8f8f2;background:#272822;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-xml" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">&lt;soapenv:Envelope xmlns:soapenv=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;&gt;
  &lt;soapenv:Header/&gt;
  &lt;soapenv:Body&gt;
    &lt;heading&gt;Hello World&lt;/heading&gt;
    &lt;body&gt;I am just a test&lt;/body&gt;
  &lt;/soapenv:Body&gt;
&lt;/soapenv:Envelope&gt;</code></pre><br/><p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">To look after signing like this:</p><pre style="color:#f8f8f2;background:#272822;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-xml" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">&lt;soapenv:Envelope xmlns:soapenv=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;&gt;
  &lt;soapenv:Header&gt;
    &lt;wsse:Security 
    soapenv:mustUnderstand=&quot;1&quot; xmlns:wsu=&quot;http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd&quot; xmlns:wsse=&quot;http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd&quot;&gt;
      &lt;ds:Signature 
      Id=&quot;SIG-ec946953-2470-4689-ad2f-0c579e1e06e3&quot; xmlns:ds=&quot;http://www.w3.org/2000/09/xmldsig#&quot;&gt;
        &lt;ds:SignedInfo&gt;
          &lt;ds:CanonicalizationMethod Algorithm=&quot;http://www.w3.org/2001/10/xml-exc-c14n#&quot;&gt;
            &lt;ec:InclusiveNamespaces PrefixList=&quot;soapenv&quot; xmlns:ec=&quot;http://www.w3.org/2001/10/xml-exc-c14n#&quot;/&gt;
          &lt;/ds:CanonicalizationMethod&gt;
          &lt;ds:SignatureMethod Algorithm=&quot;http://www.w3.org/2001/04/xmldsig-more#rsa-sha256&quot;/&gt;
          &lt;ds:Reference URI=&quot;#id-47817454-f6e2-470c-9109-870e7895e3e0&quot;&gt;
            &lt;ds:Transforms&gt;
              &lt;ds:Transform Algorithm=&quot;http://www.w3.org/2001/10/xml-exc-c14n#&quot;/&gt;
            &lt;/ds:Transforms&gt;
            &lt;ds:DigestMethod Algorithm=&quot;http://www.w3.org/2001/04/xmlenc#sha256&quot;/&gt;
            &lt;ds:DigestValue&gt;7KfPcTwDYWtLj4ZVWmWmVqX4IGwbBAAmUPigCdXdk4U=&lt;/ds:DigestValue&gt;
          &lt;/ds:Reference&gt;
        &lt;/ds:SignedInfo&gt;
        &lt;ds:SignatureValue&gt;
          OBnbBWv8S70xDDn5uG++7cTRFa2Uz3D47oxTHuO163Y3/V7H35M1GHXbKaUDOHsgsfx3SdVmVi++ra06cpwJknzqoIQgDV9Qc0ydzfxljCqupPKBnfONDYJtihEE1jtQ0RP7OLzPVNUpgOgHqbLwJu2pRUA05ool+lxIs924OwPVPKyUryoYwWhwY1ttY4P+WY2L3ZqsH3fgoLCyjlvhDEAhsP9PCxsEzPSq3ECC55Nh7nqMoHPj2uNxonuMlPeYbrlMnwyiqEW8s3Sc+WmfiIOgekRE1AdNhpn3ARlO490nObQtXCU/TxeTfbh98TMbQRZWWyT4HuLS3fF6aeyD/Q==
        &lt;/ds:SignatureValue&gt;
        &lt;ds:KeyInfo Id=&quot;KI-e18395de-9a26-4cad-9501-7c6cf6c7c74a&quot;&gt;
          &lt;wsse:SecurityTokenReference wsu:Id=&quot;STR-daa47836-f1f9-4d71-95cc-b7bcc6051c84&quot;&gt;
            &lt;wsse:KeyIdentifier 
            ValueType=&quot;http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-x509-token-profile-1.0#X509SubjectKeyIdentifier&quot; EncodingType=&quot;http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-soap-message-security-1.0#Base64Binary&quot;&gt;
              ox4ajWTdigy9oApTYs97CuCV/4k=
            &lt;/wsse:KeyIdentifier&gt;
          &lt;/wsse:SecurityTokenReference&gt;
        &lt;/ds:KeyInfo&gt;
      &lt;/ds:Signature&gt;
    &lt;/wsse:Security&gt;
  &lt;/soapenv:Header&gt;
  &lt;soapenv:Body 
    wsu:Id=&quot;id-47817454-f6e2-470c-9109-870e7895e3e0&quot; xmlns:wsu=&quot;http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd&quot;&gt;
      &lt;heading&gt;Hello World&lt;/heading&gt;
      &lt;body&gt;I am just a test&lt;/body&gt;
  &lt;/soapenv:Body&gt;
&lt;/soapenv:Envelope&gt;</code></pre><br/><p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">For implementing the steps of the blog post you will need:</p><ul style="margin-block-start:0;margin-block-end:30px"><li class="Text-module__text-default Text-module__u-font-body" style="margin-bottom:0">a SOAP service you want to send messages to</li><li class="Text-module__text-default Text-module__u-font-body" style="margin-bottom:0">documentation of that SOAP service that describes:<ul style="margin-block-start:0;margin-block-end:30px"><li class="Text-module__text-default Text-module__u-font-body" style="margin-bottom:0">signature algorithm</li><li class="Text-module__text-default Text-module__u-font-body" style="margin-bottom:0">canonicalization method</li><li class="Text-module__text-default Text-module__u-font-body" style="margin-bottom:0">digest algorithm</li><li class="Text-module__text-default Text-module__u-font-body" style="margin-bottom:0">key identifier type</li></ul></li><li class="Text-module__text-default Text-module__u-font-body" style="margin-bottom:0">a private key with which you will sign your messages</li><li class="Text-module__text-default Text-module__u-font-body" style="margin-bottom:0">a certificate that is the counterpart of the private key</li><li class="Text-module__text-default Text-module__u-font-body" style="margin-bottom:0">(optional) a pool of trusted certificates</li></ul><p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">Our private and public key pair are available in the PKCS#12-format (.p12 file extension). Check out <a href="https://www.ssl.com/how-to/create-a-pfx-p12-certificate-file-using-openssl/" node="[object Object]" style="color:inherit">this</a> to learn more about this format and how to achieve it.
The pool of trusted certificates are in the <a href="https://www.ssl.com/guide/pem-der-crt-and-cer-x-509-encodings-and-conversions/" node="[object Object]" style="color:inherit">PKCS#7 format</a> (.p7b file extension).</p><p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">First we have to setup the necessary dependencies:</p><pre style="color:#f8f8f2;background:#272822;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-scala" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">   // in your build.sbt or project/Dependencies.scala
  // enabling signing and signature verification for SOAP messages
  lazy val webServiceSecurity = Seq(
    &quot;org.apache.wss4j&quot; % &quot;wss4j&quot;                    % &quot;2.3.1&quot; pomOnly (),
    &quot;org.apache.wss4j&quot; % &quot;wss4j-ws-security-dom&quot;    % &quot;2.3.1&quot;,
    &quot;org.apache.wss4j&quot; % &quot;wss4j-ws-security-common&quot; % &quot;2.3.1&quot;
  )

  libraryDependencies ++= webServiceSecurity</code></pre><br/><p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">Next, we continue with a scala representation of our certificate we are using for signing:</p><pre style="color:#f8f8f2;background:#272822;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-scala" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">  import org.apache.wss4j.dom.WSConstants
  
  // algorithm configuration
  object SigningCertificate {
    val CanonicalizationMethodURI: String = &quot;http://www.w3.org/2001/10/xml-exc-c14n#&quot;
    val DigestAlgorithmURI: String        = DigestMethod.SHA256
    val SignatureAlgorithmURI: String     = &quot;http://www.w3.org/2001/04/xmldsig-more#rsa-sha256&quot;
    val KeyIdentifierType: Int             = WSConstants.SKI_KEY_IDENTIFIER
  }

  case class SigningCertificate(keyStore: KeyStore, password: String) {
    require(
      keyStore.aliases().asScala.size == 1,
      s&quot;Certificate of Keystore needs to have one alias but had ${keyStore.aliases().asScala.size}&quot;
    )
    val alias: String = keyStore.aliases().nextElement()

    override def toString: String = s&quot;SigningCertificate(alias=$alias)&quot;
  }</code></pre><br/><p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">In the documentation of the SOAP service that you want to call should stand some information regarding the canonicalization method, signature algorithm, digest algorithm, and the key identifier type. Those are algorithms and information that define the signing process and we explain roughly now.</p><p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">Before signing a message it has to be canonicalized. &quot;Canonicalization is a method for generating a physical representation, the canonical form, of an XML document that accounts for syntactic changes permitted by the XML specification&quot; (from <a href="https://www.di-mgt.com.au/xmldsig-c14n.html" node="[object Object]" style="color:inherit">here</a>). In our case, the Exclusive XML Canonicalization is used.</p><p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">The digest algorithm is used to ensure the integrity of the message during the verification of a signature. The algorithm is used to calculate a hash of the signed message. It should be documented in the SOAP service documentation. Here we will use SHA256 as a hashing algorithm.</p><p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">The signature algorithm describes how the message will be signed. It can be defined in the SOAP service documentation but in the worst case you can read this algorithm from the certificate itself by using <a href="https://docs.oracle.com/en/java/javase/12/tools/keytool.html" node="[object Object]" style="color:inherit"><code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">keytool</code></a>:</p><pre style="color:#f8f8f2;background:#272822;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">$ keytool -list -v -keystore signature.p12
Enter keystore password: ...

[...] # more information about the certificates

Signature algorithm name: SHA256withRSA # thats what we are after!

[...] # more information about the certificates</code></pre><br/><p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">According to the keytool inspection we will use SHA256withRSA (http://www.w3.org/2001/04/xmldsig-more#rsa-sha256) for signing.</p><p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">Last but not least, in our signature, a <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">&lt;KeyInfo&gt;</code> element is included. This element contains information about the public key of the sender (us) and is needed for the signature verification once the message is received (read more <a href="https://www.xml.com/pub/a/2001/08/08/xmldsig.html" node="[object Object]" style="color:inherit">here</a>). Since we have our public key provided we don&#x27;t need to do much here. The <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">KeyIdentifierType</code> describes which form of key identifier is used to present the public key information.</p><p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">Having all this information about our certificate in place, we build the mechanism to load in our signing certificate. For this, we create the object <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">KeyStoreBuilder</code>.</p><pre style="color:#f8f8f2;background:#272822;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-scala" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">import java.io.{File, FileInputStream}

object KeyStoreBuilder {

  def loadSigningCertificate(signingCertificate: File, password: String): SigningCertificate = {
    val fis = new FileInputStream(signingCertificate)
    val ks: KeyStore               = KeyStore.getInstance(&quot;PKCS12&quot;)
    ks.load(fis, password.toCharArray)
    SigningCertificate(ks, password)
  } 
}</code></pre><br/><p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">Bear in mind, that you probably <strong>don&#x27;t</strong> want to version any sensitive information like private keys and passwords hard-coded or in any environment variables, so a safe mechanism for storing/fetching passwords and certificates (like <a href="https://www.hashicorp.com/products/vault" node="[object Object]" style="color:inherit">Vault</a>) should be in place.</p><p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">With the signing certificate in place, we can actually start signing a message. The next code example contains quite some Java boilerplate from wss4j that is required to make the signing mechanism work.</p><p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">To restrict the usage of Java classes to a small portion of our code we will firstly implement a conversion method <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">.toElem</code> inside of the companion object <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">SigningService</code>:</p><pre style="color:#f8f8f2;background:#272822;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-scala" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">  import java.io.StringWriter
  import javax.xml.transform.{OutputKeys, TransformerFactory}
  import javax.xml.transform.dom.DOMSource
  import javax.xml.transform.stream.StreamResult

  import org.w3c.dom.Document

  import scala.xml.Elem

  object SigningService {
    implicit class RichDocument(document: Document) {
      private val tf = TransformerFactory.newInstance()

      def toElem: Elem =
        val transformer = tf.newTransformer()
        transformer.setOutputProperty(OutputKeys.OMIT_XML_DECLARATION, &quot;yes&quot;);
        val stringWriter = new StringWriter()
        transformer.transform(new DOMSource(document), new StreamResult(stringWriter))
        scala.xml.XML.loadString(stringWriter.getBuffer.toString)
    }
  }</code></pre><br/><p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">With that, we can convert any <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">Document</code> SOAP message representation back to the <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">scala.xml</code> supported  <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">Elem</code> format.</p><pre style="color:#f8f8f2;background:#272822;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-scala" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">class SigningService(signingCertificate: SigningCertificate) {

  // importing our conversion method
  import SigningService.RichDocument

  /**
    * REQUIRED, otherwise it will throw:
    *
    * org.apache.wss4j.common.ext.WSSecurityException:
    * You must initialize the xml-security library correctly before you use it.
    * Call the static method &quot;org.apache.xml.security.Init.init();&quot;
    * to do that before you use any functionality from that library
    */
  org.apache.xml.security.Init.init()
  
  private val documentBuilderFactory = DocumentBuilderFactory.newInstance()
  private val crypto: Merlin = getCrypto

  crypto.setKeyStore(signingCertificate.keyStore)

  def signElement(elem: Elem): Elem = {
    documentBuilderFactory.setNamespaceAware(true)
    // converting Elem to Document (Scala to Java conversion)
    val doc = documentBuilderFactory.newDocumentBuilder().parse(new InputSource(new StringReader(elem.toString())))

    // WSSecHeader wraps around the document we want to sign
    val header = new WSSecHeader(doc)
    header.setMustUnderstand(true)
    header.insertSecurityHeader()

    // start building Signature, use the (wrapper) header-instance
    val builder = new WSSecSignature(header)
    builder.setUserInfo(signingCertificate.alias, signingCertificate.password)

    // setting algorithms
    builder.setSignatureAlgorithm(SigningCertificate.SignatureAlgorithmURI)
    builder.setSigCanonicalization(SigningCertificate.CanonicalizationMethodURI)
    builder.setDigestAlgo(SigningCertificate.DigestAlgorithmURI)
    builder.setKeyIdentifierType(SigningCertificate.KeyIdentifierType)
    builder.setAddInclusivePrefixes(true)

    // signing the document!
    val signedDocument = builder.build(crypto)
    // conversion back to Elem
    signedDocument.toElem
  }

  private def getCrypto: Merlin = {
    val properties = new Properties()
    properties.setProperty(&quot;org.apache.wss4j.crypto.provider&quot;, &quot;class org.apache.ws.security.components.crypto.Merlin&quot;)
    CryptoFactory.getInstance().asInstanceOf[Merlin]
  }
}</code></pre><br/><p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">Wss4j is a library that maintains an internal state during a signing process, but to avoid confusion it can be summarized as:</p><ul style="margin-block-start:0;margin-block-end:30px"><li class="Text-module__text-default Text-module__u-font-body" style="margin-bottom:0"><code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">WSSecHeader</code> wraps around the document to be signed</li><li class="Text-module__text-default Text-module__u-font-body" style="margin-bottom:0">the WSSecHeader instance <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">header</code> will be used as part of the <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">WSSecSignature</code>-Builder</li><li class="Text-module__text-default Text-module__u-font-body" style="margin-bottom:0">the WSSecSignature instance <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">builder</code> gets configured with all necessary information, which algorithms are used for signing, digesting, canonicalization, which key identifier should be included. Those settings an vary from webservice to webservice.</li></ul><p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">The actual signing of the document, which is now nested like a matryoshka doll, is happening with the help of an instance of <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">Crypto</code>. <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">Crypto</code> will contain either a keystore or a truststore or even both. It needs to be specified in the <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">crypto.properties</code> file or a runtime which class of Crypto will be used.
The most common one is <a href="https://ws.apache.org/wss4j/apidocs/org/apache/wss4j/common/crypto/Merlin.html" node="[object Object]" style="color:inherit"><code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">Merlin</code></a>.
We have decided to specify its configuration during runtime, since it is more visible than a properties file. Nevertheless, the <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">crypto.properties</code>-file needs to exist in your <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">resources</code> folder neverthless otherwise you will get a following <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">WSSecurityException</code>:</p><pre style="color:#f8f8f2;background:#272822;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-java" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">  org.apache.wss4j.common.ext.WSSecurityException: No message with ID &quot;resourceNotFound&quot; found in resource bundle &quot;org/apache/xml/security/resource/xmlsecurity&quot;
  [... rest of stacktrace ...]
  Cause: java.nio.file.NoSuchFileException: crypto.properties</code></pre><br/><p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">And that&#x27;s it! The <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">KeyStoreBuilder</code> helps us to load a <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">SigningCertificate</code> and the <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">SigningService</code> uses this loaded certificate to sign SOAP messages.
A receiver of our SOAP message has all the necessary information in our signature to verify that this message has not been tampered with and we are the original sender.</p><p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">This verification is something we should also do on our side for incoming messages. So let&#x27;s take a look at how we can verify the signature of received messages.</p><h2 class="Text-module__text-default Text-module__u-font-h2">Verification of SOAP messages</h2><p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">Verifying the signature of incoming messages is equally important to ensure that the connection is secure. A verification process will tell you if the message is coming from a trusted source and has not been tampered with.</p><p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">As previously mentioned we need our source of truth, a pool of trusted public keys from all parties which will receive our SOAP messages. These build the basis of the trust store.</p><p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">We will create a <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">TrustedCertificates</code> wrapper class in which we will load in the trust store and add this method to the <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">KeyStoreBuilder</code>.</p><pre style="color:#f8f8f2;background:#272822;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-scala" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">case class TrustedCertificates(keyStore: KeyStore)

object KeyStoreBuilder {

    def loadTrustedCertificate(certificates: Seq[File]): TrustedCertificates = {
    val ks = KeyStore.getInstance(KeyStore.getDefaultType)
    // we just want the keystore to act as a truststore (only containing trusted certificates), so we initialize it empty
    ks.load(null, null)
    val cf = CertificateFactory.getInstance(&quot;X.509&quot;)
    certificates.foreach { file =&gt;
      CloseableUtil.using(getClass.getResourceAsStream(file.getPath)) { fis =&gt;
        val certPath = cf.generateCertPath(fis, &quot;PKCS7&quot;)
        certPath.getCertificates.asScala.toList.foreach { certificate =&gt;
          ks.setCertificateEntry(file.getName, certificate)
        }
      }
    }
    TrustedCertificates(ks)
  }
}</code></pre><br/><p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">This trust store is under the hood also just a KeyStore, without containing a private key that requires a password, that&#x27;s why we can initialize the KeyStore with <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">null</code>-parameters.</p><p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">Now, the SigningService needs to be extended with this trusted certificates and a <code style="background:rgb(0,0,0, 0.1);padding:2px 4px;font-size:80%;color:#000">verifySignatureOf</code>-method:</p><pre style="color:#f8f8f2;background:#272822;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-scala" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">import java.io.StringReader
import java.util.Properties
import javax.xml.parsers.DocumentBuilderFactory

import org.apache.wss4j.common.crypto.{ CryptoFactory, Merlin }
import org.apache.wss4j.dom.engine.WSSecurityEngine
import org.xml.sax.InputSource

import scala.util.{Failure, Success, Try}
import scala.xml.Elem

class SigningService(signingCertificate: SigningCertificate, trustedCertificates: TrustedCertificates) {

    private val engine = new WSSecurityEngine()
    private val documentBuilderFactory = DocumentBuilderFactory.newInstance()
    private val crypto: Merlin = getCrypto

    crypto.setKeyStore(signingCertificate.keyStore)
    crypto.setTrustStore(trustedCertificates.keyStore)

    def verifySignatureOf(elem: Elem): Boolean = {
      documentBuilderFactory.setNamespaceAware(true)
      val doc = documentBuilderFactory.newDocumentBuilder().parse(new InputSource(new StringReader(elem.toString())))

      Try(engine.processSecurityHeader(doc, null, null, crypto)) match {
        case Success(_) =&gt; true
        case Failure(exception) =&gt;
          // replace with proper logging
          println(
            s&quot;Unsuccessful signature verification, it is most likely that the certificate used for signing is not in our Truststore: ${exception.getMessage}&quot;)
          false
      }
  }

  private def getCrypto: Merlin = {
    val properties = new Properties()
    properties.setProperty(&quot;org.apache.wss4j.crypto.provider&quot;, &quot;class org.apache.ws.security.components.crypto.Merlin&quot;)
    CryptoFactory.getInstance().asInstanceOf[Merlin]
  }
}</code></pre><br/><p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">And with that, we have completed our roundtrip of signing and verifying SOAP messages!</p><p class="Text-module__text-default Text-module__u-font-body" node="[object Object]">Here are gists, articles, and documentation that inspired and helped us to figure out the signing and verification process for our SOAP client. Feel free to check them out!</p><h3 class="Text-module__text-default Text-module__u-font-h3">Sources</h3><p class="Text-module__text-default Text-module__u-font-body" node="[object Object]"><a href="https://gist.github.com/luiswolff/1d388ec8c1d63cfb58974a6f826bc1be" node="[object Object]" style="color:inherit">WSSecurityVerifier by Luis Wolff</a></p><p class="Text-module__text-default Text-module__u-font-body" node="[object Object]"><a href="https://gist.github.com/luiswolff/64d15a99fbb5ec4b4e90eec04b09e053" node="[object Object]" style="color:inherit">WSSecuritySigner by Luis Wolff</a></p><p class="Text-module__text-default Text-module__u-font-body" node="[object Object]"><a href="https://github.com/apache/ws-wss4j/blob/master/ws-security-dom/src/test/java/org/apache/wss4j/dom/message/SignatureTest.java" node="[object Object]" style="color:inherit">Unit Tests from ws-wss4j</a></p><p class="Text-module__text-default Text-module__u-font-body" node="[object Object]"><a href="https://www.xml.com/pub/a/2001/08/08/xmldsig.html" node="[object Object]" style="color:inherit">An Introduction to XML Digital Signatures</a></p><p class="Text-module__text-default Text-module__u-font-body" node="[object Object]"><a href="https://stackify.com/soap-vs-rest/" node="[object Object]" style="color:inherit">SOAP vs. REST</a></p></div></div></div><footer style="padding-top:30px;padding-bottom:30px;background-color:#363639"><div class="Container-module__container"><div class="Row-module__row Row-module__align-items-center" style="margin-bottom:15px"><div class="Col-module__col-box-sizing Col-module__col"><div><div style="cursor:pointer;user-select:none;display:flex;align-items:baseline"><svg width="140" viewBox="0 0 140 22" xmlns="http://www.w3.org/2000/svg"><path d="M9.569 21.109h-4.25L0 6.274h4.597l2.86 9.249 2.86-9.249h4.598L9.57 21.11m13.234-4.258a3.159 3.159 0 0 1 0-6.316 3.156 3.156 0 0 1 3.144 2.884v.543a3.157 3.157 0 0 1-3.144 2.889m3.2-9.81a7.38 7.38 0 1 0 0 13.3c.136.425.537.73 1.003.73h3.174V6.313h-3.174c-.466 0-.867.304-1.003.728m64.522 3.567a3.155 3.155 0 0 0-3.141 2.888v.542a3.155 3.155 0 0 0 3.14 2.885 3.16 3.16 0 0 0 3.165-3.157 3.163 3.163 0 0 0-3.164-3.158m0 10.536a7.337 7.337 0 0 1-3.195-.727 1.056 1.056 0 0 1-1.006.727h-3.171V0h4.23v7.09a7.377 7.377 0 0 1 10.522 6.676c.001 4.074-3.298 7.378-7.38 7.378m26.406-4.22a3.155 3.155 0 0 1-3.141-2.886v-.542a3.155 3.155 0 0 1 3.141-2.888 3.163 3.163 0 0 1 3.164 3.159 3.161 3.161 0 0 1-3.164 3.156m.012-10.511c-5.054 0-7.481 3.978-7.481 7.356v.025c0 3.402 2.427 7.38 7.48 7.38 5.054 0 7.48-3.978 7.48-7.38 0-3.403-2.426-7.381-7.48-7.381m-60.448 4.196a3.155 3.155 0 0 1 3.141 2.888v.542a3.156 3.156 0 0 1-3.141 2.885 3.16 3.16 0 0 1-3.165-3.157 3.163 3.163 0 0 1 3.165-3.158m0 10.536a7.377 7.377 0 0 1-7.381-7.378A7.377 7.377 0 0 1 59.635 7.09V0h4.23v21.144h-3.17c-.473 0-.866-.303-1.006-.727a7.342 7.342 0 0 1-3.195.727zm51.349-14.856v4.222a3.074 3.074 0 0 0-.244-.013c-1.64 0-3.138 1.057-3.138 2.585v8.025h-4.234V6.276h3.17c.473 0 .867.303 1.006.727a7.353 7.353 0 0 1 3.196-.727c.082 0 .162.01.244.012zm25.525 4.21c-1.467 0-2.348.886-2.348 2.584v8.09h-4.285V6.277h3.172c.472 0 .865.304 1.005.727a7.347 7.347 0 0 1 3.195-.727s1.239-.059 2.514.343c3.027.904 3.379 3.962 3.379 5.599v8.955h-4.284v-8.091c0-.883-.205-2.585-2.348-2.585zm-93.333 0c-1.467 0-2.348.886-2.348 2.584v8.09h-4.284V6.277h3.17c.474 0 .866.304 1.006.727a7.354 7.354 0 0 1 3.196-.727s1.239-.059 2.514.343c3.028.904 3.378 3.962 3.378 5.599v8.955h-4.284v-8.091c0-.883-.204-2.585-2.348-2.585zm36.24 1.755h-5.453c-.116-.003-.55-.055-.325-.637a3.336 3.336 0 0 1 6.134.093c.147.495-.246.541-.356.544m2.55-3.796c-1.308-1.384-3.145-2.214-5.284-2.214-4.254 0-7.324 3.598-7.324 7.5 0 4.15 3.398 7.398 7.399 7.398a6.789 6.789 0 0 0 3.976-1.258c1.183-.806 2.165-2.013 2.844-3.574h-4.278c-.503.73-1.208 1.31-2.542 1.31-1.635 0-3.045-.983-3.22-2.468h10.393c.327-2.566-.202-4.806-1.964-6.694" fill="#ffffff" fill-rule="evenodd"></path></svg> <span class="Text-module__text-default Text-module__u-font-h3 Text-module__u-font-color-green" style="font-size:28px;margin:0;line-height:auto">.tech</span></div></div></div></div><div class="Row-module__row Row-module__align-items-center"><div class="Col-module__col-box-sizing Col-module__col"><span class="Text-module__text-default" style="color:white">© Vandebron</span></div></div></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"content":"\n# Signing and verfiying SOAP messages with wss4j and Scala\n\nSOAP is not dead. It is an established, XML-based and mature messaging protocol that comes with built-in security mechanisms, integrity checks, content validation and much more. A lot of enterprises and corporations are using it (sadly) still.\nJust recently, Vandebron had to implement a SOAP client to communicate with an external party. \nThis blog post will explain with code examples how we at Vandebron are signing and verifying SOAP messages for our latest SOAP client implementation. \n\nFor this process, we are using Apache's Web Service Security Library [wss4j](https://ws.apache.org/wss4j/) as it is a proven tool in the WSS context and provides, as a Java library, great interoperability with the programming language Scala.\n\n## Signing SOAP messages\n\nHere we will take a look at the necessary steps to sign a SOAP message like this one:\n```xml\n\u003csoapenv:Envelope xmlns:soapenv=\"http://schemas.xmlsoap.org/soap/envelope/\"\u003e\n  \u003csoapenv:Header/\u003e\n  \u003csoapenv:Body\u003e\n    \u003cheading\u003eHello World\u003c/heading\u003e\n    \u003cbody\u003eI am just a test\u003c/body\u003e\n  \u003c/soapenv:Body\u003e\n\u003c/soapenv:Envelope\u003e\n```\nTo look after signing like this:\n```xml\n\u003csoapenv:Envelope xmlns:soapenv=\"http://schemas.xmlsoap.org/soap/envelope/\"\u003e\n  \u003csoapenv:Header\u003e\n    \u003cwsse:Security \n    soapenv:mustUnderstand=\"1\" xmlns:wsu=\"http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd\" xmlns:wsse=\"http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd\"\u003e\n      \u003cds:Signature \n      Id=\"SIG-ec946953-2470-4689-ad2f-0c579e1e06e3\" xmlns:ds=\"http://www.w3.org/2000/09/xmldsig#\"\u003e\n        \u003cds:SignedInfo\u003e\n          \u003cds:CanonicalizationMethod Algorithm=\"http://www.w3.org/2001/10/xml-exc-c14n#\"\u003e\n            \u003cec:InclusiveNamespaces PrefixList=\"soapenv\" xmlns:ec=\"http://www.w3.org/2001/10/xml-exc-c14n#\"/\u003e\n          \u003c/ds:CanonicalizationMethod\u003e\n          \u003cds:SignatureMethod Algorithm=\"http://www.w3.org/2001/04/xmldsig-more#rsa-sha256\"/\u003e\n          \u003cds:Reference URI=\"#id-47817454-f6e2-470c-9109-870e7895e3e0\"\u003e\n            \u003cds:Transforms\u003e\n              \u003cds:Transform Algorithm=\"http://www.w3.org/2001/10/xml-exc-c14n#\"/\u003e\n            \u003c/ds:Transforms\u003e\n            \u003cds:DigestMethod Algorithm=\"http://www.w3.org/2001/04/xmlenc#sha256\"/\u003e\n            \u003cds:DigestValue\u003e7KfPcTwDYWtLj4ZVWmWmVqX4IGwbBAAmUPigCdXdk4U=\u003c/ds:DigestValue\u003e\n          \u003c/ds:Reference\u003e\n        \u003c/ds:SignedInfo\u003e\n        \u003cds:SignatureValue\u003e\n          OBnbBWv8S70xDDn5uG++7cTRFa2Uz3D47oxTHuO163Y3/V7H35M1GHXbKaUDOHsgsfx3SdVmVi++ra06cpwJknzqoIQgDV9Qc0ydzfxljCqupPKBnfONDYJtihEE1jtQ0RP7OLzPVNUpgOgHqbLwJu2pRUA05ool+lxIs924OwPVPKyUryoYwWhwY1ttY4P+WY2L3ZqsH3fgoLCyjlvhDEAhsP9PCxsEzPSq3ECC55Nh7nqMoHPj2uNxonuMlPeYbrlMnwyiqEW8s3Sc+WmfiIOgekRE1AdNhpn3ARlO490nObQtXCU/TxeTfbh98TMbQRZWWyT4HuLS3fF6aeyD/Q==\n        \u003c/ds:SignatureValue\u003e\n        \u003cds:KeyInfo Id=\"KI-e18395de-9a26-4cad-9501-7c6cf6c7c74a\"\u003e\n          \u003cwsse:SecurityTokenReference wsu:Id=\"STR-daa47836-f1f9-4d71-95cc-b7bcc6051c84\"\u003e\n            \u003cwsse:KeyIdentifier \n            ValueType=\"http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-x509-token-profile-1.0#X509SubjectKeyIdentifier\" EncodingType=\"http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-soap-message-security-1.0#Base64Binary\"\u003e\n              ox4ajWTdigy9oApTYs97CuCV/4k=\n            \u003c/wsse:KeyIdentifier\u003e\n          \u003c/wsse:SecurityTokenReference\u003e\n        \u003c/ds:KeyInfo\u003e\n      \u003c/ds:Signature\u003e\n    \u003c/wsse:Security\u003e\n  \u003c/soapenv:Header\u003e\n  \u003csoapenv:Body \n    wsu:Id=\"id-47817454-f6e2-470c-9109-870e7895e3e0\" xmlns:wsu=\"http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd\"\u003e\n      \u003cheading\u003eHello World\u003c/heading\u003e\n      \u003cbody\u003eI am just a test\u003c/body\u003e\n  \u003c/soapenv:Body\u003e\n\u003c/soapenv:Envelope\u003e\n```\n\nFor implementing the steps of the blog post you will need:\n- a SOAP service you want to send messages to\n- documentation of that SOAP service that describes:\n    - signature algorithm\n    - canonicalization method\n    - digest algorithm\n    - key identifier type\n- a private key with which you will sign your messages\n- a certificate that is the counterpart of the private key\n- (optional) a pool of trusted certificates\n\nOur private and public key pair are available in the PKCS#12-format (.p12 file extension). Check out [this](https://www.ssl.com/how-to/create-a-pfx-p12-certificate-file-using-openssl/) to learn more about this format and how to achieve it.\nThe pool of trusted certificates are in the [PKCS#7 format](https://www.ssl.com/guide/pem-der-crt-and-cer-x-509-encodings-and-conversions/) (.p7b file extension).\n\nFirst we have to setup the necessary dependencies:\n\n```scala\n   // in your build.sbt or project/Dependencies.scala\n  // enabling signing and signature verification for SOAP messages\n  lazy val webServiceSecurity = Seq(\n    \"org.apache.wss4j\" % \"wss4j\"                    % \"2.3.1\" pomOnly (),\n    \"org.apache.wss4j\" % \"wss4j-ws-security-dom\"    % \"2.3.1\",\n    \"org.apache.wss4j\" % \"wss4j-ws-security-common\" % \"2.3.1\"\n  )\n\n  libraryDependencies ++= webServiceSecurity\n```\n\nNext, we continue with a scala representation of our certificate we are using for signing:\n\n```scala\n  import org.apache.wss4j.dom.WSConstants\n  \n  // algorithm configuration\n  object SigningCertificate {\n    val CanonicalizationMethodURI: String = \"http://www.w3.org/2001/10/xml-exc-c14n#\"\n    val DigestAlgorithmURI: String        = DigestMethod.SHA256\n    val SignatureAlgorithmURI: String     = \"http://www.w3.org/2001/04/xmldsig-more#rsa-sha256\"\n    val KeyIdentifierType: Int             = WSConstants.SKI_KEY_IDENTIFIER\n  }\n\n  case class SigningCertificate(keyStore: KeyStore, password: String) {\n    require(\n      keyStore.aliases().asScala.size == 1,\n      s\"Certificate of Keystore needs to have one alias but had ${keyStore.aliases().asScala.size}\"\n    )\n    val alias: String = keyStore.aliases().nextElement()\n\n    override def toString: String = s\"SigningCertificate(alias=$alias)\"\n  }\n```\nIn the documentation of the SOAP service that you want to call should stand some information regarding the canonicalization method, signature algorithm, digest algorithm, and the key identifier type. Those are algorithms and information that define the signing process and we explain roughly now.\n\nBefore signing a message it has to be canonicalized. \"Canonicalization is a method for generating a physical representation, the canonical form, of an XML document that accounts for syntactic changes permitted by the XML specification\" (from [here](https://www.di-mgt.com.au/xmldsig-c14n.html)). In our case, the Exclusive XML Canonicalization is used.\n\nThe digest algorithm is used to ensure the integrity of the message during the verification of a signature. The algorithm is used to calculate a hash of the signed message. It should be documented in the SOAP service documentation. Here we will use SHA256 as a hashing algorithm.\n\nThe signature algorithm describes how the message will be signed. It can be defined in the SOAP service documentation but in the worst case you can read this algorithm from the certificate itself by using [`keytool`](https://docs.oracle.com/en/java/javase/12/tools/keytool.html):\n```\n$ keytool -list -v -keystore signature.p12\nEnter keystore password: ...\n\n[...] # more information about the certificates\n\nSignature algorithm name: SHA256withRSA # thats what we are after!\n\n[...] # more information about the certificates\n```\nAccording to the keytool inspection we will use SHA256withRSA (http://www.w3.org/2001/04/xmldsig-more#rsa-sha256) for signing.\n\nLast but not least, in our signature, a `\u003cKeyInfo\u003e` element is included. This element contains information about the public key of the sender (us) and is needed for the signature verification once the message is received (read more [here](https://www.xml.com/pub/a/2001/08/08/xmldsig.html)). Since we have our public key provided we don't need to do much here. The `KeyIdentifierType` describes which form of key identifier is used to present the public key information.\n\nHaving all this information about our certificate in place, we build the mechanism to load in our signing certificate. For this, we create the object `KeyStoreBuilder`.\n\n```scala\nimport java.io.{File, FileInputStream}\n\nobject KeyStoreBuilder {\n\n  def loadSigningCertificate(signingCertificate: File, password: String): SigningCertificate = {\n    val fis = new FileInputStream(signingCertificate)\n    val ks: KeyStore               = KeyStore.getInstance(\"PKCS12\")\n    ks.load(fis, password.toCharArray)\n    SigningCertificate(ks, password)\n  } \n}\n```\nBear in mind, that you probably **don't** want to version any sensitive information like private keys and passwords hard-coded or in any environment variables, so a safe mechanism for storing/fetching passwords and certificates (like [Vault](https://www.hashicorp.com/products/vault)) should be in place.\n\nWith the signing certificate in place, we can actually start signing a message. The next code example contains quite some Java boilerplate from wss4j that is required to make the signing mechanism work.\n\nTo restrict the usage of Java classes to a small portion of our code we will firstly implement a conversion method `.toElem` inside of the companion object `SigningService`:\n\n```scala\n  import java.io.StringWriter\n  import javax.xml.transform.{OutputKeys, TransformerFactory}\n  import javax.xml.transform.dom.DOMSource\n  import javax.xml.transform.stream.StreamResult\n\n  import org.w3c.dom.Document\n\n  import scala.xml.Elem\n\n  object SigningService {\n    implicit class RichDocument(document: Document) {\n      private val tf = TransformerFactory.newInstance()\n\n      def toElem: Elem =\n        val transformer = tf.newTransformer()\n        transformer.setOutputProperty(OutputKeys.OMIT_XML_DECLARATION, \"yes\");\n        val stringWriter = new StringWriter()\n        transformer.transform(new DOMSource(document), new StreamResult(stringWriter))\n        scala.xml.XML.loadString(stringWriter.getBuffer.toString)\n    }\n  }\n```\nWith that, we can convert any `Document` SOAP message representation back to the `scala.xml` supported  `Elem` format.\n\n```scala\nclass SigningService(signingCertificate: SigningCertificate) {\n\n  // importing our conversion method\n  import SigningService.RichDocument\n\n  /**\n    * REQUIRED, otherwise it will throw:\n    *\n    * org.apache.wss4j.common.ext.WSSecurityException:\n    * You must initialize the xml-security library correctly before you use it.\n    * Call the static method \"org.apache.xml.security.Init.init();\"\n    * to do that before you use any functionality from that library\n    */\n  org.apache.xml.security.Init.init()\n  \n  private val documentBuilderFactory = DocumentBuilderFactory.newInstance()\n  private val crypto: Merlin = getCrypto\n\n  crypto.setKeyStore(signingCertificate.keyStore)\n\n  def signElement(elem: Elem): Elem = {\n    documentBuilderFactory.setNamespaceAware(true)\n    // converting Elem to Document (Scala to Java conversion)\n    val doc = documentBuilderFactory.newDocumentBuilder().parse(new InputSource(new StringReader(elem.toString())))\n\n    // WSSecHeader wraps around the document we want to sign\n    val header = new WSSecHeader(doc)\n    header.setMustUnderstand(true)\n    header.insertSecurityHeader()\n\n    // start building Signature, use the (wrapper) header-instance\n    val builder = new WSSecSignature(header)\n    builder.setUserInfo(signingCertificate.alias, signingCertificate.password)\n\n    // setting algorithms\n    builder.setSignatureAlgorithm(SigningCertificate.SignatureAlgorithmURI)\n    builder.setSigCanonicalization(SigningCertificate.CanonicalizationMethodURI)\n    builder.setDigestAlgo(SigningCertificate.DigestAlgorithmURI)\n    builder.setKeyIdentifierType(SigningCertificate.KeyIdentifierType)\n    builder.setAddInclusivePrefixes(true)\n\n    // signing the document!\n    val signedDocument = builder.build(crypto)\n    // conversion back to Elem\n    signedDocument.toElem\n  }\n\n  private def getCrypto: Merlin = {\n    val properties = new Properties()\n    properties.setProperty(\"org.apache.wss4j.crypto.provider\", \"class org.apache.ws.security.components.crypto.Merlin\")\n    CryptoFactory.getInstance().asInstanceOf[Merlin]\n  }\n}\n```\n\nWss4j is a library that maintains an internal state during a signing process, but to avoid confusion it can be summarized as:\n1. `WSSecHeader` wraps around the document to be signed\n2. the WSSecHeader instance `header` will be used as part of the `WSSecSignature`-Builder\n3. the WSSecSignature instance `builder` gets configured with all necessary information, which algorithms are used for signing, digesting, canonicalization, which key identifier should be included. Those settings an vary from webservice to webservice.\n\nThe actual signing of the document, which is now nested like a matryoshka doll, is happening with the help of an instance of `Crypto`. `Crypto` will contain either a keystore or a truststore or even both. It needs to be specified in the `crypto.properties` file or a runtime which class of Crypto will be used.\n The most common one is [`Merlin`](https://ws.apache.org/wss4j/apidocs/org/apache/wss4j/common/crypto/Merlin.html).\nWe have decided to specify its configuration during runtime, since it is more visible than a properties file. Nevertheless, the `crypto.properties`-file needs to exist in your `resources` folder neverthless otherwise you will get a following `WSSecurityException`:\n```java\n  org.apache.wss4j.common.ext.WSSecurityException: No message with ID \"resourceNotFound\" found in resource bundle \"org/apache/xml/security/resource/xmlsecurity\"\n  [... rest of stacktrace ...]\n  Cause: java.nio.file.NoSuchFileException: crypto.properties\n```\n\nAnd that's it! The `KeyStoreBuilder` helps us to load a `SigningCertificate` and the `SigningService` uses this loaded certificate to sign SOAP messages. \nA receiver of our SOAP message has all the necessary information in our signature to verify that this message has not been tampered with and we are the original sender.\n\nThis verification is something we should also do on our side for incoming messages. So let's take a look at how we can verify the signature of received messages.\n\n## Verification of SOAP messages\n\nVerifying the signature of incoming messages is equally important to ensure that the connection is secure. A verification process will tell you if the message is coming from a trusted source and has not been tampered with.\n\nAs previously mentioned we need our source of truth, a pool of trusted public keys from all parties which will receive our SOAP messages. These build the basis of the trust store.\n\nWe will create a `TrustedCertificates` wrapper class in which we will load in the trust store and add this method to the `KeyStoreBuilder`.\n```scala\ncase class TrustedCertificates(keyStore: KeyStore)\n\nobject KeyStoreBuilder {\n\n    def loadTrustedCertificate(certificates: Seq[File]): TrustedCertificates = {\n    val ks = KeyStore.getInstance(KeyStore.getDefaultType)\n    // we just want the keystore to act as a truststore (only containing trusted certificates), so we initialize it empty\n    ks.load(null, null)\n    val cf = CertificateFactory.getInstance(\"X.509\")\n    certificates.foreach { file =\u003e\n      CloseableUtil.using(getClass.getResourceAsStream(file.getPath)) { fis =\u003e\n        val certPath = cf.generateCertPath(fis, \"PKCS7\")\n        certPath.getCertificates.asScala.toList.foreach { certificate =\u003e\n          ks.setCertificateEntry(file.getName, certificate)\n        }\n      }\n    }\n    TrustedCertificates(ks)\n  }\n}\n```\nThis trust store is under the hood also just a KeyStore, without containing a private key that requires a password, that's why we can initialize the KeyStore with `null`-parameters.\n\nNow, the SigningService needs to be extended with this trusted certificates and a `verifySignatureOf`-method:\n\n```scala\nimport java.io.StringReader\nimport java.util.Properties\nimport javax.xml.parsers.DocumentBuilderFactory\n\nimport org.apache.wss4j.common.crypto.{ CryptoFactory, Merlin }\nimport org.apache.wss4j.dom.engine.WSSecurityEngine\nimport org.xml.sax.InputSource\n\nimport scala.util.{Failure, Success, Try}\nimport scala.xml.Elem\n\nclass SigningService(signingCertificate: SigningCertificate, trustedCertificates: TrustedCertificates) {\n\n    private val engine = new WSSecurityEngine()\n    private val documentBuilderFactory = DocumentBuilderFactory.newInstance()\n    private val crypto: Merlin = getCrypto\n\n    crypto.setKeyStore(signingCertificate.keyStore)\n    crypto.setTrustStore(trustedCertificates.keyStore)\n\n    def verifySignatureOf(elem: Elem): Boolean = {\n      documentBuilderFactory.setNamespaceAware(true)\n      val doc = documentBuilderFactory.newDocumentBuilder().parse(new InputSource(new StringReader(elem.toString())))\n\n      Try(engine.processSecurityHeader(doc, null, null, crypto)) match {\n        case Success(_) =\u003e true\n        case Failure(exception) =\u003e\n          // replace with proper logging\n          println(\n            s\"Unsuccessful signature verification, it is most likely that the certificate used for signing is not in our Truststore: ${exception.getMessage}\")\n          false\n      }\n  }\n\n  private def getCrypto: Merlin = {\n    val properties = new Properties()\n    properties.setProperty(\"org.apache.wss4j.crypto.provider\", \"class org.apache.ws.security.components.crypto.Merlin\")\n    CryptoFactory.getInstance().asInstanceOf[Merlin]\n  }\n}\n```\n\nAnd with that, we have completed our roundtrip of signing and verifying SOAP messages!\n\nHere are gists, articles, and documentation that inspired and helped us to figure out the signing and verification process for our SOAP client. Feel free to check them out!\n\n* * *\n\n### Sources\n\n[WSSecurityVerifier by Luis Wolff](https://gist.github.com/luiswolff/1d388ec8c1d63cfb58974a6f826bc1be) \n\n[WSSecuritySigner by Luis Wolff](https://gist.github.com/luiswolff/64d15a99fbb5ec4b4e90eec04b09e053)\n\n[Unit Tests from ws-wss4j](https://github.com/apache/ws-wss4j/blob/master/ws-security-dom/src/test/java/org/apache/wss4j/dom/message/SignatureTest.java)\n\n[An Introduction to XML Digital Signatures](https://www.xml.com/pub/a/2001/08/08/xmldsig.html)\n\n[SOAP vs. REST](https://stackify.com/soap-vs-rest/)","meta":{"title":"Signing and verifying SOAP messages with wss4j and Scala","description":"This blogpost will explain with code examples how we at Vandebron are signing and verifying SOAP messages for our latest SOAP client implementation.","createdAt":"Mon Jun 28 2021 02:00:00 GMT+0200 (Central European Summer Time)","coverImage":"images/soap.jpg","imageSource":"https://cdn.pixabay.com/photo/2020/03/15/18/36/wash-4934590_960_720.jpg","tags":"SOAP, xml, scala, wss4j, signature, verification","author":"Katrin Grunert","slug":"blog/how-to-sign-soap-messages","formattedDate":"28 juni 2021","date":"Mon Jun 28 2021 02:00:00 GMT+0200 (Central European Summer Time)"}}},"__N_SSG":true},"page":"/blog/[slug]","query":{"slug":"how-to-sign-soap-messages"},"buildId":"HpHpNfCidSHjj3Wv57IRe","isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-283031c735651d1762e0.js"></script><script src="/_next/static/chunks/webpack-6434a1d4ac4bec4a2e53.js" async=""></script><script src="/_next/static/chunks/framework.f924641c9c6e115c2519.js" async=""></script><script src="/_next/static/chunks/commons.dd82101862fb2f716b50.js" async=""></script><script src="/_next/static/chunks/3ef630e34cd10ba68f9d468ac363ff81c534e1e9.cd1b5d0228b256dac5ce.js" async=""></script><script src="/_next/static/chunks/main-e86bf2bea213786df39c.js" async=""></script><script src="/_next/static/chunks/7b9503d2.e0820644b08e6f6b4136.js" async=""></script><script src="/_next/static/chunks/38a50f2d.ddce25b62cf34b951439.js" async=""></script><script src="/_next/static/chunks/226daff62b2d4bc1e9a7210a7f6000a544319a74.e1e5415cfe70c17e7de3.js" async=""></script><script src="/_next/static/chunks/pages/_app-ad3dcfc34f73d38371bc.js" async=""></script><script src="/_next/static/chunks/1c49f5f00355f650bee3d37484f094be037a30fa.ff568c3cad9cc94d4876.js" async=""></script><script src="/_next/static/chunks/pages/blog/%5Bslug%5D-ae31b7a8dc109a70c11f.js" async=""></script><script src="/_next/static/HpHpNfCidSHjj3Wv57IRe/_buildManifest.js" async=""></script><script src="/_next/static/HpHpNfCidSHjj3Wv57IRe/_ssgManifest.js" async=""></script></body></html>